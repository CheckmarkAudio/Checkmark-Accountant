<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Checkmark Accountant V5</title>
  <script>
    // Apply saved/system theme ASAP to avoid light flash on dark mode
    (() => {
      try {
        const ACTIVE_KEY = 'ck5_active';
        const DATA_PREFIX = 'ck5_business_';
        const activeId = localStorage.getItem(ACTIVE_KEY);
        let theme = null;
        if (activeId) {
          const raw = localStorage.getItem(`${DATA_PREFIX}${activeId}`);
          if (raw) {
            const parsed = JSON.parse(raw);
            theme = parsed?.settings?.theme || null;
          }
        }
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const dark = theme === 'dark' || ((!theme || theme === 'system') && prefersDark);
        document.documentElement.classList.toggle('dark', dark);
        document.documentElement.style.backgroundColor = dark ? '#0d1017' : '#f5f6f8';
      } catch (e) {
        // Ignore early theme errors; main script will re-apply later
      }
    })();
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" defer></script>
  <style>
    :root {
      --bg: #f5f6f8;
      --surface: #ffffff;
      --surface-soft: #f2f3f7;
      --text: #1c1e26;
      --muted: #6b7080;
      --border: #e3e5eb;
      --accent: #3a7ff5;
      --accent-2: #111827;
      --success: #1fb37a;
      --danger: #e25555;
      --shadow: 0 2px 12px rgba(0,0,0,0.04);
      --shadow-soft: 0 1px 4px rgba(0,0,0,0.02);
      --radius: 16px;
      --motion-scale: 1;
      --logo-bg: #eef1f5;
      --spacing-xs: 4px;
      --spacing-sm: 8px;
      --spacing-md: 16px;
      --spacing-lg: 24px;
      --spacing-xl: 32px;
      --spacing-2xl: 48px;
      --topbar-height: 76px;
    }
    html.dark {
      --bg: #0d1017;
      --surface: #111624;
      --surface-soft: #161c2c;
      --text: #f5f7fb;
      --muted: #98a0b5;
      --border: #1f2737;
      --accent: #5aa3ff;
      --accent-2: #0b101a;
      --success: #3dd09c;
      --danger: #ff8b8b;
      --shadow: 0 2px 12px rgba(0,0,0,0.15);
      --shadow-soft: 0 1px 4px rgba(0,0,0,0.08);
      --logo-bg: #1a2234;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      line-height: 1.7;
      font-size: 15px;
    }
    a { color: var(--accent); text-decoration: none; }
    button {
      font: inherit;
      border: 1px solid var(--border);
      background: var(--surface-soft);
      color: var(--text);
      padding: 14px 20px;
      border-radius: 12px;
      cursor: pointer;
      transition: transform 160ms ease, box-shadow 160ms ease, opacity 140ms ease, background 150ms ease, border-color 150ms ease;
      font-weight: 500;
      line-height: 1.5;
    }
    button.primary {
      background: var(--accent);
      color: #fff;
      border: none;
      box-shadow: 0 2px 8px rgba(58,127,245,0.2);
      font-weight: 600;
    }
    button.ghost { background: transparent; }
    button:hover { 
      background: var(--border);
      border-color: var(--accent);
    }
    button.primary:hover {
      background: var(--accent);
      box-shadow: 0 4px 12px rgba(58,127,245,0.3);
    }
    button:active { transform: scale(calc(1 - 0.02 * var(--motion-scale))); }
    button.date-preset-btn {
      padding: 10px 16px;
      font-size: 0.9rem;
      background: var(--surface-soft);
      border: 1px solid var(--border);
      color: var(--text);
    }
    button.date-preset-btn.active {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }
    button.date-preset-btn:hover {
      background: var(--border);
    }
    button.date-preset-btn.active:hover {
      background: var(--accent);
    }
    .type-toggle-group {
      display: flex;
      gap: 8px;
    }
    .type-toggle-group .type-toggle {
      flex: 1;
    }
    .type-toggle-group .type-toggle.active {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }
    @media (max-width: 1100px) {
      header.topbar {
        flex-wrap: wrap;
        row-gap: 12px;
      }
      nav.tabs {
        flex-wrap: wrap;
        row-gap: 10px;
      }
      nav.tabs .top-actions {
        margin-left: 0;
        width: 100%;
        justify-content: flex-start;
      }
    }
    @media (max-width: 1024px) {
      .grid {
        gap: 20px;
      }
      .grid.cols-2 {
        grid-template-columns: 1fr;
      }
    }
    @media (max-width: 900px) {
      table {
        display: block;
        overflow-x: auto;
      }
      #invoice-rows td {
        white-space: normal;
      }
    }
    @media (max-width: 768px) {
      .grid.cols-2 { grid-template-columns: 1fr; }
      #analytics-content .card {
        padding: 20px;
      }
      #analytics-content .card canvas {
        max-height: 250px;
      }
      #analytics-content .card h3 {
        font-size: 1.1rem;
        margin-bottom: 16px;
      }
      nav.tabs {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      nav.tabs button {
        white-space: nowrap;
        flex-shrink: 0;
      }
      .date-preset-btn {
        font-size: 0.85rem;
        padding: 8px 12px;
      }
      main {
        padding: 16px;
      }
      .card {
        padding: 20px;
      }
      #analytics-content .row {
        flex-direction: column;
        align-items: stretch;
      }
      #analytics-content .row > div {
        width: 100%;
      }
      #analytics-content input[type="date"] {
        width: 100%;
        min-width: auto;
      }
    }
    @media (max-width: 480px) {
      #analytics-content .card canvas {
        max-height: 200px;
      }
      .date-preset-btn {
        font-size: 0.8rem;
        padding: 6px 10px;
      }
    }
    canvas {
      max-width: 100%;
      height: auto !important;
    }
    #analytics-content .card {
      min-height: 350px;
      display: flex;
      flex-direction: column;
    }
    #analytics-content .card > div {
      flex: 1;
      min-height: 300px;
      position: relative;
    }
    #analytics-content .card > div[style*="position: relative"] {
      min-height: 300px;
    }
    input, select, textarea {
      width: 100%;
      padding: 14px 18px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text);
      font: inherit;
      line-height: 1.6;
      transition: border-color 150ms ease, box-shadow 150ms ease;
      font-size: 15px;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(58,127,245,0.08);
    }
    label { display: block; font-weight: 600; margin: 20px 0 10px; font-size: 0.9rem; line-height: 1.5; color: var(--text); }
    label:first-child { margin-top: 0; }
    .app {
      display: flex;
      min-height: 100vh;
      flex-direction: column;
    }
    header.topbar {
      position: sticky;
      top: 0;
      z-index: 20;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 20px;
      padding: 20px 28px;
      box-shadow: var(--shadow-soft);
    }
    header.topbar .custom-header-image {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 100%;
      width: 100%;
      z-index: 0;
      pointer-events: none;
    }
    header.topbar > * {
      position: relative;
      z-index: 1;
    }
    .logo-chip {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 8px 14px;
      border-radius: 999px;
      background: var(--logo-bg);
      border: 1px solid var(--border);
      min-width: 48px;
      min-height: 40px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.2);
      cursor: pointer;
    }
    .logo-chip img { height: 24px; width: 24px; object-fit: contain; }
    nav.tabs {
      display: flex;
      gap: 16px;
      padding: 16px 28px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: var(--topbar-height, 76px);
      z-index: 10;
    }
    nav.tabs button {
      background: transparent;
      border: 1px solid transparent;
      padding: 12px 20px;
      border-radius: 10px;
      color: var(--muted);
      font-weight: 500;
      font-size: 0.95rem;
      line-height: 1.5;
    }
    nav.tabs button.active {
      background: var(--surface-soft);
      color: var(--text);
      border-color: var(--border);
    }
    nav.tabs .top-actions {
      margin-left: auto;
      gap: 12px;
    }
    nav.tabs .top-actions button {
      background: var(--surface-soft);
      color: var(--text);
      border-color: var(--border);
    }
    .dark nav.tabs .top-actions button {
      color: #fff;
    }
    nav.tabs .top-actions button.primary {
      background: var(--accent);
      color: #fff;
      border-color: transparent;
    }
    main { padding: 28px; }
    section[data-section] {
      margin-bottom: 40px;
    }
    section[data-section]:last-child {
      margin-bottom: 0;
    }
    .grid { display: grid; gap: 28px; }
    .grid.cols-2 { grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); }
    .grid.cols-4 { grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); }
    .grid.cols-4 > .card { grid-column: auto !important; }
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 28px;
    }
    .card h3 { 
      margin-top: 0; 
      margin-bottom: 20px; 
      font-size: 1.3rem;
      font-weight: 700;
      line-height: 1.4;
      letter-spacing: -0.02em;
      color: var(--text);
    }
    section[data-section="dashboard"] .card {
      display: flex;
      flex-direction: column;
    }
    #dashboard-activity {
      flex: 1;
      min-height: 0;
      gap: 0;
      overflow: auto;
    }
    table { width: 100%; border-collapse: separate; border-spacing: 0; }
    .table-scroll {
      max-width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    section[data-section="clients"] table {
      table-layout: fixed;
    }
    section[data-section="clients"] th,
    section[data-section="clients"] td {
      overflow-wrap: anywhere;
      word-break: break-word;
    }
    section[data-section="clients"] td.actions {
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    tr { margin-bottom: 2px; }
    th, td {
      padding: 16px 18px;
      border-bottom: 1px solid var(--border);
      text-align: left;
    }
    #invoice-rows td {
      padding: 14px 16px;
      white-space: nowrap;
      vertical-align: middle;
    }
    #invoice-rows td:nth-child(2) {
      white-space: normal;
      max-width: 220px;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    #invoice-rows td:last-child {
      white-space: nowrap;
    }
    #invoice-rows tbody tr {
      transition: background 150ms ease;
    }
    #invoice-rows tbody tr:hover {
      background: var(--surface-soft);
    }
    #invoice-rows td.row {
      flex-wrap: nowrap;
      gap: 8px;
    }
    #invoice-rows td.row button {
      padding: 8px 12px;
      font-size: 0.875rem;
      white-space: nowrap;
    }
    th { 
      color: var(--muted); 
      font-size: 0.8rem; 
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.6px;
      position: sticky; 
      top: 0; 
      background: var(--surface);
      padding-bottom: 14px;
      padding-top: 18px;
    }
    tr:hover { background: var(--surface-soft); transition: background 150ms ease; }
    tr td { transition: background 150ms ease; }
    tr:last-child td { border-bottom: none; }
    .hidden { display: none !important; }
    .splash-overlay {
      position: fixed;
      inset: 0;
      background: rgba(10, 14, 22, 0.7);
      backdrop-filter: blur(6px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 24px;
      opacity: 1;
      transition: opacity 220ms ease;
    }
    .splash-overlay.fade-out {
      opacity: 0;
    }
    .splash-card {
      background: transparent;
      border: none;
      border-radius: 0;
      box-shadow: none;
      padding: 0;
      max-width: 640px;
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 0;
      align-items: center;
    }
    .splash-video {
      width: 100%;
      max-height: 360px;
      border-radius: 12px;
      background: #000;
    }
    .pill { padding: 8px 14px; border-radius: 999px; background: var(--surface-soft); border: 1px solid var(--border); font-size: 0.875rem; font-weight: 500; line-height: 1.4; }
    .stack { display: flex; flex-direction: column; gap: 16px; }
    .row { display: flex; align-items: center; gap: 16px; flex-wrap: wrap; }
    .actions {
      flex-wrap: nowrap;
      gap: 8px;
      justify-content: flex-end;
    }
    .space { margin-top: 20px; }
    .side-panel {
      position: fixed;
      top: 0; right: 0; bottom: 0;
      width: min(420px, 90vw);
      background: var(--surface);
      border-left: 1px solid var(--border);
      box-shadow: -8px 0 24px rgba(0,0,0,0.15);
      transform: translateX(100%);
      opacity: 0;
      transition: transform 220ms ease, opacity 180ms ease;
      z-index: 50;
      padding: 28px;
      overflow-y: auto;
    }
    .side-panel.open { transform: translateX(0); opacity: 1; }
    .invoice-view {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .invoice-header {
      margin-bottom: 10px;
    }
    .invoice-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }
    .invoice-content {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }
    .invoice-header-info {
      display: flex;
      justify-content: space-between;
      gap: 20px;
      padding-bottom: 20px;
      border-bottom: 2px solid var(--border);
    }
    .invoice-logo {
      margin-bottom: 16px;
    }
    .invoice-logo img {
      max-height: 60px;
      max-width: 200px;
      object-fit: contain;
    }
    .invoice-from h2 {
      font-size: 1.4em;
      margin-bottom: 8px;
      margin-top: 0;
    }
    .invoice-title {
      text-align: right;
    }
    .invoice-title h1 {
      font-size: 2em;
      margin-bottom: 8px;
      margin-top: 0;
      font-weight: 700;
    }
    .invoice-number {
      font-size: 1.1em;
      font-weight: 600;
      color: var(--muted);
      margin-bottom: 8px;
    }
    .invoice-status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 6px;
      font-weight: 600;
      font-size: 0.85em;
      margin-top: 8px;
    }
    .invoice-status.void {
      background: rgba(226, 85, 85, 0.1);
      color: var(--danger);
    }
    .invoice-status.paid {
      background: rgba(31, 179, 122, 0.1);
      color: var(--success);
    }
    .invoice-details {
      display: flex;
      justify-content: space-between;
      gap: 20px;
    }
    .invoice-to h3 {
      margin-bottom: 10px;
      font-size: 1em;
      font-weight: 600;
    }
    .invoice-meta {
      text-align: right;
    }
    .invoice-meta-row {
      display: flex;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 8px;
    }
    .invoice-meta-row span:first-child {
      color: var(--muted);
    }
    .invoice-lines {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    .invoice-lines th {
      background: var(--surface-soft);
      padding: 12px;
      text-align: left;
      font-weight: 600;
      border-bottom: 2px solid var(--border);
      font-size: 0.9em;
    }
    .invoice-lines td {
      padding: 12px;
      border-bottom: 1px solid var(--border);
    }
    .invoice-total {
      border-top: 2px solid var(--text);
    }
    .invoice-total td {
      padding-top: 20px;
    }
    @media print {
      .invoice-actions { display: none !important; }
      .side-panel { position: static; transform: none; opacity: 1; width: 100%; box-shadow: none; border: none; padding: 0; }
      body { background: white; }
    }
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: var(--surface);
      border: 1px solid var(--border);
      padding: 16px 18px;
      border-radius: 14px;
      box-shadow: var(--shadow);
      display: flex;
      align-items: center;
      gap: 14px;
      transform: translateY(20px);
      opacity: 0;
      transition: transform 180ms ease, opacity 180ms ease;
      z-index: 60;
    }
    .toast.show { transform: translateY(0); opacity: 1; }
    .badge { padding: 8px 14px; border-radius: 10px; font-size: 0.875rem; background: var(--surface-soft); border: 1px solid var(--border); font-weight: 500; line-height: 1.4; }
    .status-dot { 
      width: 10px; 
      height: 10px; 
      border-radius: 50%; 
      background: var(--muted); 
      display: inline-block; 
      margin-right: 10px;
      vertical-align: middle;
      box-shadow: 0 0 0 2px var(--surface), 0 0 0 3px transparent;
    }
    .status-posted { 
      background: var(--success); 
      box-shadow: 0 0 0 2px var(--surface), 0 0 0 3px rgba(31, 179, 122, 0.15);
    }
    .status-draft { 
      background: var(--muted); 
    }
    .status-void { 
      background: var(--danger); 
      box-shadow: 0 0 0 2px var(--surface), 0 0 0 3px rgba(226, 85, 85, 0.15);
    }
    .empty {
      padding: 56px 32px;
      text-align: center;
      color: var(--muted);
      border: 1px dashed var(--border);
      border-radius: 18px;
      background: var(--surface);
      font-size: 0.95rem;
      line-height: 1.7;
      margin: 20px 0;
    }
    .saved-flag {
      padding: 6px 12px;
      background: var(--surface-soft);
      border-radius: 8px;
      border: 1px solid var(--border);
      color: var(--muted);
      font-size: 0.875rem;
      font-weight: 500;
      line-height: 1.4;
    }
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 80;
      backdrop-filter: blur(2px);
    }
    .overlay.show { display: flex; }
    .modal {
      background: var(--surface);
      border-radius: 18px;
      padding: 28px;
      width: min(420px, 90vw);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
    }
    .recent-chip { 
      background: var(--surface-soft); 
      border: 1px solid var(--border); 
      padding: 8px 14px; 
      border-radius: 8px; 
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: background 150ms ease, border-color 150ms ease;
      line-height: 1.4;
    }
    .recent-chip:hover {
      background: var(--border);
      border-color: var(--accent);
    }
    .calculator-window {
      position: fixed;
      width: min(320px, 92vw);
      height: min(400px, 80vh);
      max-width: calc(100vw - 24px);
      max-height: calc(100vh - 24px);
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: 0 8px 32px rgba(0,0,0,0.15);
      z-index: 55;
      display: flex;
      flex-direction: column;
      user-select: none;
      overflow: hidden;
    }
    .calculator-window.hidden {
      display: none;
    }
    .calculator-header {
      background: var(--surface-soft);
      border-bottom: 1px solid var(--border);
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: move;
      flex-shrink: 0;
    }
    .calculator-header span {
      font-weight: 600;
      font-size: 0.95rem;
      color: var(--text);
    }
    .calculator-controls {
      display: flex;
      gap: 8px;
    }
    .calculator-btn-minimize,
    .calculator-btn-close {
      width: 24px;
      height: 24px;
      border: none;
      background: transparent;
      color: var(--muted);
      cursor: pointer;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      line-height: 1;
      padding: 0;
      transition: background 150ms ease, color 150ms ease;
    }
    .calculator-btn-minimize:hover,
    .calculator-btn-close:hover {
      background: var(--border);
      color: var(--text);
    }
    .calculator-body {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 16px;
      overflow-y: auto;
      overflow-x: hidden;
      min-height: 0;
    }
    .calculator-window[style*="height"] .calculator-body {
      min-height: 0;
    }
    .calculator-display {
      background: var(--surface-soft);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px 12px 10px;
      margin-bottom: 12px;
      min-height: 64px;
      max-height: 84px;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      align-items: flex-end;
      text-align: right;
      position: relative;
      padding-right: 54px;
    }
    .calculator-display-toolbar {
      position: absolute;
      top: 8px;
      right: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .calculator-copy-btn {
      border: none;
      background: transparent;
      color: var(--muted);
      cursor: pointer;
      border-radius: 6px;
      padding: 2px 6px;
      font-size: 0.75rem;
      line-height: 1;
      transition: background 150ms ease, color 150ms ease;
    }
    .calculator-copy-btn:hover {
      background: var(--border);
      color: var(--text);
    }
    .calculator-display-secondary {
      font-size: 0.875rem;
      color: var(--muted);
      min-height: 16px;
      margin-bottom: 6px;
      word-break: break-all;
    }
    .calculator-display-primary {
      font-size: 2rem;
      font-weight: 600;
      color: var(--text);
      word-break: break-all;
      line-height: 1.2;
    }
    .calculator-buttons {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      flex: 0 0 auto;
      padding-bottom: 4px;
    }
    .calc-btn {
      border: 1px solid var(--border);
      background: var(--surface-soft);
      color: var(--text);
      border-radius: 8px;
      font-size: 1.1rem;
      font-weight: 500;
      cursor: pointer;
      transition: transform 100ms ease, background 150ms ease, box-shadow 150ms ease;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 48px;
    }
    .calc-btn:hover {
      background: var(--border);
    }
    .calc-btn:active {
      transform: scale(0.95);
    }
    .calc-btn-number {
      background: var(--surface);
    }
    .calc-btn-operator {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }
    .calc-btn-operator:hover {
      background: var(--accent);
      opacity: 0.9;
    }
    .calc-btn-function {
      background: var(--surface-soft);
      color: var(--muted);
    }
    .calc-btn-equals {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }
    .calc-btn-equals:hover {
      background: var(--accent);
      opacity: 0.9;
    }
    .calc-btn-zero {
      grid-column: span 2;
    }
    .calculator-resize-handle {
      position: absolute;
      bottom: 0;
      right: 0;
      width: 20px;
      height: 20px;
      cursor: nwse-resize;
      background: linear-gradient(-45deg, transparent 30%, var(--border) 30%, var(--border) 35%, transparent 35%, transparent 65%, var(--border) 65%, var(--border) 70%, transparent 70%);
    }
    .calculator-resize-handle:hover {
      background: linear-gradient(-45deg, transparent 30%, var(--accent) 30%, var(--accent) 35%, transparent 35%, transparent 65%, var(--accent) 65%, var(--accent) 70%, transparent 70%);
    }
    .calculator-minimized {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 65;
    }
    .calculator-minimized.hidden {
      display: none;
    }
    .calculator-minimized button {
      padding: 12px 20px;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(58,127,245,0.3);
      transition: transform 150ms ease, box-shadow 150ms ease;
    }
    .calculator-minimized button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(58,127,245,0.4);
    }
    .calculator-minimized button:active {
      transform: translateY(0);
    }
    .note-window {
      position: fixed;
      width: min(420px, 92vw);
      height: min(460px, 80vh);
      max-width: calc(100vw - 24px);
      max-height: calc(100vh - 24px);
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: 0 8px 32px rgba(0,0,0,0.15);
      z-index: 56;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .note-window.hidden {
      display: none;
    }
    .note-header {
      background: var(--surface-soft);
      border-bottom: 1px solid var(--border);
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: move;
      flex-shrink: 0;
      user-select: none;
    }
    .note-header span {
      font-weight: 600;
      font-size: 0.95rem;
      color: var(--text);
    }
    .note-controls {
      display: flex;
      gap: 8px;
    }
    .note-body {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding: 16px;
      overflow: hidden;
      min-height: 0;
    }
    .note-toolbar {
      display: flex;
      flex-wrap: nowrap;
      gap: 8px;
      align-items: center;
      overflow-x: auto;
      white-space: nowrap;
    }
    .note-toolbar select,
    .note-toolbar input {
      min-height: 36px;
    }
    #note-menu {
      min-width: 180px;
    }
    #note-content {
      order: 0;
      flex: 1 1 auto;
      width: 100%;
      resize: none;
      border-radius: 12px;
      border: 1px solid var(--border);
      padding: 12px;
      background: var(--surface);
      color: var(--text);
      font-size: 0.95rem;
      line-height: 1.5;
      min-height: 42px;
      overflow: auto;
    }
    #note-content[contenteditable="true"]:empty::before {
      content: attr(data-placeholder);
      color: var(--muted);
    }
    .note-resize-handle {
      position: absolute;
      bottom: 0;
      right: 0;
      width: 20px;
      height: 20px;
      cursor: nwse-resize;
      background: linear-gradient(-45deg, transparent 30%, var(--border) 30%, var(--border) 35%, transparent 35%, transparent 65%, var(--border) 65%, var(--border) 70%, transparent 70%);
    }
    .note-resize-handle:hover {
      background: linear-gradient(-45deg, transparent 30%, var(--accent) 30%, var(--accent) 35%, transparent 35%, transparent 65%, var(--accent) 65%, var(--accent) 70%, transparent 70%);
    }
    .note-minimized {
      position: fixed;
      bottom: 20px;
      right: 120px;
      z-index: 65;
    }
    .note-minimized.hidden {
      display: none;
    }
    .note-minimized button {
      padding: 12px 18px;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(58,127,245,0.3);
      transition: transform 150ms ease, box-shadow 150ms ease;
    }
    .note-minimized button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(58,127,245,0.4);
    }
    .note-minimized button:active {
      transform: translateY(0);
    }
    .note-unsaved {
      border-color: var(--accent);
      color: var(--accent);
    }
    @media (prefers-reduced-motion: reduce) {
      :root { --motion-scale: 0; }
      * { transition: none !important; animation: none !important; }
    }
    .motion-off *, .motion-reduced * {
      transition: none !important;
      animation: none !important;
    }
  </style>
</head>
<body>
  <div id="splash-overlay" class="splash-overlay hidden" role="dialog" aria-label="Brand intro">
    <div class="splash-card">
      <video id="splash-video" class="splash-video" playsinline preload="auto">
        <source src="https://video.wixstatic.com/video/afbb39_32010cb1c1e1423184fe68fec0b8c47c/1080p/mp4/file.mp4" type="video/mp4">
      </video>
    </div>
  </div>
  <div class="app">
    <header class="topbar">
      <img id="custom-header-image" class="custom-header-image" alt="" style="display:none">
      <div class="logo-chip" id="logo-chip"><img id="logo-img" alt="Logo"></div>
      <div class="stack" style="gap:4px">
        <strong id="business-name" style="font-size:1.1rem;font-weight:700;line-height:1.3">Checkmark Accountant V5</strong>
      </div>
    </header>
    <nav class="tabs">
      <button data-tab="dashboard" class="active">Dashboard</button>
      <button data-tab="invoices">Invoices</button>
      <button data-tab="transactions">Transactions</button>
      <button data-tab="clients">Clients</button>
      <button data-tab="services">Services</button>
      <button data-tab="analytics">Analytics</button>
      <button data-tab="reports">Reports</button>
      <div class="row top-actions" style="margin-left:auto; gap:16px">
        <button id="quick-add-invoice" class="primary">Quick Invoice</button>
        <button id="quick-add-transaction">Quick Txn</button>
        <button id="open-calculator">Calculator</button>
        <button id="open-note">Note</button>
        <button id="open-settings">Settings</button>
      </div>
    </nav>
    <main>
      <section data-section="dashboard" class="grid cols-2">
        <div class="card">
          <h3>Overview</h3>
          <div class="row" style="flex-wrap: wrap; gap: 8px; align-items: center; margin-bottom: 12px;">
            <button class="date-preset-btn" data-preset="today" data-for="dashboard">Today</button>
            <button class="date-preset-btn" data-preset="week" data-for="dashboard">This Week</button>
            <button class="date-preset-btn" data-preset="month" data-for="dashboard">This Month</button>
            <button class="date-preset-btn" data-preset="quarter" data-for="dashboard">This Quarter</button>
            <button class="date-preset-btn" data-preset="year" data-for="dashboard">This Year</button>
            <button class="date-preset-btn" data-preset="all" data-for="dashboard">All Time</button>
          </div>
          <div id="dashboard-range" class="muted" style="margin-bottom: 12px;"></div>
          <div class="grid cols-2" id="dashboard-kpis"></div>
          <div class="stack" style="margin-top: 20px; gap: 16px;">
            <div>
              <h4 style="margin: 0 0 8px 0;">Client Revenue</h4>
              <div id="dashboard-client-revenue-container" style="position: relative; height: 240px;">
                <canvas id="dashboard-client-revenue-chart"></canvas>
              </div>
            </div>
          </div>
        </div>
        <div class="card">
          <h3>Recent Activity</h3>
          <div id="dashboard-activity" class="stack"></div>
        </div>
      </section>

      <section data-section="invoices" class="hidden">
        <div class="card">
          <div class="row" style="justify-content:space-between; align-items:center">
            <h3>Invoices</h3>
            <button id="add-invoice" class="primary">New Invoice</button>
          </div>
          <div class="row" style="gap:8px; flex-wrap:wrap; align-items:center; margin:8px 0">
            <button id="export-invoices-json" class="ghost">Export JSON</button>
            <button id="export-invoices-csv" class="ghost">Export CSV</button>
            <button id="import-invoices-btn" class="ghost">Import CSV/JSON</button>
            <input type="file" id="import-invoices-file" class="hidden" accept=".json,application/json,.csv,text/csv">
            <input type="search" id="invoice-search" placeholder="Search by client or date" style="min-width:220px">
          </div>
          <div class="stack">
            <table>
              <thead><tr><th>#</th><th>Client</th><th>Date</th><th>Status</th><th>Total</th><th></th></tr></thead>
              <tbody id="invoice-rows"></tbody>
            </table>
            <div class="empty hidden" id="invoice-empty">No invoices yet. Create your first invoice.</div>
            <div class="empty hidden" id="invoice-empty-filter">No matching invoices.</div>
          </div>
        </div>
      </section>

      <section data-section="transactions" class="grid cols-2 hidden">
        <div class="card">
          <div class="row" style="justify-content:space-between; align-items:center">
            <h3>Transactions</h3>
            <button id="add-transaction" class="primary">Add</button>
          </div>
          <div class="stack">
            <div class="row" style="flex-wrap:wrap; gap:8px; align-items:center">
              <button id="export-txn-json" class="ghost">Export JSON</button>
              <button id="export-txn-csv" class="ghost">Export CSV</button>
              <button id="import-txn-btn" class="ghost">Import CSV/JSON</button>
              <input type="file" id="import-txn-file" class="hidden" accept=".json,application/json,.csv,text/csv">
              <input type="search" id="txn-search" placeholder="Search by name or date" style="min-width:220px">
            </div>
            <table>
              <thead><tr><th>Date</th><th>Type</th><th>Category</th><th>Amount</th><th></th></tr></thead>
              <tbody id="txn-rows"></tbody>
            </table>
            <div class="empty hidden" id="txn-empty">No transactions yet.</div>
            <div class="empty hidden" id="txn-empty-filter">No matching transactions.</div>
          </div>
        </div>
        <div class="card">
          <h3>Draft</h3>
          <div id="txn-draft"></div>
        </div>
      </section>

      <section data-section="clients" class="grid cols-2 hidden">
        <div class="card">
          <div class="row" style="justify-content:space-between; align-items:center">
            <h3>Clients / Parties</h3>
            <button id="add-client" class="primary">Add</button>
          </div>
          <div class="row" style="gap:8px; flex-wrap:wrap; align-items:center; margin:8px 0">
            <button id="export-clients-json" class="ghost">Export JSON</button>
            <button id="export-clients-csv" class="ghost">Export CSV</button>
            <button id="import-clients-btn" class="ghost">Import CSV/JSON</button>
            <input type="file" id="import-clients-file" class="hidden" accept=".json,application/json,.csv,text/csv">
          </div>
          <div class="table-scroll">
            <table>
              <thead><tr><th>Name</th><th>Email</th><th></th></tr></thead>
              <tbody id="client-rows"></tbody>
            </table>
          </div>
          <div class="empty hidden" id="client-empty">No parties yet.</div>
        </div>
        <div class="card">
          <div class="row" style="justify-content:space-between; align-items:center">
            <h3>Projects</h3>
            <button id="add-project" class="primary">Add</button>
          </div>
          <div class="table-scroll">
            <table>
              <thead><tr><th>Name</th><th>Client</th><th></th></tr></thead>
              <tbody id="project-rows"></tbody>
            </table>
          </div>
          <div class="empty hidden" id="project-empty">No projects yet.</div>
        </div>
      </section>

      <section data-section="services" class="hidden">
        <div class="card">
          <div class="row" style="justify-content:space-between; align-items:center">
            <h3>Services Catalog</h3>
            <button id="add-service" class="primary">Add Service</button>
          </div>
          <div class="row" style="gap:8px; flex-wrap:wrap; align-items:center; margin:8px 0">
            <button id="export-services-json" class="ghost">Export JSON</button>
            <button id="export-services-csv" class="ghost">Export CSV</button>
            <button id="import-services-btn" class="ghost">Import CSV/JSON</button>
            <input type="file" id="import-services-file" class="hidden" accept=".json,application/json,.csv,text/csv">
          </div>
          <table>
            <thead><tr><th>Name</th><th>Rate</th><th>Billing</th><th></th></tr></thead>
            <tbody id="service-rows"></tbody>
          </table>
          <div class="empty hidden" id="service-empty">No services yet.</div>
        </div>
      </section>

      <section data-section="analytics" class="hidden">
        <div class="card" style="margin-bottom: 28px;">
          <h3 style="margin-bottom: 20px;">Date Range</h3>
          <div class="row" style="flex-wrap: wrap; gap: 12px; align-items: center;">
            <div class="row" style="gap: 8px; flex-wrap: wrap;">
              <button class="date-preset-btn" data-preset="today" data-for="analytics">Today</button>
              <button class="date-preset-btn" data-preset="week" data-for="analytics">This Week</button>
              <button class="date-preset-btn" data-preset="month" data-for="analytics">This Month</button>
              <button class="date-preset-btn" data-preset="quarter" data-for="analytics">This Quarter</button>
              <button class="date-preset-btn" data-preset="year" data-for="analytics">This Year</button>
              <button class="date-preset-btn" data-preset="all" data-for="analytics">All Time</button>
            </div>
            <div class="row" style="gap: 8px; align-items: center; flex: 1; min-width: 300px;">
              <label style="margin: 0; font-size: 0.9rem; color: var(--muted); font-weight: 500;">From:</label>
              <input type="date" id="analytics-start" style="flex: 1; min-width: 140px;" title="Start date">
              <label style="margin: 0; font-size: 0.9rem; color: var(--muted); font-weight: 500;">To:</label>
              <input type="date" id="analytics-end" style="flex: 1; min-width: 140px;" title="End date">
            </div>
            <button id="refresh-analytics" class="primary" title="Refresh analytics with current date range">Refresh</button>
          </div>
        </div>
        <div class="row" style="justify-content: flex-end; margin-bottom: 20px; gap: 12px;">
          <button id="export-analytics-pdf" class="primary">Export PDF</button>
          <button id="print-analytics">Print</button>
        </div>
        <div id="analytics-content" class="grid cols-2">
          <div class="card">
            <h3>Income vs Expenses Trend</h3>
            <div style="position: relative; height: 300px;">
              <canvas id="income-expense-chart"></canvas>
            </div>
          </div>
          <div class="card">
            <h3>Profit & Loss</h3>
            <div style="position: relative; height: 300px;">
              <canvas id="profit-loss-chart"></canvas>
            </div>
          </div>
          <div class="card">
            <h3>Expense by Category</h3>
            <div style="position: relative; height: 300px;">
              <canvas id="expense-category-chart"></canvas>
            </div>
          </div>
          <div class="card">
            <h3>Income by Category</h3>
            <div style="position: relative; height: 300px;">
              <canvas id="income-category-chart"></canvas>
            </div>
          </div>
          <div class="card">
            <h3>Client Revenue</h3>
            <div style="position: relative; height: 300px;">
              <canvas id="client-revenue-chart"></canvas>
            </div>
          </div>
          <div class="card">
            <h3>Monthly Summary</h3>
            <div style="position: relative; height: 300px;">
              <canvas id="monthly-summary-chart"></canvas>
            </div>
          </div>
        </div>
      </section>

      <section data-section="reports" class="hidden">
        <div class="card" style="margin-bottom: 28px;">
          <h3 style="margin-bottom: 20px;">Date Range</h3>
          <div class="row" style="flex-wrap: wrap; gap: 12px; align-items: center;">
            <div class="row" style="gap: 8px; flex-wrap: wrap;">
              <button class="date-preset-btn" data-preset="today" data-for="reports">Today</button>
              <button class="date-preset-btn" data-preset="week" data-for="reports">This Week</button>
              <button class="date-preset-btn" data-preset="month" data-for="reports">This Month</button>
              <button class="date-preset-btn" data-preset="quarter" data-for="reports">This Quarter</button>
              <button class="date-preset-btn" data-preset="year" data-for="reports">This Year</button>
              <button class="date-preset-btn" data-preset="all" data-for="reports">All Time</button>
            </div>
            <div class="row" style="gap: 8px; align-items: center; flex: 1; min-width: 300px;">
              <input type="date" id="reports-start" style="flex: 1; min-width: 140px;">
              <span style="color: var(--muted);">to</span>
              <input type="date" id="reports-end" style="flex: 1; min-width: 140px;">
            </div>
            <button id="refresh-reports" class="primary">Refresh</button>
          </div>
        </div>
        <div class="row" style="justify-content: flex-end; margin-bottom: 20px; gap: 12px;">
          <button id="export-reports-pdf" class="primary">Export PDF</button>
          <button id="print-reports">Print</button>
        </div>
        <div id="reports-content" class="grid cols-2">
          <div class="card">
            <h3>Profit & Loss</h3>
            <div id="pl-output" class="stack space"></div>
          </div>
          <div class="card">
            <h3>Other Reports</h3>
            <div class="stack">
              <button id="run-expense-summary">Expense by Category</button>
              <div id="report-expense"></div>
              <button id="run-client-summary">Client Revenue</button>
              <div id="report-client"></div>
              <button id="run-project-summary">Project Profitability</button>
              <div id="report-project"></div>
              <button id="run-tax-summary">Tax Summary</button>
              <button id="calc-grt" class="ghost">Calculate GRT</button>
              <div class="row" style="gap:8px; align-items:center">
                <button id="calc-grt-year" class="ghost">GRT Whole Year</button>
                <select id="grt-year" style="max-width:140px"></select>
              </div>
              <div id="grt-range" class="muted" style="margin-bottom:6px"></div>
              <div id="report-tax"></div>
              <div id="grt-meta" class="muted" style="margin-bottom:12px"></div>
            </div>
          </div>
        </div>
      </section>

      <section data-section="settings" class="grid cols-4 hidden">
        <div class="card" style="grid-column:1">
          <h3>Appearance</h3>
          <label>Intro Video on Startup</label>
          <button id="splash-video-toggle" class="ghost" style="width:100%">On</button>
          <label style="margin-top:16px">Theme</label>
          <select id="theme-select">
            <option value="system">System</option>
            <option value="light">Light</option>
            <option value="dark">Dark</option>
          </select>
          <label>Logo (Light)</label>
          <input type="file" id="logo-light" accept="image/*">
          <label>Logo (Dark)</label>
          <input type="file" id="logo-dark" accept="image/*">
          <label>Logo Variant</label>
          <select id="logo-variant">
            <option value="auto">Auto</option>
            <option value="light">Light</option>
            <option value="dark">Dark</option>
          </select>
          <label>Custom Header Image (Optional)</label>
          <input type="file" id="header-image" accept="image/*">
          <div id="header-image-preview" style="margin-top:10px"></div>
          <label style="margin-top:16px">Header Image Fit</label>
          <select id="header-image-fit">
            <option value="cover">Cover (Fill)</option>
            <option value="contain">Contain (Fit)</option>
            <option value="fill">Fill (Stretch)</option>
            <option value="none">None (Original)</option>
          </select>
          <label style="margin-top:16px">Header Image Opacity</label>
          <input type="range" id="header-image-opacity" min="0" max="100" value="10" step="5">
          <div style="display:flex; justify-content:space-between; margin-top:4px; font-size:0.875rem; color:var(--muted)">
            <span>0%</span>
            <span id="header-opacity-value">10%</span>
            <span>100%</span>
          </div>
          <button id="remove-header-image" class="ghost" style="margin-top:10px; display:none; color:var(--danger)">Remove Header Image</button>
        </div>
        <div class="card" style="grid-column:2">
          <h3>Invoicing</h3>
          <label>Default Tax % (optional)</label>
          <input type="number" id="default-tax-percent" step="0.01" min="0" placeholder="0.00">
          <p style="font-size:0.9rem; color:var(--muted); margin-top:8px">Applied to new invoices; you can override per invoice.</p>
          <label style="margin-top:16px">GRT % (optional)</label>
          <input type="number" id="grt-percent" step="0.01" min="0" placeholder="0.00">
          <label style="margin-top:16px">GRT Basis</label>
          <select id="grt-basis">
            <option value="invoices">Invoices issued</option>
            <option value="payments">Payments received</option>
            <option value="both">Both</option>
          </select>
          <p style="font-size:0.9rem; color:var(--muted); margin-top:8px">Invoices use totals (including tax/tip). Both can double-count if invoices were paid.</p>
          <label style="margin-top:16px">GRT Filing Frequency</label>
          <select id="grt-filing-frequency">
            <option value="monthly">Monthly</option>
            <option value="quarterly">Quarterly</option>
            <option value="semiannual">Semi-annual</option>
          </select>
          <p style="font-size:0.9rem; color:var(--muted); margin-top:8px">Used by the GRT calculator in Reports.</p>
        </div>
        <div class="card" style="grid-column:3">
          <h3>Data</h3>
          <div class="row" style="align-items:center; gap:8px; margin-bottom:12px">
            <span>Save Status:</span>
            <span class="saved-flag" id="saved-flag">Saved</span>
          </div>
          <button id="export-json">Backup / Export</button>
          <button id="export-audit-log" class="ghost" style="margin-top:6px">Export Audit Log</button>
          <input type="file" id="import-json" class="hidden" accept="application/json">
          <button id="import-json-btn">Import</button>
          <div class="muted" style="margin-top:8px">Integrity runs automatically.</div>
          <div id="integrity-output" class="stack space"></div>
          <div style="margin-top:16px; padding-top:16px; border-top:1px solid var(--border)">
            <h4 style="margin-bottom:10px; font-size:1rem; font-weight:600">Migration</h4>
            <div id="migration-block" class="stack"></div>
          </div>
          <div style="margin-top:16px; padding-top:16px; border-top:1px solid var(--border)">
            <button id="reset-all-data" style="background:var(--danger); color:#fff; border:none">Reset All Data</button>
            <p style="margin-top:8px; font-size:0.875rem; color:var(--muted)">This will permanently delete all businesses and data. This cannot be undone.</p>
          </div>
        </div>
        <div class="card" style="grid-column:4">
          <h3>Business</h3>
          <label>Selected Business</label>
          <select id="business-selector"></select>
          <div id="business-info" class="stack"></div>
          <button id="edit-business-info" class="ghost" style="width:100%; margin-top:12px">Edit Business Info</button>
          <div style="margin-top:20px; padding-top:20px; border-top:1px solid var(--border)">
            <button id="new-business" class="primary" style="width:100%">+ New Business</button>
          </div>
          <div style="margin-top:20px; padding-top:20px; border-top:1px solid var(--border)">
            <button id="delete-business" style="background:var(--danger); color:#fff; border:none; width:100%">Delete Current Business</button>
            <p style="margin-top:10px; font-size:0.875rem; color:var(--muted)">This will permanently delete the current business and all its data. This cannot be undone.</p>
          </div>
        </div>
      </section>
    </main>
  </div>

  <div class="side-panel" id="side-panel">
    <div class="row" style="justify-content:space-between; align-items:center; margin-bottom:28px; padding-bottom:20px; border-bottom:1px solid var(--border)">
      <h3 id="panel-title" style="margin:0; font-size:1.25rem; font-weight:700"></h3>
      <button id="close-panel" class="ghost">Close</button>
    </div>
    <div id="panel-body"></div>
  </div>

  <div class="overlay" id="modal-overlay">
    <div class="modal" id="modal-body"></div>
  </div>

  <div class="toast" id="toast"><span id="toast-msg"></span><button id="toast-undo" class="ghost">Undo</button></div>

  <div class="calculator-window hidden" id="calculator-window">
    <div class="calculator-header" id="calculator-header">
      <span>Calculator</span>
      <div class="calculator-controls">
        <button class="calculator-btn-minimize" id="calculator-minimize" title="Minimize"></button>
        <button class="calculator-btn-close" id="calculator-close" title="Close"></button>
      </div>
    </div>
    <div class="calculator-body" id="calculator-body">
      <div class="calculator-display">
        <div class="calculator-display-toolbar">
          <button class="calculator-copy-btn" id="calculator-copy" title="Copy number">Copy</button>
        </div>
        <div class="calculator-display-secondary" id="calculator-secondary"></div>
        <div class="calculator-display-primary" id="calculator-primary">0</div>
      </div>
      <div class="calculator-buttons">
        <button class="calc-btn calc-btn-function" data-action="clear">AC</button>
        <button class="calc-btn calc-btn-function" data-action="clearEntry">C</button>
        <button class="calc-btn calc-btn-operator" data-action="percent">%</button>
        <button class="calc-btn calc-btn-operator" data-action="divide"></button>
        <button class="calc-btn calc-btn-number" data-value="7">7</button>
        <button class="calc-btn calc-btn-number" data-value="8">8</button>
        <button class="calc-btn calc-btn-number" data-value="9">9</button>
        <button class="calc-btn calc-btn-operator" data-action="multiply"></button>
        <button class="calc-btn calc-btn-number" data-value="4">4</button>
        <button class="calc-btn calc-btn-number" data-value="5">5</button>
        <button class="calc-btn calc-btn-number" data-value="6">6</button>
        <button class="calc-btn calc-btn-operator" data-action="subtract"></button>
        <button class="calc-btn calc-btn-number" data-value="1">1</button>
        <button class="calc-btn calc-btn-number" data-value="2">2</button>
        <button class="calc-btn calc-btn-number" data-value="3">3</button>
        <button class="calc-btn calc-btn-operator" data-action="add">+</button>
        <button class="calc-btn calc-btn-number calc-btn-zero" data-value="0">0</button>
        <button class="calc-btn calc-btn-number" data-action="decimal">.</button>
        <button class="calc-btn calc-btn-operator calc-btn-equals" data-action="equals">=</button>
      </div>
    </div>
    <div class="calculator-resize-handle" id="calculator-resize"></div>
  </div>

  <div class="note-window hidden" id="note-window">
    <div class="note-header" id="note-header">
      <span>Notes</span>
      <div class="note-controls">
        <button class="calculator-btn-minimize" id="note-minimize" title="Minimize"></button>
        <button class="calculator-btn-close" id="note-close" title="Close"></button>
      </div>
    </div>
    <div class="note-body">
      <div id="note-content" class="note-editor" contenteditable="true" data-placeholder="Write a quick note..."></div>
      <div class="note-toolbar">
        <select id="note-menu"></select>
        <button id="note-new" class="ghost">New</button>
        <button id="note-save" class="primary">Save</button>
        <button id="note-delete" class="ghost">Delete</button>
        <button id="note-copy" class="ghost">Copy</button>
      </div>
    </div>
    <div class="note-resize-handle" id="note-resize"></div>
  </div>

  <div class="calculator-minimized hidden" id="calculator-minimized">
    <button id="calculator-restore" title="Restore Calculator">Calc</button>
  </div>

  <div class="note-minimized hidden" id="note-minimized">
    <button id="note-restore" title="Restore Notes">Note</button>
  </div>

  <script>
    // ---------- Utilities ----------
    // #region agent log
    const DEBUG = false;
    const logDebug = (location, message, data, hypothesisId) => {
      if (!DEBUG) return;
      const logEntry = {location,message,data:data||{},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId};
      console.log('[DEBUG]', logEntry);
      try {
        const logs = JSON.parse(localStorage.getItem('_debug_logs') || '[]');
        logs.push(logEntry);
        if (logs.length > 1000) logs.shift();
        localStorage.setItem('_debug_logs', JSON.stringify(logs));
      } catch(e) {}
      fetch('http://127.0.0.1:7242/ingest/251e5d6a-3d5b-41b3-b796-d6cf2eef1b0c',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(logEntry)}).catch(()=>{});
    };
    // #endregion
    const $ = (sel) => {
      const result = document.querySelector(sel);
      // #region agent log
      if (!result) logDebug('$:null',`querySelector returned null for: ${sel}`,{selector:sel},'C');
      // #endregion
      return result;
    };
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));
    const nowIso = () => new Date().toISOString();
    const today = () => new Date().toISOString().slice(0,10);
    const uuid = () => 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
      const r = Math.random()*16|0, v = c === 'x' ? r : (r&0x3|0x8);
      return v.toString(16);
    });
    const syncStickyOffsets = () => {
      const topbar = document.querySelector('header.topbar');
      if (!topbar) return;
      document.documentElement.style.setProperty('--topbar-height', `${topbar.offsetHeight}px`);
    };
    const moneyToCents = (val) => Math.round((Number(val) || 0) * 100);
    const centsToMoney = (c) => (c || 0) / 100;
    const trimTrailingZeros = (val) => {
      if (val === undefined || val === null) return '';
      return String(val).replace(/(\.\d*?[1-9])0+$|\.0*$/,'$1');
    };
    const escapeHtml = (val) => String(val ?? '').replace(/[&<>"']/g, (ch) => ({
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#39;'
    })[ch]);
    const normalizeTimeInput = (val) => {
      const digits = String(val||'').replace(/\D/g,'');
      if (!digits) return '';
      if (digits.length <= 2) {
        return `0:${digits.padStart(2,'0')}`;
      }
      const mins = digits.slice(-2);
      const hours = digits.slice(0, -2).replace(/^0+/, '') || '0';
      return `${hours}:${mins}`;
    };
    const parseTimeToMinutes = (val) => {
      if (val === undefined || val === null) return null;
      const str = String(val).trim();
      if (!str) return null;
      if (str.includes(':')) {
        const [h, m='0'] = str.split(':');
        const hours = Number(h);
        const mins = Number(m);
        if (Number.isNaN(hours) || Number.isNaN(mins)) return null;
        return Math.max(0, Math.round((hours*60) + mins));
      }
      const num = Number(str);
      if (Number.isNaN(num)) return null;
      return Math.max(0, Math.round(num*60));
    };
    const minutesToTimeString = (mins) => {
      if (mins === undefined || mins === null || Number.isNaN(Number(mins))) return '';
      const total = Math.max(0, Math.round(Number(mins)));
      const h = Math.floor(total/60);
      const m = total % 60;
      return `${h}:${m.toString().padStart(2,'0')}`;
    };
    const fmt = (cents, currency='USD') => {
      return new Intl.NumberFormat('en-US', { style: 'currency', currency }).format(centsToMoney(cents));
    };
    const invoiceSubtotal = (inv) => inv?.subtotal_cents ?? inv?.total_cents ?? 0;
    const invoiceTip = (inv) => {
      const tip = Number(inv?.tip_cents);
      return Number.isFinite(tip) ? tip : 0;
    };
    const invoiceTaxPercent = (inv) => {
      const pct = Number(inv?.tax_percent);
      return Number.isFinite(pct) ? pct : 0;
    };
    const invoiceTax = (inv) => {
      if (inv?.tax_cents !== undefined && inv?.tax_cents !== null) return inv.tax_cents;
      const subtotal = invoiceSubtotal(inv);
      const pct = invoiceTaxPercent(inv);
      return Math.round(subtotal * (pct/100));
    };
    const invoiceTotal = (inv) => {
      if (inv?.total_cents !== undefined && inv?.total_cents !== null) return inv.total_cents;
      const subtotal = invoiceSubtotal(inv);
      const tax = invoiceTax(inv);
      const tip = invoiceTip(inv);
      return subtotal + tax + tip;
    };
    const clone = (obj) => JSON.parse(JSON.stringify(obj));
    const csvEscape = (val) => {
      if (val === null || val === undefined) return '""';
      const str = String(val);
      const escaped = str.replace(/"/g, '""');
      return `"${escaped}"`;
    };
    const toCSV = (rows, columns) => {
      const header = columns.map(c => csvEscape(c.header)).join(',');
      const body = rows.map(row => columns.map(c => csvEscape(c.getter(row))).join(',')).join('\n');
      return [header, body].filter(Boolean).join('\n');
    };
    const parseCSV = (text) => {
      const rows = [];
      let current = '';
      let inQuotes = false;
      const pushCell = (arr, cell) => { arr.push(cell); };
      const pushRow = (arr) => { rows.push(arr); };
      let cells = [];
      for (let i = 0; i < text.length; i++) {
        const ch = text[i];
        if (ch === '"') {
          if (inQuotes && text[i + 1] === '"') {
            current += '"';
            i++;
          } else {
            inQuotes = !inQuotes;
          }
        } else if (ch === ',' && !inQuotes) {
          pushCell(cells, current);
          current = '';
        } else if ((ch === '\n' || ch === '\r') && !inQuotes) {
          if (ch === '\r' && text[i + 1] === '\n') i++;
          pushCell(cells, current);
          pushRow(cells);
          cells = [];
          current = '';
        } else {
          current += ch;
        }
      }
      pushCell(cells, current);
      if (cells.length) pushRow(cells);
      if (!rows.length) return [];
      const headers = rows.shift().map(h => h.trim());
      return rows.filter(r => r.some(c => (c || '').trim() !== '')).map(r => {
        const obj = {};
        headers.forEach((h, idx) => { obj[h] = (r[idx] || '').trim(); });
        return obj;
      });
    };
    const recordAudit = (entry, { save=true } = {}) => {
      if (!file) return;
      const logEntry = { ...entry, at: nowIso() };
      file.change_log.push(logEntry);
      if (file.change_log.length > 500) file.change_log = file.change_log.slice(-500);
      if (save) saveFile();
      return logEntry;
    };

    // ---------- Storage + State ----------
    const STORAGE = {
      v5List: 'ck5_businesses',
      v5Active: 'ck5_active',
      v5Data: (id) => `ck5_business_${id}`,
      v4List: 'checkmark_accounts',
      v4Active: 'checkmark_active_account',
      v4Data: (id) => `checkmark_account_data_${id}`,
      draftInvoice: (id) => `ck5_draft_invoice_${id}`,
      draftTxn: (id) => `ck5_draft_txn_${id}`
    };

    const seedAccounts = () => ([
      { code:'1000', name:'Cash', type:'asset' },
      { code:'1010', name:'Bank Checking', type:'asset' },
      { code:'1020', name:'Savings', type:'asset' },
      { code:'1030', name:'Undeposited Funds', type:'asset' },
      { code:'1100', name:'Accounts Receivable', type:'asset' },
      { code:'1500', name:'Equipment', type:'asset' },
      { code:'1590', name:'Accum Depreciation', type:'contra-asset' },
      { code:'2100', name:'Credit Card Payable', type:'liability' },
      { code:'2200', name:'Taxes Payable', type:'liability' },
      { code:'3000', name:'Owner Equity', type:'equity' },
      { code:'3100', name:'Owner Draws', type:'equity' },
      { code:'3200', name:'Opening Balance Equity', type:'equity' },
      { code:'4000', name:'Service Income', type:'income' },
      { code:'4010', name:'Production Income', type:'income' },
      { code:'4100', name:'Royalties', type:'income' },
      { code:'4200', name:'Licensing/Sync', type:'income' },
      { code:'4300', name:'Merchandise Sales', type:'income' },
      { code:'4900', name:'Other Income', type:'income' },
      { code:'6000', name:'Studio Rent', type:'expense' },
      { code:'6010', name:'Utilities', type:'expense' },
      { code:'6100', name:'Marketing', type:'expense' },
      { code:'6110', name:'Website/Hosting', type:'expense' },
      { code:'6200', name:'Contract Labor', type:'expense' },
      { code:'6300', name:'Travel', type:'expense' },
      { code:'6310', name:'Meals', type:'expense' },
      { code:'6400', name:'Bank Fees', type:'expense' },
      { code:'6410', name:'Payment Processing Fees', type:'expense' },
      { code:'6520', name:'Education/Training', type:'expense' },
      { code:'6600', name:'Depreciation Expense', type:'expense' },
      { code:'6700', name:'Mileage Expense', type:'expense' },
      { code:'6900', name:'Uncategorized Expense', type:'expense' },
      { code:'8000', name:'Suspense/Clearing', type:'other' },
      { code:'8100', name:'Transfers Clearing', type:'other' },
    ]);

    const DEFAULT_LOGO_LIGHT_URL = 'https://static.wixstatic.com/media/afbb39_617140a20fbb47b2b858c0d3ef28a4ef~mv2.png';
    const DEFAULT_LOGO_DARK_URL = 'https://static.wixstatic.com/media/afbb39_5d281518952249e58353d5e1d87b7514~mv2.png';

    const defaultSettings = () => ({
      accounting_basis: 'cash',
      theme: 'system',
      show_splash_video: true,
      logoVariant: 'auto',
      logoLightDataUrl: DEFAULT_LOGO_LIGHT_URL,
      logoDarkDataUrl: DEFAULT_LOGO_DARK_URL,
      headerImageDataUrl: null,
      headerImageFit: 'cover',
      headerImageOpacity: 10,
      default_cash_account_code: '1010',
      default_income_account_code: '4000',
      default_uncategorized_expense_code: '6900',
      mileage_model: 'tax_only',
      depreciation_model: 'report_only',
      default_tax_percent: 0,
      grt_percent: 0,
      grt_basis: 'invoices',
      grt_filing_frequency: 'monthly'
    });

    const newBusinessFile = (name='My Business') => ({
      schema_version: 5,
      business: {
        business_id: uuid(),
        name,
        base_currency: 'USD',
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC',
        created_at: nowIso(),
        updated_at: nowIso()
      },
      settings: defaultSettings(),
      parties: [],
      projects: [],
      services: [],
      accounts: seedAccounts(),
      invoices: [],
      invoice_lines: [],
      payments: [],
      payment_applications: [],
      transactions: [],
      assets: [],
      depreciation_events: [],
      mileage_trips: [],
      ledger_entries: [],
      ledger_lines: [],
      attachments: [],
      notes: [],
      change_log: []
    });

    let businessList = [];
    let activeId = null;
    let file = null;
    let undoStack = [];
    let deleteBusinessBtn = null;

    const saveList = () => localStorage.setItem(STORAGE.v5List, JSON.stringify(businessList));
    const saveActive = () => activeId ? localStorage.setItem(STORAGE.v5Active, activeId) : localStorage.removeItem(STORAGE.v5Active);
    const loadList = () => {
      // #region agent log
      logDebug('loadList:entry','loadList called',{},'D');
      // #endregion
      try {
        businessList = JSON.parse(localStorage.getItem(STORAGE.v5List) || '[]');
        activeId = localStorage.getItem(STORAGE.v5Active);
        // #region agent log
        logDebug('loadList:success','Business list loaded',{count:businessList.length,activeId},'D');
        // #endregion
      } catch(e) {
        // #region agent log
        logDebug('loadList:error','Error loading business list',{error:e.message},'D');
        // #endregion
        throw e;
      }
    };
    const migrateProjectPartyIds = (file) => {
      // Migrate projects from party_id to party_ids array for backward compatibility
      if (file && file.projects) {
        file.projects.forEach(pr => {
          if (pr.party_id && !pr.party_ids) {
            pr.party_ids = [pr.party_id];
            delete pr.party_id;
          } else if (!pr.party_ids) {
            pr.party_ids = [];
          }
        });
      }
      return file;
    };

    const loadFile = (id) => {
      const raw = localStorage.getItem(STORAGE.v5Data(id));
      if (!raw) return null;
      try {
        const loaded = JSON.parse(raw);
        return migrateProjectPartyIds(loaded);
      } catch { return null; }
    };
    const saveFile = () => {
      if (!file) return;
      file.business.updated_at = nowIso();
      localStorage.setItem(STORAGE.v5Data(activeId), JSON.stringify(file));
      showSaved();
    };

    const ensureFile = () => {
      if (!file) return;
      if (!file.accounts || file.accounts.length === 0) file.accounts = seedAccounts();
      if (!file.settings) file.settings = defaultSettings();
      if (!file.settings.logoLightDataUrl) file.settings.logoLightDataUrl = DEFAULT_LOGO_LIGHT_URL;
      if (!file.settings.logoDarkDataUrl) file.settings.logoDarkDataUrl = DEFAULT_LOGO_DARK_URL;
      if (!file.notes) file.notes = [];
      if (file.settings.default_tax_percent === undefined || file.settings.default_tax_percent === null) file.settings.default_tax_percent = 0;
      if (file.settings.grt_percent === undefined || file.settings.grt_percent === null) file.settings.grt_percent = 0;
      if (!file.settings.grt_basis) file.settings.grt_basis = 'invoices';
      if (!file.settings.grt_filing_frequency) file.settings.grt_filing_frequency = 'monthly';
      migrateProjectPartyIds(file);
    };

    // ---------- Theme / Logo ----------
    const applyTheme = () => {
      const theme = file?.settings?.theme || 'system';
      const motion = 'full';
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const dark = theme === 'dark' || (theme === 'system' && prefersDark);
      document.documentElement.classList.toggle('dark', dark);
      document.documentElement.classList.toggle('motion-off', false);
      document.documentElement.classList.toggle('motion-reduced', false);
      const scale = 1;
      document.documentElement.style.setProperty('--motion-scale', scale);
      const logoVariant = file?.settings?.logoVariant || 'auto';
      const lightLogo = file?.settings?.logoLightDataUrl || DEFAULT_LOGO_LIGHT_URL;
      const darkLogo = file?.settings?.logoDarkDataUrl || DEFAULT_LOGO_DARK_URL;
      const logoEl = $('#logo-img');
      const chip = $('#logo-chip');
      chip.style.background = 'var(--logo-bg)';
      let useLogo = lightLogo || darkLogo || '';
      if (logoVariant === 'light') useLogo = lightLogo || darkLogo || '';
      else if (logoVariant === 'dark') useLogo = darkLogo || lightLogo || '';
      else useLogo = dark ? (darkLogo || lightLogo || '') : (lightLogo || darkLogo || '');
      if (!useLogo) {
        logoEl.src = '';
        logoEl.alt = 'CK';
        logoEl.textContent = 'CK';
      } else {
        logoEl.src = useLogo;
      }
      // Apply custom header image
      const headerImage = file?.settings?.headerImageDataUrl;
      const headerImgEl = $('#custom-header-image');
      if (headerImgEl) {
        if (headerImage) {
          headerImgEl.src = headerImage;
          headerImgEl.style.display = 'block';
          const fit = file?.settings?.headerImageFit || 'cover';
          const opacity = (file?.settings?.headerImageOpacity || 10) / 100;
          headerImgEl.style.objectFit = fit;
          headerImgEl.style.opacity = opacity;
        } else {
          headerImgEl.src = '';
          headerImgEl.style.display = 'none';
        }
      }
    };

    const showSaved = () => {
      const flag = $('#saved-flag');
      flag.textContent = 'Saved';
      flag.style.opacity = '1';
      setTimeout(() => flag.style.opacity = '0.6', 1200);
    };

    // ---------- Migration from V4 ----------
    const detectV4 = () => {
      const list = JSON.parse(localStorage.getItem(STORAGE.v4List) || '[]');
      return list.length > 0;
    };

    const migrateV4Business = (v4Id, v4DataRaw) => {
      const v4 = v4DataRaw || {};
      const bf = newBusinessFile(v4.settings?.businessName || 'Migrated Business');
      bf.business.legacy_id = v4Id;
      bf.settings.logoLightDataUrl = v4.settings?.logoLight || null;
      bf.settings.logoDarkDataUrl = v4.settings?.logoDark || null;
      if (v4.settings?.theme) bf.settings.theme = v4.settings.theme;
      // Parties
      (v4.clients || []).forEach(c => bf.parties.push({
        party_id: uuid(),
        legacy_id: c.id,
        name: c.name || '',
        email: c.email || '',
        phone: c.phone || '',
        address: c.address || '',
        created_at: nowIso(),
        updated_at: nowIso()
      }));
      // Services
      (v4.templates || []).forEach(s => bf.services.push({
        service_id: uuid(),
        legacy_id: s.id,
        name: s.name || '',
        default_rate_cents: moneyToCents(s.price || 0),
        default_description: s.name || '',
        billing_type: 'flat',
        created_at: nowIso(),
        updated_at: nowIso()
      }));
      // Invoices + lines
      (v4.invoices || []).forEach(inv => {
        const invoiceId = uuid();
        bf.invoices.push({
          invoice_id: invoiceId,
          legacy_id: inv.id,
          party_id: (bf.parties.find(p => p.legacy_id == inv.clientId)||{}).party_id || null,
          number: inv.number,
          issue_date: inv.date,
          status: inv.status?.toLowerCase() || 'draft',
          subtotal_cents: moneyToCents(inv.total || 0),
          tax_cents: 0,
          tax_percent: 0,
          total_cents: moneyToCents(inv.total || 0),
          created_at: nowIso(),
          updated_at: nowIso()
        });
        (inv.items || []).forEach(it => {
          bf.invoice_lines.push({
            invoice_line_id: uuid(),
            invoice_id: invoiceId,
            service_name: it.desc,
            quantity: Number(it.qty) || 0,
            rate_cents: moneyToCents(it.price || 0),
            line_total_cents: moneyToCents((Number(it.qty)||0)*(Number(it.price)||0)),
            income_account_code: bf.settings.default_income_account_code,
            created_at: nowIso(),
            updated_at: nowIso()
          });
        });
        if (inv.status === 'Paid') {
          // warn: V4 lacks payment detail; no ledger posting here
          bf.change_log.push({ type:'warn', message:'Paid invoice without payment detail from V4', ref: invoiceId, created_at: nowIso() });
        }
      });
      // Transactions -> ledger + txn
      (v4.transactions || []).forEach(t => {
        const txnId = uuid();
        const amountCents = moneyToCents(t.amount || 0);
        const type = (t.type || '').toLowerCase();
        const category = t.category || '';
        bf.transactions.push({
          transaction_id: txnId,
          legacy_id: t.id,
          date: t.date,
          memo: t.desc || '',
          amount_cents: amountCents,
          type: type === 'income' ? 'income' : (type === 'expense' ? 'expense' : 'transfer'),
          category: category,
          created_at: nowIso(),
          updated_at: nowIso()
        });
        const entryId = uuid();
        const debitAccount = type === 'income' ? bf.settings.default_cash_account_code
                          : type === 'transfer' ? '8000'
                          : bf.settings.default_uncategorized_expense_code;
        const creditAccount = type === 'income' ? (bf.settings.default_income_account_code)
                           : type === 'transfer' ? bf.settings.default_cash_account_code
                           : bf.settings.default_cash_account_code;
        const sign = type === 'income' ? 1 : -1;
        const amount = Math.abs(amountCents);
        bf.ledger_entries.push({
          ledger_entry_id: entryId,
          source: 'migration',
          linked_transaction_id: txnId,
          status: 'posted',
          entry_type: 'transaction',
          entry_date: t.date,
          created_at: nowIso(),
          updated_at: nowIso()
        });
        bf.ledger_lines.push({ ledger_line_id: uuid(), ledger_entry_id: entryId, account_code: debitAccount, debit_cents: sign>0?amount:0, credit_cents: sign<0?amount:0 });
        bf.ledger_lines.push({ ledger_line_id: uuid(), ledger_entry_id: entryId, account_code: creditAccount, debit_cents: sign<0?amount:0, credit_cents: sign>0?amount:0 });
      });
      ensureFile();
      return bf;
    };

    const runMigration = () => {
      const v4List = JSON.parse(localStorage.getItem(STORAGE.v4List) || '[]');
      if (!v4List.length) return;
      v4List.forEach(acc => {
        const data = JSON.parse(localStorage.getItem(STORAGE.v4Data(acc.id)) || '{}');
        const migrated = migrateV4Business(acc.id, data);
        const id = migrated.business.business_id;
        businessList.push({ id, name: migrated.business.name });
        localStorage.setItem(STORAGE.v5Data(id), JSON.stringify(migrated));
      });
      saveList();
      localStorage.removeItem(STORAGE.v4Active);
      alert('Migration complete. Select a migrated business to continue.');
      renderBusinessSelector();
      renderMigrationBlock();
    };

    // ---------- Ledger Engine ----------
    const requireBalanced = (lines) => {
      const debits = lines.reduce((s,l)=>s+(l.debit_cents||0),0);
      const credits = lines.reduce((s,l)=>s+(l.credit_cents||0),0);
      if (debits !== credits) throw new Error('Entry not balanced');
    };

    const removeLinkedEntries = ({ transaction_id=null, payment_id=null }) => {
      // #region agent log
      fetch('http://127.0.0.1:7242/ingest/251e5d6a-3d5b-41b3-b796-d6cf2eef1b0c',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'Checkmark Accountant V5.html:removeLinkedEntries',message:'removeLinkedEntries:entry',data:{transaction_id,payment_id,ledgerEntries:file.ledger_entries.length,ledgerLines:file.ledger_lines.length},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
      // #endregion
      if (!transaction_id && !payment_id) return;
      const keepIds = [];
      file.ledger_entries = file.ledger_entries.filter(e=>{
        const match = (transaction_id && e.linked_transaction_id===transaction_id) || (payment_id && e.linked_payment_id===payment_id);
        if (match) return false;
        keepIds.push(e.ledger_entry_id);
        return true;
      });
      file.ledger_lines = file.ledger_lines.filter(l => keepIds.includes(l.ledger_entry_id) || (!transaction_id && !payment_id));
      // #region agent log
      fetch('http://127.0.0.1:7242/ingest/251e5d6a-3d5b-41b3-b796-d6cf2eef1b0c',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'Checkmark Accountant V5.html:removeLinkedEntries',message:'removeLinkedEntries:after',data:{transaction_id,payment_id,ledgerEntries:file.ledger_entries.length,ledgerLines:file.ledger_lines.length},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
      // #endregion
    };

    const postEntry = (entry) => {
      requireBalanced(entry.lines);
      const entryId = uuid();
      file.ledger_entries.push({
        ledger_entry_id: entryId,
        entry_type: entry.type,
        entry_date: entry.date || today(),
        status: 'posted',
        source: entry.source || 'ui',
        project_id: entry.project_id || null,
        linked_invoice_id: entry.linked_invoice_id || null,
        linked_payment_id: entry.linked_payment_id || null,
        linked_transaction_id: entry.linked_transaction_id || null,
        created_at: nowIso(),
        updated_at: nowIso()
      });
      entry.lines.forEach(l => file.ledger_lines.push({
        ledger_line_id: uuid(),
        ledger_entry_id: entryId,
        account_code: l.account,
        debit_cents: l.debit || 0,
        credit_cents: l.credit || 0
      }));
    };

    const postTransaction = (txn) => {
      removeLinkedEntries({ transaction_id: txn.transaction_id });
      const cash = file.settings.default_cash_account_code;
      const income = file.settings.default_income_account_code;
      const uncat = file.settings.default_uncategorized_expense_code;
      const amt = Math.abs(txn.amount_cents);
      if (txn.type === 'income') {
        postEntry({ type:'transaction.income', date: txn.date, linked_transaction_id: txn.transaction_id, project_id: txn.project_id, lines:[
          { account: cash, debit: amt },
          { account: income, credit: amt }
        ]});
      } else if (txn.type === 'expense') {
        const expAcct = findAccountCode(txn.category) || uncat;
        postEntry({ type:'transaction.expense', date: txn.date, linked_transaction_id: txn.transaction_id, project_id: txn.project_id, lines:[
          { account: expAcct, debit: amt },
          { account: cash, credit: amt }
        ]});
      } else if (txn.type === 'transfer') {
        // For transfers, use category field to parse account codes if provided
        // Format: "from_code - to_code" or just use category as the target account
        const category = txn.category || '';
        const parts = category.split(' - ');
        const toAcct = findAccountCode(parts[parts.length - 1]) || findAccountCode(category) || cash;
        const fromAcct = findAccountCode(parts[0]) || cash;
        postEntry({ type:'transaction.transfer', date: txn.date, linked_transaction_id: txn.transaction_id, project_id: txn.project_id, lines:[
          { account: toAcct, debit: amt },
          { account: fromAcct, credit: amt }
        ]});
      }
    };

    const postInvoicePayment = (invoice, payment) => {
      removeLinkedEntries({ payment_id: payment.payment_id });
      const income = file.settings.default_income_account_code;
      const deposit = payment.deposit_account_code || file.settings.default_cash_account_code;
      const amount = payment.amount_cents;
      postEntry({ type:'invoice.pay', date: payment.payment_date, linked_invoice_id: invoice.invoice_id, linked_payment_id: payment.payment_id, project_id: invoice.project_id, lines:[
        { account: deposit, debit: amount },
        { account: income, credit: amount }
      ]});
    };

    const findAccountCode = (codeOrName) => {
      if (!codeOrName) return null;
      // Handle "code - name" format from datalist
      const parts = String(codeOrName).split(' - ');
      const code = parts[0].trim();
      const name = parts.length > 1 ? parts.slice(1).join(' - ').trim() : null;
      const acc = file.accounts.find(a => a.code === code || a.code === codeOrName || a.name === codeOrName || (name && a.name === name));
      return acc ? acc.code : null;
    };

    // ---------- UI helpers ----------
    const setTab = (tab) => {
      $$('nav.tabs button').forEach(btn => btn.classList.toggle('active', btn.dataset.tab === tab));
      $$('section[data-section]').forEach(sec => sec.classList.toggle('hidden', sec.dataset.section !== tab));
      if (tab === 'dashboard' && file) {
        cleanOrphanLedgerEntries();
        renderDashboard();
      }
      if (tab === 'analytics' && file) {
        setTimeout(() => {
          // Initialize date inputs if not already set
          const startInput = $('#analytics-start');
          const endInput = $('#analytics-end');
          if (startInput && !startInput.value) {
            setDatePreset('all', 'analytics');
          } else if (startInput && endInput) {
            // If dates are set, just render
            renderAnalytics();
          } else {
            setDatePreset('all', 'analytics');
            renderAnalytics();
          }
        }, 100);
      }
      if (tab === 'reports' && file) {
        setTimeout(() => {
          setDatePreset('all', 'reports');
          refreshReports();
        }, 100);
      }
      if (tab === 'settings') {
        runIntegrity();
      }
    };

    const showSplashVideo = () => {
      const overlay = $('#splash-overlay');
      const video = $('#splash-video');
      if (!overlay || !video) return;
      const close = () => {
        overlay.classList.add('fade-out');
        setTimeout(() => {
          overlay.classList.add('hidden');
          overlay.classList.remove('fade-out');
          video.pause();
          video.currentTime = 0;
        }, 220);
      };
      overlay.classList.remove('hidden');
      overlay.classList.remove('fade-out');
      overlay.onclick = (e) => { if (e.target === overlay) close(); };
      video.onclick = (e) => {
        e.stopPropagation();
        if (video.paused) video.play();
        video.muted = !video.muted;
      };
      video.onended = close;
      video.muted = false;
      const playAttempt = video.play();
      if (playAttempt && typeof playAttempt.catch === 'function') {
        playAttempt.catch(() => {
          video.muted = true;
          video.play();
        });
      }
    };

    const openPanel = (title, bodyHtml) => {
      $('#panel-title').textContent = title;
      $('#panel-body').innerHTML = bodyHtml;
      $('#side-panel').classList.add('open');
    };
    const closePanel = () => $('#side-panel').classList.remove('open');

    const showToast = (msg, undoFn=null) => {
      $('#toast-msg').textContent = msg;
      const undoBtn = $('#toast-undo');
      if (undoFn) {
        undoBtn.classList.remove('hidden');
        undoBtn.onclick = () => { undoFn(); hideToast(); };
      } else undoBtn.classList.add('hidden');
      $('#toast').classList.add('show');
      setTimeout(() => hideToast(), 4000);
    };
    const hideToast = () => $('#toast').classList.remove('show');

    const showModal = (html, onConfirm) => {
      $('#modal-body').innerHTML = html;
      $('#modal-overlay').classList.add('show');
      const confirmBtn = $('#modal-body').querySelector('[data-confirm]');
      const cancelBtn = $('#modal-body').querySelector('[data-cancel]');
      if (cancelBtn) cancelBtn.onclick = closeModal;
      if (confirmBtn) confirmBtn.onclick = () => { onConfirm(); closeModal(); };
    };
    const closeModal = () => $('#modal-overlay').classList.remove('show');

    // ---------- Business selector ----------
    const renderBusinessSelector = () => {
      const sel = $('#business-selector');
      if (!sel) return;
      sel.innerHTML = '';
      businessList.forEach(b => {
        const opt = document.createElement('option');
        opt.value = b.id; opt.textContent = b.name;
        if (b.id === activeId) opt.selected = true;
        sel.appendChild(opt);
      });
      if (!businessList.length) {
        const opt = document.createElement('option');
        opt.textContent = 'No business yet';
        sel.appendChild(opt);
      }
      const businessName = $('#business-name');
      if (businessName) businessName.textContent = activeId ? (businessList.find(b=>b.id===activeId)?.name || 'Business') : 'Checkmark Accountant V5';
    };

    const createBusiness = (name) => {
      const id = uuid();
      businessList.push({ id, name });
      saveList();
      localStorage.setItem(STORAGE.v5Data(id), JSON.stringify(newBusinessFile(name)));
      activeId = id; saveActive();
      loadActive();
    };

    const deleteBusiness = (id) => {
      if (!id) return;
      const business = businessList.find(b => b.id === id);
      if (!business) return;
      
      showModal(`
        <div class="stack">
          <h3>Delete Business</h3>
          <p><strong>Warning:</strong> This will permanently delete "${business.name}" and all its data.</p>
          <p>This action cannot be undone.</p>
          <div class="row" style="justify-content:flex-end; gap:8px">
            <button data-cancel>Cancel</button>
            <button data-confirm class="primary" style="background:var(--danger)">Delete Business</button>
          </div>
        </div>
      `, () => {
        // Remove from list
        businessList = businessList.filter(b => b.id !== id);
        saveList();
        
        // Remove data from localStorage
        localStorage.removeItem(STORAGE.v5Data(id));
        
        // If this was the active business, switch to another or clear
        if (activeId === id) {
          if (businessList.length > 0) {
            activeId = businessList[0].id;
            saveActive();
            loadActive();
          } else {
            activeId = null;
            saveActive();
            file = null;
            renderBusinessSelector();
            renderAll();
          }
        } else {
          renderBusinessSelector();
        }
        
        showToast(`Business "${business.name}" deleted`);
      });
    };

    const loadActive = () => {
      // #region agent log
      logDebug('loadActive:entry','loadActive called',{activeId,businessListLength:businessList.length},'E');
      // #endregion
      if (!activeId && businessList.length) activeId = businessList[0].id;
      if (!activeId) {
        // #region agent log
        logDebug('loadActive:early-return','No activeId and no businessList',{},'E');
        // #endregion
        // Prompt to create a business if none exists
        promptCreateBusinessIfNeeded();
        return;
      }
      file = loadFile(activeId);
      if (!file) { file = newBusinessFile('New Business'); saveFile(); }
      ensureFile();
      cleanOrphanLedgerEntries();
      if (renumberInvoices()) saveFile();
      // #region agent log
      fetch('http://127.0.0.1:7242/ingest/251e5d6a-3d5b-41b3-b796-d6cf2eef1b0c',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'Checkmark Accountant V5.html:loadActive',message:'loadActive:file-loaded',data:{transactions:file.transactions.length,ledgerEntries:file.ledger_entries.length,ledgerLines:file.ledger_lines.length},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'B'})}).catch(()=>{});
      // #endregion
      renderBusinessSelector();
      applyTheme();
      // #region agent log
      logDebug('loadActive:before-renderAll','About to call renderAll',{fileExists:!!file},'E');
      // #endregion
      renderAll();
      // #region agent log
      logDebug('loadActive:after-renderAll','renderAll completed',{},'E');
      // #endregion
      setTab('dashboard');
      // #region agent log
      logDebug('loadActive:complete','loadActive completed',{},'E');
      // #endregion
    };

    const promptCreateBusinessIfNeeded = () => {
      if (businessList.length > 0) return; // Don't prompt if businesses exist
      
      showModal(`
        <div class="stack">
          <h3>Welcome to Checkmark Accountant V5</h3>
          <p>You don't have any businesses yet. Create your first business to get started.</p>
          <label>Business Name</label>
          <input type="text" id="new-business-name" placeholder="My Business" value="My Business" autofocus>
          <div class="row" style="justify-content:flex-end; gap:8px; margin-top:16px">
            <button data-cancel>Cancel</button>
            <button data-confirm class="primary">Create Business</button>
          </div>
        </div>
      `, () => {
        const nameInput = $('#new-business-name');
        const name = nameInput?.value?.trim() || 'My Business';
        createBusiness(name);
        closeModal();
      });
      
      // Auto-focus and allow Enter key to submit
      setTimeout(() => {
        const nameInput = $('#new-business-name');
        if (nameInput) {
          nameInput.focus();
          nameInput.select();
          nameInput.onkeydown = (e) => {
            if (e.key === 'Enter') {
              const confirmBtn = $('#modal-body').querySelector('[data-confirm]');
              if (confirmBtn) confirmBtn.click();
            }
          };
        }
      }, 100);
    };

    const normalizeSearchValue = (value) => String(value || '').toLowerCase();
    const matchesSearch = (value, query) => normalizeSearchValue(value).includes(query);

    // ---------- Invoices ----------
    const getNextInvoiceNumber = () => {
      if (!file?.invoices?.length) return 1;
      const numbers = file.invoices
        .map(inv => Number(inv.number))
        .filter(n => Number.isFinite(n));
      const maxNumber = numbers.length ? Math.max(...numbers) : file.invoices.length;
      return maxNumber + 1;
    };

    const renumberInvoices = () => {
      if (!file?.invoices?.length) return false;
      const sorted = [...file.invoices].sort((a, b) => {
        const issueA = a.issue_date || '9999-12-31';
        const issueB = b.issue_date || '9999-12-31';
        if (issueA !== issueB) return issueA.localeCompare(issueB);
        const createdA = a.created_at || '9999-12-31T23:59:59.999Z';
        const createdB = b.created_at || '9999-12-31T23:59:59.999Z';
        if (createdA !== createdB) return createdA.localeCompare(createdB);
        const legacyA = Number.isFinite(Number(a.legacy_id)) ? Number(a.legacy_id) : Number.MAX_SAFE_INTEGER;
        const legacyB = Number.isFinite(Number(b.legacy_id)) ? Number(b.legacy_id) : Number.MAX_SAFE_INTEGER;
        if (legacyA !== legacyB) return legacyA - legacyB;
        return String(a.invoice_id || '').localeCompare(String(b.invoice_id || ''));
      });
      let changed = false;
      sorted.forEach((inv, index) => {
        const nextNumber = index + 1;
        if (inv.number !== nextNumber) {
          inv.number = nextNumber;
          changed = true;
        }
      });
      const orderChanged = sorted.some((inv, index) => inv.invoice_id !== file.invoices[index]?.invoice_id);
      if (orderChanged) {
        file.invoices = sorted;
        changed = true;
      }
      return changed;
    };

    const renderInvoices = () => {
      if (!file) return;
      const tbody = $('#invoice-rows'); tbody.innerHTML = '';
      const searchQuery = normalizeSearchValue($('#invoice-search')?.value).trim();
      const rows = file.invoices.filter(inv => {
        if (!searchQuery) return true;
        const party = file.parties.find(p => p.party_id === inv.party_id);
        return matchesSearch(party?.name, searchQuery) || matchesSearch(inv.issue_date, searchQuery);
      });
      if (!file.invoices.length) $('#invoice-empty').classList.remove('hidden'); else $('#invoice-empty').classList.add('hidden');
      if (file.invoices.length && !rows.length) $('#invoice-empty-filter')?.classList.remove('hidden'); else $('#invoice-empty-filter')?.classList.add('hidden');
      rows.forEach(inv => {
        const party = file.parties.find(p => p.party_id === inv.party_id);
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHtml(inv.number||'')}</td><td>${escapeHtml(party?.name||'')}</td><td>${escapeHtml(inv.issue_date||'')}</td>
        <td><span class="status-dot ${inv.status==='paid'?'status-posted':inv.status==='void'?'status-void':'status-draft'}"></span> ${escapeHtml(inv.status||'draft')}</td>
        <td>${fmt(invoiceTotal(inv),file.business.base_currency)}</td>
        <td class="row">
          <button data-action="view">View</button>
          <button data-action="pay">Mark Paid</button>
          <button data-action="edit">Edit</button>
          <button data-action="void">Void</button>
          <button data-action="del">Delete</button>
        </td>`;
        tr.querySelector('[data-action="view"]').onclick = () => viewInvoice(inv);
        tr.querySelector('[data-action="edit"]').onclick = () => editInvoice(inv);
        tr.querySelector('[data-action="del"]').onclick = () => deleteInvoice(inv);
        tr.querySelector('[data-action="pay"]').onclick = () => promptMarkPaid(inv);
        tr.querySelector('[data-action="void"]').onclick = () => voidInvoice(inv);
        tbody.appendChild(tr);
      });
    };

    const renderInvoiceDraft = () => {
      if (!file) return;
      const container = $('#invoice-draft');
      if (!container) return;
      const draft = JSON.parse(localStorage.getItem(STORAGE.draftInvoice(activeId)) || 'null');
      if (!draft) { container.innerHTML = '<div class="empty">No draft saved.</div>'; return; }
      container.innerHTML = `
        <div class="stack">
          <div><strong>Client:</strong> ${escapeHtml(draft.party_name||'')}</div>
          <div><strong>Date:</strong> ${escapeHtml(draft.issue_date||today())}</div>
          <div><strong>Total:</strong> ${fmt(invoiceTotal(draft),file.business.base_currency)}</div>
          <button id="resume-draft">Resume</button>
        </div>`;
      const resumeBtn = $('#resume-draft');
      if (resumeBtn) resumeBtn.onclick = () => editInvoice(draft, true);
    };

    const sortPartiesByName = (parties = []) => (
      [...parties].sort((a, b) => (a.name || '').localeCompare(b.name || '', undefined, { numeric: true, sensitivity: 'base' }))
    );

    const invoiceForm = (inv={}) => {
      const partyOptions = sortPartiesByName(file.parties)
        .map(p=>`<option value="${escapeHtml(p.party_id)}" ${p.party_id===inv.party_id?'selected':''}>${escapeHtml(p.name)}</option>`)
        .join('');
      const serviceRecent = file.services.slice(-3).reverse();
      const lines = inv.lines || [];
      const lineItems = lines.map(l => lineRow(l)).join('');
      const taxPercentDefault = inv.tax_percent ?? file.settings.default_tax_percent ?? 0;
      const taxPercentDisplay = trimTrailingZeros((Number(taxPercentDefault)||0).toFixed(2));
      const subtotalFromLines = lines.length ? lines.reduce((s,l)=>s+(l.line_total_cents||0),0) : null;
      const subtotalCents = subtotalFromLines ?? inv.subtotal_cents ?? inv.total_cents ?? 0;
      const taxCents = inv.tax_cents ?? Math.round(subtotalCents * ((Number(taxPercentDefault)||0)/100));
      const tipCents = inv.tip_cents ?? 0;
      const totalCents = inv.total_cents ?? (subtotalCents + taxCents + tipCents);
      const selectedPartyId = inv.party_id || null;
      const filteredProjects = selectedPartyId ? file.projects.filter(p=>{
        // Handle backward compatibility: convert party_id to party_ids array
        const partyIds = p.party_ids || (p.party_id ? [p.party_id] : []);
        return partyIds.includes(selectedPartyId);
      }) : [];
      return `
        <form id="invoice-form" class="stack">
          <label>Client</label>
          <select name="party_id">${partyOptions}</select>
          <label>Date</label>
          <input name="issue_date" type="date" value="${inv.issue_date||today()}">
          <label>Project</label>
          <select name="project_id"><option value="">None</option>${filteredProjects.map(p=>`<option value="${escapeHtml(p.project_id)}" ${p.project_id===inv.project_id?'selected':''}>${escapeHtml(p.name)}</option>`).join('')}</select>
          <div class="row" style="gap:8px; flex-wrap:wrap">
            <span class="muted">Recent services:</span>
            ${serviceRecent.map(s=>`<button type="button" class="recent-chip" data-service="${escapeHtml(s.service_id)}">${escapeHtml(s.name)}</button>`).join('')}
            <button type="button" class="ghost" id="add-service-inline">+ Add new</button>
          </div>
          <div id="line-container" class="stack">${lineItems || ''}</div>
          <div class="row" style="justify-content:space-between"><div>Subtotal</div><div id="inv-subtotal">${fmt(subtotalCents,file.business.base_currency)}</div></div>
          <label>Tax %</label>
          <input name="tax_percent" id="tax-percent" type="number" step="0.01" min="0" value="${taxPercentDisplay}">
          <div class="row" style="justify-content:space-between"><div>Tax <span class="muted" id="tax-percent-display">(${taxPercentDisplay || '0'}%)</span></div><div id="inv-tax">${fmt(taxCents,file.business.base_currency)}</div></div>
          <label>Tip</label>
          <input name="tip_amount" id="tip-amount" type="number" step="0.01" min="0" value="${centsToMoney(tipCents)}">
          <div class="row" style="justify-content:space-between"><div>Tip</div><div id="inv-tip">${fmt(tipCents,file.business.base_currency)}</div></div>
          <div class="row" style="justify-content:space-between"><div>Total</div><div id="inv-total">${fmt(totalCents,file.business.base_currency)}</div></div>
          <div class="row">
            <button class="primary" type="submit">Save</button>
            <button type="button" id="cancel-invoice">Cancel</button>
          </div>
        </form>`;
    };

    const lineRow = (line) => {
      const billing = line.billing_type || 'flat';
      const qtyValRaw = (line.quantity !== undefined && line.quantity !== null) ? line.quantity : (line.time_minutes ? line.time_minutes/60 : 1);
      const qtyVal = trimTrailingZeros((Number(qtyValRaw)||0).toFixed(2)) || (qtyValRaw ?? 1);
      const timeVal = billing === 'hourly' ? minutesToTimeString(line.time_minutes ?? Math.round((Number(qtyVal)||0)*60)) : '';
      const timeNote = billing === 'hourly'
        ? (Number(qtyVal) ? `= ${trimTrailingZeros((Number(qtyVal)||0).toFixed(2))} hrs` : 'Enter hh:mm to convert')
        : '';
      return `<div class="card" data-line="${escapeHtml(line.invoice_line_id||uuid())}" data-billing="${billing}" style="padding:20px; box-shadow:none; margin-bottom:12px">
        <div class="row" style="gap:8px; align-items:center">
          <input class="line-name" placeholder="Service / Description" value="${escapeHtml(line.service_name||'')}">
          <input class="line-qty" type="number" step="0.01" value="${escapeHtml(qtyVal)}" style="width:90px" title="${billing==='hourly'?'Hours':'Quantity'}">
          <input class="line-rate" type="number" step="0.01" value="${centsToMoney(line.rate_cents||0)}" style="width:110px">
          <button type="button" data-remove>Delete</button>
        </div>
        ${billing==='hourly'?`<div class="row" style="gap:8px; align-items:center; margin-top:8px">
          <label style="margin:0; font-size:0.9rem; color: var(--muted); min-width:110px;">Time (HH:MM)</label>
          <input class="line-time" placeholder="1:30" value="${escapeHtml(timeVal||'')}" style="width:120px">
          <span class="muted" data-time-note style="font-size:0.9rem;">${escapeHtml(timeNote)}</span>
        </div>`:''}
      </div>`;
    };

    const editInvoice = (inv, isDraft=false) => {
      if (!file) return;
      const invoice = isDraft ? inv : {
        invoice_id: inv.invoice_id || uuid(),
        party_id: inv.party_id || (file.parties[0]?.party_id || null),
        project_id: inv.project_id || null,
        issue_date: inv.issue_date || today(),
        status: inv.status || 'draft',
        tax_percent: inv.tax_percent ?? (inv.invoice_id ? 0 : (file.settings.default_tax_percent ?? 0)),
        tax_cents: inv.tax_cents ?? null,
        subtotal_cents: inv.subtotal_cents ?? null,
        tip_cents: inv.tip_cents ?? 0,
        total_cents: inv.total_cents ?? null,
        lines: (file.invoice_lines.filter(l=>l.invoice_id===inv.invoice_id).map(clone)) || []
      };
      openPanel('Invoice', invoiceForm(invoice));
      const container = $('#line-container');
      const form = $('#invoice-form');
      const recents = form.querySelectorAll('.recent-chip');
      recents.forEach(btn => btn.onclick = () => {
        const svc = file.services.find(s=>s.service_id===btn.dataset.service);
        if (svc) addLineFromService(container, svc);
      });
      $('#add-service-inline').onclick = () => {
        showServiceInline(container);
      };
      form.addEventListener('input', () => updateInvoiceTotal(container));
      const syncLineTime = (div, { fromQty=false } = {}) => {
        if (!div || (div.dataset.billing||'flat') !== 'hourly') return;
        const qtyInput = div.querySelector('.line-qty');
        const timeInput = div.querySelector('.line-time');
        const note = div.querySelector('[data-time-note]');
        if (!qtyInput || !timeInput) return;
        if (!fromQty) {
          const normalized = normalizeTimeInput(timeInput.value);
          if (normalized !== timeInput.value) timeInput.value = normalized;
          const mins = parseTimeToMinutes(normalized);
          if (mins !== null) {
            const hours = mins/60;
            qtyInput.value = trimTrailingZeros(hours.toFixed(2)) || '0';
          }
        } else if (!timeInput.value) {
          const minsFromQty = Math.round((Number(qtyInput.value)||0)*60);
          if (minsFromQty>0) timeInput.value = minutesToTimeString(minsFromQty);
        }
        if (note) {
          const qty = Number(qtyInput.value)||0;
          note.textContent = qty ? `= ${trimTrailingZeros(qty.toFixed(2))} hrs` : 'Enter hh:mm to convert';
        }
      };
      container.addEventListener('input', (e) => {
        const target = e.target;
        const div = target.closest('[data-line]');
        if (!div) return;
        if (target.classList.contains('line-time')) {
          const normalized = normalizeTimeInput(target.value);
          if (normalized !== target.value) target.value = normalized;
          syncLineTime(div);
          updateInvoiceTotal(container);
        }
        if (target.classList.contains('line-qty')) {
          syncLineTime(div, { fromQty:true });
          updateInvoiceTotal(container);
        }
        if (target.classList.contains('line-rate')) {
          updateInvoiceTotal(container);
        }
      });
      container.querySelectorAll('[data-line]').forEach(div => syncLineTime(div, { fromQty:true }));
      // Update project dropdown when client changes
      const partySelect = form.querySelector('[name="party_id"]');
      const projectSelect = form.querySelector('[name="project_id"]');
      const currentProjectId = invoice.project_id;
      partySelect.addEventListener('change', () => {
        const selectedPartyId = partySelect.value;
        const filteredProjects = selectedPartyId ? file.projects.filter(p=>{
          // Handle backward compatibility: convert party_id to party_ids array
          const partyIds = p.party_ids || (p.party_id ? [p.party_id] : []);
          return partyIds.includes(selectedPartyId);
        }) : [];
        projectSelect.innerHTML = '<option value="">None</option>' + filteredProjects.map(p=>`<option value="${escapeHtml(p.project_id)}">${escapeHtml(p.name)}</option>`).join('');
        // Try to preserve the current project if it's still valid
        if (currentProjectId && filteredProjects.find(p=>p.project_id===currentProjectId)) {
          projectSelect.value = currentProjectId;
        }
      });
      const persistDraft = () => {
        const draftLines = Array.from(container.querySelectorAll('[data-line]')).map(div => ({
          service_name: div.querySelector('.line-name').value,
          quantity: Number(div.querySelector('.line-qty').value)||0,
          rate_cents: moneyToCents(div.querySelector('.line-rate').value),
          line_total_cents: moneyToCents((Number(div.querySelector('.line-qty').value)||0)*(Number(div.querySelector('.line-rate').value)||0)),
          billing_type: div.dataset.billing || 'flat',
          time_minutes: (div.dataset.billing||'flat')==='hourly'
            ? (parseTimeToMinutes(div.querySelector('.line-time')?.value) ?? Math.round((Number(div.querySelector('.line-qty').value)||0)*60))
            : null
        }));
        const draftSubtotal = draftLines.reduce((s,l)=>s+l.line_total_cents,0);
        const draftTaxPercent = Math.max(0, Number(form.querySelector('[name="tax_percent"]')?.value)||0);
        const draftTaxCents = Math.round(draftSubtotal * (draftTaxPercent/100));
        const draftTipCents = moneyToCents(form.querySelector('[name="tip_amount"]')?.value || 0);
        const draftObj = {
          ...invoice,
          party_id: form.querySelector('[name="party_id"]').value,
          project_id: form.querySelector('[name="project_id"]').value || null,
          issue_date: form.querySelector('[name="issue_date"]').value,
          subtotal_cents: draftSubtotal,
          tax_percent: draftTaxPercent,
          tax_cents: draftTaxCents,
          tip_cents: draftTipCents,
          total_cents: draftSubtotal + draftTaxCents + draftTipCents,
          lines: draftLines,
          party_name: file.parties.find(p=>p.party_id===form.querySelector('[name="party_id"]').value)?.name
        };
        localStorage.setItem(STORAGE.draftInvoice(activeId), JSON.stringify(draftObj));
      };
      form.addEventListener('input', persistDraft);
      form.onsubmit = (e) => {
        e.preventDefault();
        const data = new FormData(form);
        const lines = Array.from(container.querySelectorAll('[data-line]')).map(div => ({
          invoice_line_id: div.dataset.line,
          service_name: div.querySelector('.line-name').value,
          quantity: Number(div.querySelector('.line-qty').value)||0,
          rate_cents: moneyToCents(div.querySelector('.line-rate').value),
          line_total_cents: moneyToCents((Number(div.querySelector('.line-qty').value)||0)*(Number(div.querySelector('.line-rate').value)||0)),
          billing_type: div.dataset.billing || 'flat',
          time_minutes: (div.dataset.billing||'flat')==='hourly'
            ? (parseTimeToMinutes(div.querySelector('.line-time')?.value) ?? Math.round((Number(div.querySelector('.line-qty').value)||0)*60))
            : null,
          income_account_code: file.settings.default_income_account_code,
          invoice_id: invoice.invoice_id,
          project_id: form.querySelector('[name="project_id"]').value || null,
          created_at: nowIso(),
          updated_at: nowIso()
        }));
        const subtotal = lines.reduce((s,l)=>s+l.line_total_cents,0);
        const taxPercent = Math.max(0, Number(data.get('tax_percent'))||0);
        const taxCents = Math.round(subtotal * (taxPercent/100));
        const tipCents = moneyToCents(data.get('tip_amount') || 0);
        const total = subtotal + taxCents + tipCents;
        const saved = {
          invoice_id: invoice.invoice_id,
          party_id: data.get('party_id'),
          project_id: data.get('project_id') || null,
          number: inv.number || getNextInvoiceNumber(),
          issue_date: data.get('issue_date') || today(),
          status: invoice.status || 'draft',
          subtotal_cents: subtotal,
          tax_percent: taxPercent,
          tax_cents: taxCents,
          tip_cents: tipCents,
          total_cents: total,
          created_at: invoice.created_at || nowIso(),
          updated_at: nowIso()
        };
        if (!file.invoices.find(i=>i.invoice_id===saved.invoice_id)) file.invoices.push(saved);
        else file.invoices = file.invoices.map(i=>i.invoice_id===saved.invoice_id ? saved : i);
        file.invoice_lines = file.invoice_lines.filter(l=>l.invoice_id!==saved.invoice_id).concat(lines);
        localStorage.removeItem(STORAGE.draftInvoice(activeId));
        saveFile();
        renderInvoices();
        closePanel();
      };
      $('#cancel-invoice').onclick = () => {
        const cancelLines = Array.from(container.querySelectorAll('[data-line]')).map(div => ({
          service_name: div.querySelector('.line-name').value,
          quantity: Number(div.querySelector('.line-qty').value)||0,
          rate_cents: moneyToCents(div.querySelector('.line-rate').value),
          line_total_cents: moneyToCents((Number(div.querySelector('.line-qty').value)||0)*(Number(div.querySelector('.line-rate').value)||0)),
          billing_type: div.dataset.billing || 'flat',
          time_minutes: (div.dataset.billing||'flat')==='hourly'
            ? (parseTimeToMinutes(div.querySelector('.line-time')?.value) ?? Math.round((Number(div.querySelector('.line-qty').value)||0)*60))
            : null
        }));
        const cancelSubtotal = cancelLines.reduce((s,l)=>s+l.line_total_cents,0);
        const cancelTaxPercent = Math.max(0, Number(form.querySelector('[name="tax_percent"]')?.value)||0);
        const cancelTaxCents = Math.round(cancelSubtotal * (cancelTaxPercent/100));
        const cancelTipCents = moneyToCents(form.querySelector('[name="tip_amount"]')?.value || 0);
        localStorage.setItem(STORAGE.draftInvoice(activeId), JSON.stringify({
          ...invoice,
          project_id: form.querySelector('[name="project_id"]').value || null,
          subtotal_cents: cancelSubtotal,
          tax_percent: cancelTaxPercent,
          tax_cents: cancelTaxCents,
          tip_cents: cancelTipCents,
          total_cents: cancelSubtotal + cancelTaxCents + cancelTipCents,
          lines: cancelLines
        }));
        closePanel();
      };
      container.addEventListener('click', (e) => {
        if (e.target.dataset.remove !== undefined) {
          const div = e.target.closest('[data-line]');
          const removed = div;
          div.remove();
          const undoLines = container.innerHTML;
          showToast('Line removed', () => { container.innerHTML = undoLines; });
          updateInvoiceTotal(container);
        }
      });
      updateInvoiceTotal(container);
    };

    const updateInvoiceTotal = (container) => {
      if (!file) return;
      const subtotal = Array.from(container.querySelectorAll('[data-line]')).reduce((s,div)=>{
        const qty = Number(div.querySelector('.line-qty').value)||0;
        const rate = Number(div.querySelector('.line-rate').value)||0;
        return s + moneyToCents(qty*rate);
      },0);
      const taxInput = $('#tax-percent');
      const taxPercent = Math.max(0, Number(taxInput?.value)||0);
      const taxCents = Math.round(subtotal * (taxPercent/100));
      const tipInput = $('#tip-amount');
      const tipCents = moneyToCents(tipInput?.value || 0);
      const total = subtotal + taxCents + tipCents;
      const taxPercentLabel = $('#tax-percent-display');
      if (taxPercentLabel) taxPercentLabel.textContent = `(${trimTrailingZeros(taxPercent.toFixed(2))}%)`;
      const subtotalEl = $('#inv-subtotal');
      if (subtotalEl) subtotalEl.textContent = fmt(subtotal, file.business.base_currency);
      const taxEl = $('#inv-tax');
      if (taxEl) taxEl.textContent = fmt(taxCents, file.business.base_currency);
      const tipEl = $('#inv-tip');
      if (tipEl) tipEl.textContent = fmt(tipCents, file.business.base_currency);
      const totalEl = $('#inv-total');
      if (totalEl) totalEl.textContent = fmt(total, file.business.base_currency);
    };

    const addLineFromService = (container, svc) => {
      if (container.querySelector('.empty')) container.innerHTML='';
      const billing = svc.billing_type || 'flat';
      const timeMinutes = billing==='hourly' ? 60 : null;
      const quantity = billing==='hourly' ? (timeMinutes/60) : 1;
      container.insertAdjacentHTML('beforeend', lineRow({
        service_name: svc.name,
        quantity,
        rate_cents: svc.default_rate_cents,
        invoice_line_id: uuid(),
        billing_type: billing,
        time_minutes: timeMinutes
      }));
      updateInvoiceTotal(container);
    };

    const showServiceInline = (container) => {
      openPanel('Add Service', `
        <form id="svc-inline" class="stack">
          <label>Name</label><input name="name">
          <label>Rate</label><input name="rate" type="number" step="0.01">
          <label>Billing</label>
          <select name="billing_type">
            <option value="flat">Flat rate</option>
            <option value="hourly">Time-based (hourly)</option>
          </select>
          <label>Description</label><textarea name="desc"></textarea>
          <div class="row">
            <button type="submit" class="primary">Save & Add</button>
            <button type="button" id="cancel-svc">Cancel</button>
          </div>
        </form>
      `);
      $('#cancel-svc').onclick = closePanel;
      $('#svc-inline').onsubmit = (e) => {
        e.preventDefault();
        const data = new FormData(e.target);
        const svc = {
          service_id: uuid(),
          name: data.get('name'),
          default_rate_cents: moneyToCents(data.get('rate')),
          default_description: data.get('desc'),
          billing_type: data.get('billing_type') || 'flat',
          created_at: nowIso(),
          updated_at: nowIso()
        };
        file.services.push(svc); saveFile(); renderServices();
        closePanel();
        addLineFromService(container, svc);
      };
    };

    const deleteInvoice = (inv) => {
      const removedLines = file.invoice_lines.filter(l=>l.invoice_id===inv.invoice_id);
      file.invoices = file.invoices.filter(i=>i.invoice_id!==inv.invoice_id);
      file.invoice_lines = file.invoice_lines.filter(l=>l.invoice_id!==inv.invoice_id);
      renumberInvoices();
      saveFile(); renderInvoices();
      showToast('Invoice deleted', () => {
        file.invoices.push(inv);
        file.invoice_lines = file.invoice_lines.concat(removedLines);
        renumberInvoices();
        saveFile(); renderInvoices();
      });
    };

    const voidInvoice = (inv) => {
      const prevStatus = inv.status;
      inv.status = 'void';
      saveFile(); renderInvoices();
      showToast('Invoice voided', () => { inv.status = prevStatus; saveFile(); renderInvoices(); });
    };

    const viewInvoice = (inv) => {
      if (!file) return;
      const party = file.parties.find(p => p.party_id === inv.party_id);
      const project = inv.project_id ? file.projects.find(p => p.project_id === inv.project_id) : null;
      const lines = file.invoice_lines.filter(l => l.invoice_id === inv.invoice_id);
      const business = file.business;
      const settings = file.settings || {};
      const invoiceSubtotalCents = invoiceSubtotal(inv);
      const invoiceTaxPercentVal = invoiceTaxPercent(inv);
      const invoiceTaxCents = invoiceTax(inv);
      const invoiceTipCents = invoiceTip(inv);
      const invoiceTotalCents = invoiceTotal(inv);
      const isDark = document.documentElement.classList.contains('dark');
      const logoVariant = settings.logoVariant || 'auto';
      const lightLogo = settings.logoLightDataUrl;
      const darkLogo = settings.logoDarkDataUrl;
      let logoUrl = '';
      if (logoVariant === 'light') logoUrl = lightLogo || darkLogo || '';
      else if (logoVariant === 'dark') logoUrl = darkLogo || lightLogo || '';
      else logoUrl = isDark ? (darkLogo || lightLogo || '') : (lightLogo || darkLogo || '');
      
      const invoiceHtml = `
        <div id="invoice-view" class="invoice-view">
          <div class="invoice-header">
            <div class="invoice-actions">
              <button id="print-invoice" class="primary">Print</button>
              <button id="export-pdf-invoice" class="primary">Export PDF</button>
            </div>
          </div>
          <div class="invoice-content">
            <div class="invoice-header-info">
              <div class="invoice-from">
                ${logoUrl ? `<div class="invoice-logo"><img src="${logoUrl}" alt="${business.name || 'Logo'}" /></div>` : ''}
                <h2>${business.name || 'Business'}</h2>
                ${business.address ? `<div>${business.address}</div>` : ''}
                ${business.city && business.state ? `<div>${business.city}, ${business.state} ${business.zip || ''}</div>` : ''}
                ${business.phone ? `<div>${business.phone}</div>` : ''}
                ${business.email ? `<div>${business.email}</div>` : ''}
              </div>
              <div class="invoice-title">
                <h1>INVOICE</h1>
                <div class="invoice-number">#${inv.number || ''}</div>
                ${inv.status === 'void' ? '<div class="invoice-status void">VOID</div>' : ''}
                ${inv.status === 'paid' ? '<div class="invoice-status paid">PAID</div>' : ''}
              </div>
            </div>
            
            <div class="invoice-details">
              <div class="invoice-to">
                <h3>Bill To:</h3>
                <div><strong>${party?.name || ''}</strong></div>
                ${party?.address ? `<div>${party.address}</div>` : ''}
                ${party?.city && party?.state ? `<div>${party.city}, ${party.state} ${party.zip || ''}</div>` : ''}
                ${party?.email ? `<div>${party.email}</div>` : ''}
              </div>
              <div class="invoice-meta">
                <div class="invoice-meta-row">
                  <span>Invoice Date:</span>
                  <span>${inv.issue_date || ''}</span>
                </div>
                ${project ? `
                <div class="invoice-meta-row">
                  <span>Project:</span>
                  <span>${project.name}</span>
                </div>
                ` : ''}
                ${inv.status ? `
                <div class="invoice-meta-row">
                  <span>Status:</span>
                  <span class="status-${inv.status}">${inv.status.toUpperCase()}</span>
                </div>
                ` : ''}
              </div>
            </div>
            
            <table class="invoice-lines">
              <thead>
                <tr>
                  <th>Description</th>
                  <th style="text-align:right">Quantity</th>
                  <th style="text-align:right">Rate</th>
                  <th style="text-align:right">Amount</th>
                </tr>
              </thead>
              <tbody>
                ${lines.length > 0 ? lines.map(line => `
                  <tr>
                    <td>${line.service_name || ''}</td>
                    <td style="text-align:right">${line.quantity || 0}</td>
                    <td style="text-align:right">${fmt(line.rate_cents || 0, business.base_currency)}</td>
                    <td style="text-align:right">${fmt(line.line_total_cents || 0, business.base_currency)}</td>
                  </tr>
                `).join('') : '<tr><td colspan="4" style="text-align:center; padding:20px; color:var(--muted)">No line items</td></tr>'}
              </tbody>
              <tfoot>
                <tr>
                  <td colspan="3" style="text-align:right; font-weight:600; padding:12px 18px">Subtotal:</td>
                  <td style="text-align:right; font-weight:600; padding:12px 18px">${fmt(invoiceSubtotalCents, business.base_currency)}</td>
                </tr>
                <tr>
                  <td colspan="3" style="text-align:right; font-weight:600; padding:12px 18px">Tax (${trimTrailingZeros(invoiceTaxPercentVal.toFixed(2))}%):</td>
                  <td style="text-align:right; font-weight:600; padding:12px 18px">${fmt(invoiceTaxCents, business.base_currency)}</td>
                </tr>
                ${invoiceTipCents ? `
                <tr>
                  <td colspan="3" style="text-align:right; font-weight:600; padding:12px 18px">Tip:</td>
                  <td style="text-align:right; font-weight:600; padding:12px 18px">${fmt(invoiceTipCents, business.base_currency)}</td>
                </tr>
                ` : ''}
                <tr class="invoice-total">
                  <td colspan="3" style="text-align:right; font-weight:700; padding:20px 18px">Total:</td>
                  <td style="text-align:right; font-weight:700; font-size:1.2em; padding:20px 18px">${fmt(invoiceTotalCents, business.base_currency)}</td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      `;
      
      openPanel('Invoice', invoiceHtml);
      
      // Set up event handlers - openPanel sets innerHTML synchronously, so elements are available immediately
      const printBtn = $('#print-invoice');
      const pdfBtn = $('#export-pdf-invoice');
      
      if (printBtn) printBtn.onclick = (e) => {
        e.preventDefault();
        e.stopPropagation();
        printInvoice(inv);
      };
      if (pdfBtn) pdfBtn.onclick = (e) => {
        e.preventDefault();
        e.stopPropagation();
        exportInvoiceAsPDF(inv);
      };
    };

    const printInvoice = (inv) => {
      if (!file) return;
      const party = file.parties.find(p => p.party_id === inv.party_id);
      const project = inv.project_id ? file.projects.find(p => p.project_id === inv.project_id) : null;
      const lines = file.invoice_lines.filter(l => l.invoice_id === inv.invoice_id);
      const business = file.business;
      const settings = file.settings || {};
      const logoVariant = settings.logoVariant || 'auto';
      const lightLogo = settings.logoLightDataUrl;
      const darkLogo = settings.logoDarkDataUrl;
      // For print, prefer light logo, fallback to dark
      const logoUrl = lightLogo || darkLogo || '';
      const printSubtotal = invoiceSubtotal(inv);
      const printTaxPercent = invoiceTaxPercent(inv);
      const printTax = invoiceTax(inv);
      const printTip = invoiceTip(inv);
      const printTotal = invoiceTotal(inv);
      
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>Invoice #${inv.number || ''}</title>
          <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body {
              font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
              padding: 40px;
              color: #1c1e26;
              line-height: 1.6;
            }
            .invoice-print {
              max-width: 800px;
              margin: 0 auto;
            }
            .invoice-header-info {
              display: flex;
              justify-content: space-between;
              margin-bottom: 40px;
              padding-bottom: 20px;
              border-bottom: 2px solid #e3e5eb;
            }
            .invoice-logo {
              margin-bottom: 16px;
            }
            .invoice-logo img {
              max-height: 60px;
              max-width: 200px;
              object-fit: contain;
            }
            .invoice-from h2 {
              font-size: 1.5em;
              margin-bottom: 10px;
            }
            .invoice-title h1 {
              font-size: 2.5em;
              margin-bottom: 10px;
              text-align: right;
            }
            .invoice-number {
              font-size: 1.2em;
              font-weight: 600;
              text-align: right;
              color: #6b7080;
            }
            .invoice-status {
              text-align: right;
              margin-top: 10px;
              padding: 4px 12px;
              display: inline-block;
              border-radius: 4px;
              font-weight: 600;
              font-size: 0.9em;
            }
            .invoice-status.void {
              background: #fee;
              color: #c00;
            }
            .invoice-status.paid {
              background: #efe;
              color: #060;
            }
            .invoice-details {
              display: flex;
              justify-content: space-between;
              margin-bottom: 30px;
            }
            .invoice-to h3 {
              margin-bottom: 10px;
              font-size: 1.1em;
            }
            .invoice-meta-row {
              display: flex;
              justify-content: space-between;
              margin-bottom: 8px;
            }
            .invoice-meta-row span:first-child {
              color: #6b7080;
            }
            .invoice-lines {
              width: 100%;
              border-collapse: collapse;
              margin-bottom: 30px;
            }
            .invoice-lines th {
              background: #f5f6f8;
              padding: 12px;
              text-align: left;
              font-weight: 600;
              border-bottom: 2px solid #e3e5eb;
            }
            .invoice-lines td {
              padding: 12px;
              border-bottom: 1px solid #e3e5eb;
            }
            .invoice-total {
              border-top: 2px solid #1c1e26;
            }
            .invoice-total td {
              padding-top: 20px;
            }
            @media print {
              body { padding: 20px; }
              @page { margin: 0.5cm; }
            }
          </style>
        </head>
        <body>
          <div class="invoice-print">
            <div class="invoice-header-info">
              <div class="invoice-from">
                ${logoUrl ? `<div class="invoice-logo"><img src="${logoUrl}" alt="${business.name || 'Logo'}" /></div>` : ''}
                <h2>${business.name || 'Business'}</h2>
                ${business.address ? `<div>${business.address}</div>` : ''}
                ${business.city && business.state ? `<div>${business.city}, ${business.state} ${business.zip || ''}</div>` : ''}
                ${business.phone ? `<div>${business.phone}</div>` : ''}
                ${business.email ? `<div>${business.email}</div>` : ''}
              </div>
              <div class="invoice-title">
                <h1>INVOICE</h1>
                <div class="invoice-number">#${inv.number || ''}</div>
                ${inv.status === 'void' ? '<div class="invoice-status void">VOID</div>' : ''}
                ${inv.status === 'paid' ? '<div class="invoice-status paid">PAID</div>' : ''}
              </div>
            </div>
            
            <div class="invoice-details">
              <div class="invoice-to">
                <h3>Bill To:</h3>
                <div><strong>${party?.name || ''}</strong></div>
                ${party?.address ? `<div>${party.address}</div>` : ''}
                ${party?.city && party?.state ? `<div>${party.city}, ${party.state} ${party.zip || ''}</div>` : ''}
                ${party?.email ? `<div>${party.email}</div>` : ''}
              </div>
              <div class="invoice-meta">
                <div class="invoice-meta-row">
                  <span>Invoice Date:</span>
                  <span>${inv.issue_date || ''}</span>
                </div>
                ${project ? `
                <div class="invoice-meta-row">
                  <span>Project:</span>
                  <span>${project.name}</span>
                </div>
                ` : ''}
                ${inv.status ? `
                <div class="invoice-meta-row">
                  <span>Status:</span>
                  <span>${inv.status.toUpperCase()}</span>
                </div>
                ` : ''}
              </div>
            </div>
            
            <table class="invoice-lines">
              <thead>
                <tr>
                  <th>Description</th>
                  <th style="text-align:right">Quantity</th>
                  <th style="text-align:right">Rate</th>
                  <th style="text-align:right">Amount</th>
                </tr>
              </thead>
              <tbody>
                ${lines.length > 0 ? lines.map(line => `
                  <tr>
                    <td>${line.service_name || ''}</td>
                    <td style="text-align:right">${line.quantity || 0}</td>
                    <td style="text-align:right">${fmt(line.rate_cents || 0, business.base_currency)}</td>
                    <td style="text-align:right">${fmt(line.line_total_cents || 0, business.base_currency)}</td>
                  </tr>
                `).join('') : '<tr><td colspan="4" style="text-align:center; padding:20px">No line items</td></tr>'}
              </tbody>
              <tfoot>
                <tr>
                  <td colspan="3" style="text-align:right; font-weight:600; padding:12px 12px">Subtotal:</td>
                  <td style="text-align:right; font-weight:600; padding:12px 12px">${fmt(printSubtotal, business.base_currency)}</td>
                </tr>
                <tr>
                  <td colspan="3" style="text-align:right; font-weight:600; padding:12px 12px">Tax (${trimTrailingZeros(printTaxPercent.toFixed(2))}%):</td>
                  <td style="text-align:right; font-weight:600; padding:12px 12px">${fmt(printTax, business.base_currency)}</td>
                </tr>
                ${printTip ? `
                <tr>
                  <td colspan="3" style="text-align:right; font-weight:600; padding:12px 12px">Tip:</td>
                  <td style="text-align:right; font-weight:600; padding:12px 12px">${fmt(printTip, business.base_currency)}</td>
                </tr>
                ` : ''}
                <tr class="invoice-total">
                  <td colspan="3" style="text-align:right; font-weight:700; padding:20px 12px">Total:</td>
                  <td style="text-align:right; font-weight:700; font-size:1.2em; padding:20px 12px">${fmt(printTotal, business.base_currency)}</td>
                </tr>
              </tfoot>
            </table>
          </div>
        </body>
        </html>
      `);
      printWindow.document.close();
      setTimeout(() => {
        printWindow.print();
      }, 250);
    };

    const exportInvoiceAsPDF = async (inv) => {
      if (!file) return;
      const party = file.parties.find(p => p.party_id === inv.party_id);
      const project = inv.project_id ? file.projects.find(p => p.project_id === inv.project_id) : null;
      const lines = file.invoice_lines.filter(l => l.invoice_id === inv.invoice_id);
      const business = file.business;
      const settings = file.settings || {};
      const logoVariant = settings.logoVariant || 'auto';
      const lightLogo = settings.logoLightDataUrl;
      const darkLogo = settings.logoDarkDataUrl;
      const logoUrl = lightLogo || darkLogo || '';
      const pdfSubtotal = invoiceSubtotal(inv);
      const pdfTaxPercent = invoiceTaxPercent(inv);
      const pdfTax = invoiceTax(inv);
      const pdfTip = invoiceTip(inv);
      const pdfTotal = invoiceTotal(inv);
      
      // Create a temporary container for the invoice content
      const tempContainer = document.createElement('div');
      tempContainer.style.position = 'absolute';
      tempContainer.style.left = '-9999px';
      tempContainer.style.width = '210mm'; // A4 width
      tempContainer.style.padding = '20mm';
      tempContainer.style.background = '#ffffff';
      tempContainer.style.fontFamily = 'system-ui, -apple-system, "Segoe UI", sans-serif';
      tempContainer.style.fontSize = '14px';
      tempContainer.style.color = '#1c1e26';
      tempContainer.style.lineHeight = '1.6';
      
      const invoiceContent = `
        <div style="display: flex; justify-content: space-between; gap: 20px; padding-bottom: 20px; border-bottom: 2px solid #e3e5eb; margin-bottom: 24px;">
          <div>
            ${logoUrl ? `<div style="margin-bottom: 16px;"><img src="${logoUrl}" alt="${business.name || 'Logo'}" style="max-height: 60px; max-width: 200px; object-fit: contain;" /></div>` : ''}
            <h2 style="font-size: 1.4em; margin-bottom: 8px; margin-top: 0;">${business.name || 'Business'}</h2>
            ${business.address ? `<div>${business.address}</div>` : ''}
            ${business.city && business.state ? `<div>${business.city}, ${business.state} ${business.zip || ''}</div>` : ''}
            ${business.phone ? `<div>${business.phone}</div>` : ''}
            ${business.email ? `<div>${business.email}</div>` : ''}
          </div>
          <div style="text-align: right;">
            <h1 style="font-size: 2em; margin-bottom: 8px; margin-top: 0; font-weight: 700;">INVOICE</h1>
            <div style="font-size: 1.1em; font-weight: 600; color: #6b7080; margin-bottom: 8px;">#${inv.number || ''}</div>
            ${inv.status === 'void' ? '<div style="display: inline-block; padding: 4px 12px; border-radius: 6px; font-weight: 600; font-size: 0.85em; margin-top: 8px; background: rgba(226, 85, 85, 0.1); color: #e25555;">VOID</div>' : ''}
            ${inv.status === 'paid' ? '<div style="display: inline-block; padding: 4px 12px; border-radius: 6px; font-weight: 600; font-size: 0.85em; margin-top: 8px; background: rgba(31, 179, 122, 0.1); color: #1fb37a;">PAID</div>' : ''}
          </div>
        </div>
        
        <div style="display: flex; justify-content: space-between; gap: 20px; margin-bottom: 24px;">
          <div>
            <h3 style="margin-bottom: 10px; font-size: 1em; font-weight: 600;">Bill To:</h3>
            <div><strong>${party?.name || ''}</strong></div>
            ${party?.address ? `<div>${party.address}</div>` : ''}
            ${party?.city && party?.state ? `<div>${party.city}, ${party.state} ${party.zip || ''}</div>` : ''}
            ${party?.email ? `<div>${party.email}</div>` : ''}
          </div>
          <div style="text-align: right;">
            <div style="display: flex; justify-content: space-between; gap: 16px; margin-bottom: 8px;">
              <span style="color: #6b7080;">Invoice Date:</span>
              <span>${inv.issue_date || ''}</span>
            </div>
            ${project ? `
            <div style="display: flex; justify-content: space-between; gap: 16px; margin-bottom: 8px;">
              <span style="color: #6b7080;">Project:</span>
              <span>${project.name}</span>
            </div>
            ` : ''}
            ${inv.status ? `
            <div style="display: flex; justify-content: space-between; gap: 16px; margin-bottom: 8px;">
              <span style="color: #6b7080;">Status:</span>
              <span>${inv.status.toUpperCase()}</span>
            </div>
            ` : ''}
          </div>
        </div>
        
        <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
          <thead>
            <tr style="background: #f2f3f7; border-bottom: 2px solid #e3e5eb;">
              <th style="padding: 12px; text-align: left; font-weight: 600; font-size: 0.9em;">Description</th>
              <th style="padding: 12px; text-align: right; font-weight: 600; font-size: 0.9em;">Quantity</th>
              <th style="padding: 12px; text-align: right; font-weight: 600; font-size: 0.9em;">Rate</th>
              <th style="padding: 12px; text-align: right; font-weight: 600; font-size: 0.9em;">Amount</th>
            </tr>
          </thead>
          <tbody>
            ${lines.length > 0 ? lines.map(line => `
              <tr>
                <td style="padding: 12px; border-bottom: 1px solid #e3e5eb;">${line.service_name || ''}</td>
                <td style="padding: 12px; border-bottom: 1px solid #e3e5eb; text-align: right;">${line.quantity || 0}</td>
                <td style="padding: 12px; border-bottom: 1px solid #e3e5eb; text-align: right;">${fmt(line.rate_cents || 0, business.base_currency)}</td>
                <td style="padding: 12px; border-bottom: 1px solid #e3e5eb; text-align: right;">${fmt(line.line_total_cents || 0, business.base_currency)}</td>
              </tr>
            `).join('') : '<tr><td colspan="4" style="text-align: center; padding: 20px; color: #6b7080;">No line items</td></tr>'}
          </tbody>
          <tfoot>
            <tr style="border-top: 2px solid #1c1e26;">
              <td colspan="3" style="text-align: right; font-weight: 600; padding: 12px 18px;">Subtotal:</td>
              <td style="text-align: right; font-weight: 600; padding: 12px 18px;">${fmt(pdfSubtotal, business.base_currency)}</td>
            </tr>
            <tr>
              <td colspan="3" style="text-align: right; font-weight: 600; padding: 12px 18px;">Tax (${trimTrailingZeros(pdfTaxPercent.toFixed(2))}%):</td>
              <td style="text-align: right; font-weight: 600; padding: 12px 18px;">${fmt(pdfTax, business.base_currency)}</td>
            </tr>
            ${pdfTip ? `
            <tr>
              <td colspan="3" style="text-align: right; font-weight: 600; padding: 12px 18px;">Tip:</td>
              <td style="text-align: right; font-weight: 600; padding: 12px 18px;">${fmt(pdfTip, business.base_currency)}</td>
            </tr>
            ` : ''}
            <tr class="invoice-total">
              <td colspan="3" style="text-align: right; font-weight: 700; padding: 20px 18px;">Total:</td>
              <td style="text-align: right; font-weight: 700; font-size: 1.2em; padding: 20px 18px;">${fmt(pdfTotal, business.base_currency)}</td>
            </tr>
          </tfoot>
        </table>
      `;
      
      tempContainer.innerHTML = invoiceContent;
      document.body.appendChild(tempContainer);
      
      try {
        // Wait for images to load
        await new Promise(resolve => setTimeout(resolve, 500));
        
        // Convert to canvas
        const canvas = await html2canvas(tempContainer, {
          scale: 2,
          useCORS: true,
          logging: false,
          backgroundColor: '#ffffff'
        });
        
        // Create PDF - check for both UMD and global formats
        let jsPDF;
        if (window.jspdf && window.jspdf.jsPDF) {
          jsPDF = window.jspdf.jsPDF;
        } else if (window.jspdf) {
          jsPDF = window.jspdf;
        } else {
          throw new Error('jsPDF library not loaded');
        }
        const pdf = new jsPDF({
          orientation: 'portrait',
          unit: 'mm',
          format: 'a4'
        });
        
        const imgData = canvas.toDataURL('image/png');
        const imgWidth = 210; // A4 width in mm
        const pageHeight = 297; // A4 height in mm
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        let heightLeft = imgHeight;
        let position = 0;
        
        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;
        
        while (heightLeft >= 0) {
          position = heightLeft - imgHeight;
          pdf.addPage();
          pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
          heightLeft -= pageHeight;
        }
        
        // Download PDF
        const fileName = `Invoice_${inv.number || inv.invoice_id}_${inv.issue_date || 'draft'}.pdf`;
        pdf.save(fileName);
        
        showToast('PDF exported successfully');
      } catch (error) {
        console.error('PDF export error:', error);
        showToast('Error exporting PDF: ' + error.message, null);
      } finally {
        if (tempContainer && tempContainer.parentNode) {
          document.body.removeChild(tempContainer);
        }
      }
    };

    const promptMarkPaid = (inv) => {
      const depositOptions = file.accounts.filter(a=>a.type==='asset').map(a=>`<option value="${a.code}">${a.code} - ${a.name}</option>`).join('');
      const recent = recentSelections('deposit');
      showModal(`
        <div class="stack">
          <h3>Mark Paid</h3>
          <label>Deposit to</label>
          <select id="deposit">${depositOptions}</select>
          <div class="row" style="gap:8px; flex-wrap:wrap">${recent.map(r=>`<button type="button" class="recent-chip" data-dep="${r}">${r}</button>`).join('')}</div>
          <label>Date</label>
          <input id="pay-date" type="date" value="${today()}">
          <div class="row" style="justify-content:flex-end; gap:8px">
            <button data-cancel type="button">Cancel</button>
            <button data-confirm class="primary" type="button">Post</button>
          </div>
        </div>
      `, () => {
        const dep = $('#deposit').value;
        pushRecent('deposit', dep);
        const pay = {
          payment_id: uuid(),
          invoice_id: inv.invoice_id,
          deposit_account_code: dep,
          payment_date: $('#pay-date').value,
          amount_cents: invoiceTotal(inv)
        };
        file.payments.push(pay);
        file.payment_applications.push({ payment_application_id: uuid(), payment_id: pay.payment_id, invoice_id: inv.invoice_id, amount_cents: invoiceTotal(inv) });
        postInvoicePayment(inv, pay);
        inv.status = 'paid';
        saveFile(); renderInvoices();
      });
      $('#modal-body').querySelectorAll('[data-dep]').forEach(btn=>btn.onclick=()=>{$('#deposit').value=btn.dataset.dep;});
    };

    // ---------- Transactions ----------
    const renderTransactions = () => {
      if (!file) return;
      const tbody = $('#txn-rows'); tbody.innerHTML = '';
      const searchQuery = normalizeSearchValue($('#txn-search')?.value).trim();
      const rows = file.transactions.filter(t => {
        if (!searchQuery) return true;
        return matchesSearch(t.category, searchQuery)
          || matchesSearch(t.memo, searchQuery)
          || matchesSearch(t.type, searchQuery)
          || matchesSearch(t.date, searchQuery);
      });
      if (!file.transactions.length) $('#txn-empty').classList.remove('hidden'); else $('#txn-empty').classList.add('hidden');
      if (file.transactions.length && !rows.length) $('#txn-empty-filter')?.classList.remove('hidden'); else $('#txn-empty-filter')?.classList.add('hidden');
      rows.forEach(t => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHtml(t.date)}</td><td>${escapeHtml(t.type)}</td><td>${escapeHtml(t.category||'')}</td><td>${fmt(t.amount_cents,file.business.base_currency)}</td>
        <td class="row actions"><button data-edit>Edit</button><button data-del>Delete</button></td>`;
        tr.querySelector('[data-edit]').onclick = () => editTxn(t);
        tr.querySelector('[data-del]').onclick = () => delTxn(t);
        tbody.appendChild(tr);
      });
    };

    const renderTxnDraft = () => {
      if (!file) return;
      const draft = JSON.parse(localStorage.getItem(STORAGE.draftTxn(activeId)) || 'null');
      const container = $('#txn-draft');
      if (!container) return;
      if (!draft) { container.innerHTML = '<div class="empty">No draft saved.</div>'; return; }
      container.innerHTML = `<div class="stack"><div><strong>${escapeHtml(draft.type)}</strong> ${fmt(draft.amount_cents,file.business.base_currency)}</div>
      <div>${escapeHtml(draft.memo||'')}</div><button id="resume-txn">Resume</button></div>`;
      const resumeBtn = $('#resume-txn');
      if (resumeBtn) resumeBtn.onclick = () => editTxn(draft,true);
    };

    const txnForm = (t={}) => {
      const recentCats = recentSelections('category');
      const typeValue = t.type || 'income';
      return `
        <form id="txn-form" class="stack">
          <label>Date</label><input name="date" type="date" value="${t.date||today()}">
          <label>Type</label>
          <div class="type-toggle-group">
            <input type="hidden" name="type" value="${typeValue}">
            ${['income','expense','transfer'].map(v=>`<button type="button" class="type-toggle ${typeValue===v?'active':''}" data-type="${v}">${v}</button>`).join('')}
          </div>
          <label>Category</label>
          <input name="category" value="${escapeHtml(t.category||'')}" list="cat-list">
          <datalist id="cat-list">${file.accounts.map(a=>`<option value="${escapeHtml(a.code)} - ${escapeHtml(a.name)}">`).join('')}</datalist>
          <div class="row" style="gap:8px; flex-wrap:wrap">${recentCats.map(c=>`<button type="button" class="recent-chip" data-cat="${escapeHtml(c)}">${escapeHtml(c)}</button>`).join('')}</div>
          <label>Amount</label><input name="amount" type="number" step="0.01" value="${centsToMoney(t.amount_cents||0)}">
          <label>Project</label><select name="project_id"><option value="">None</option>${file.projects.map(p=>`<option value="${escapeHtml(p.project_id)}" ${p.project_id===t.project_id?'selected':''}>${escapeHtml(p.name)}</option>`).join('')}</select>
          <label>Memo</label><input name="memo" value="${escapeHtml(t.memo||'')}">
          <div class="row" style="gap:8px">
            <button type="submit" class="primary">Save</button>
            <button type="button" id="cancel-txn">Cancel</button>
          </div>
        </form>
      `;
    };

    const recentSelections = (key) => {
      const arr = JSON.parse(localStorage.getItem('ck5_recent_'+key) || '[]');
      return arr.slice(-3).reverse();
    };
    const pushRecent = (key, val) => {
      if (!val) return;
      const arr = recentSelections(key);
      if (!arr.includes(val)) arr.push(val);
      localStorage.setItem('ck5_recent_'+key, JSON.stringify(arr.slice(-6)));
    };

    const editTxn = (t, isDraft=false) => {
      if (!file) return;
      const txn = isDraft ? t : { ...t };
      openPanel('Transaction', txnForm(txn));
      const form = $('#txn-form');
      const typeButtons = form.querySelectorAll('.type-toggle');
      const typeInput = form.querySelector('[name="type"]');
      typeButtons.forEach(btn => btn.onclick = () => {
        typeButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        if (typeInput) typeInput.value = btn.dataset.type;
      });
      form.querySelectorAll('[data-cat]').forEach(btn => btn.onclick = () => {
        const catInput = form.querySelector('[name="category"]');
        if (catInput) catInput.value = btn.dataset.cat;
      });
      const persistDraft = () => {
        const data = new FormData(form);
        const draft = {
          transaction_id: txn.transaction_id || uuid(),
          date: data.get('date') || today(),
          type: data.get('type'),
          category: data.get('category'),
          amount_cents: moneyToCents(data.get('amount')),
          project_id: data.get('project_id') || null,
          memo: data.get('memo') || ''
        };
        localStorage.setItem(STORAGE.draftTxn(activeId), JSON.stringify(draft));
      };
      form.addEventListener('input', persistDraft);
      form.onsubmit = (e) => {
        e.preventDefault();
        const data = new FormData(form);
        const saved = {
          transaction_id: txn.transaction_id || uuid(),
          date: data.get('date') || today(),
          type: data.get('type'),
          category: data.get('category'),
          amount_cents: moneyToCents(data.get('amount')),
          project_id: data.get('project_id') || null,
          memo: data.get('memo') || '',
          created_at: txn.created_at || nowIso(),
          updated_at: nowIso()
        };
        pushRecent('category', saved.category);
        if (!file.transactions.find(x=>x.transaction_id===saved.transaction_id)) file.transactions.push(saved);
        else file.transactions = file.transactions.map(x=>x.transaction_id===saved.transaction_id ? saved : x);
        postTransaction(saved);
        localStorage.removeItem(STORAGE.draftTxn(activeId));
        saveFile(); renderTransactions(); renderDashboard();
        closePanel();
      };
      $('#cancel-txn').onclick = () => {
        localStorage.setItem(STORAGE.draftTxn(activeId), JSON.stringify(txn));
        closePanel();
      };
    };

    const delTxn = (t) => {
      // #region agent log
      fetch('http://127.0.0.1:7242/ingest/251e5d6a-3d5b-41b3-b796-d6cf2eef1b0c',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'Checkmark Accountant V5.html:delTxn',message:'delTxn:entry',data:{transaction_id:t.transaction_id,type:t.type,amount_cents:t.amount_cents,ledgerEntries:file.ledger_entries.length,ledgerLines:file.ledger_lines.length},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
      // #endregion
      // Remove any posted ledger entries linked to this transaction so balances stay correct
      removeLinkedEntries({ transaction_id: t.transaction_id });
      file.transactions = file.transactions.filter(x=>x.transaction_id!==t.transaction_id);
      saveFile(); renderTransactions(); renderDashboard();
      showToast('Transaction deleted', () => { 
        file.transactions.push(t); 
        postTransaction(t); // re-post ledger impact if user undoes delete
        saveFile(); 
        renderTransactions(); renderDashboard();
      });
      // #region agent log
      fetch('http://127.0.0.1:7242/ingest/251e5d6a-3d5b-41b3-b796-d6cf2eef1b0c',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'Checkmark Accountant V5.html:delTxn',message:'delTxn:after',data:{transaction_id:t.transaction_id,remainingTransactions:file.transactions.length,ledgerEntries:file.ledger_entries.length,ledgerLines:file.ledger_lines.length},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
      // #endregion
    };

    // ---------- Clients / Services ----------
    const renderClients = () => {
      const tbody = $('#client-rows'); tbody.innerHTML = '';
      if (!file.parties.length) $('#client-empty').classList.remove('hidden'); else $('#client-empty').classList.add('hidden');
      sortPartiesByName(file.parties).forEach(p => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHtml(p.name)}</td><td>${escapeHtml(p.email||'')}</td><td class="row actions"><button data-edit>Edit</button><button data-del>Delete</button></td>`;
        tr.querySelector('[data-edit]').onclick = () => editClient(p);
        tr.querySelector('[data-del]').onclick = () => {
          file.parties = file.parties.filter(x=>x.party_id!==p.party_id); saveFile(); renderClients();
        };
        tbody.appendChild(tr);
      });
    };

    const editClient = (p={}) => {
      if (!file) return;
      openPanel('Client', `
        <form id="client-form" class="stack">
          <label>Name</label><input name="name" value="${escapeHtml(p.name||'')}">
          <label>Email</label><input name="email" value="${escapeHtml(p.email||'')}">
          <label>Phone</label><input name="phone" value="${escapeHtml(p.phone||'')}">
          <label>Address</label><textarea name="address">${escapeHtml(p.address||'')}</textarea>
          <div class="row"><button type="submit" class="primary">Save</button><button type="button" id="cancel-client">Cancel</button></div>
        </form>
      `);
      $('#client-form').onsubmit = (e) => {
        e.preventDefault();
        const data = new FormData(e.target);
        const saved = {
          party_id: p.party_id || uuid(),
          name: data.get('name'),
          email: data.get('email'),
          phone: data.get('phone'),
          address: data.get('address'),
          created_at: p.created_at || nowIso(),
          updated_at: nowIso()
        };
        if (!file.parties.find(x=>x.party_id===saved.party_id)) file.parties.push(saved);
        else file.parties = file.parties.map(x=>x.party_id===saved.party_id?saved:x);
        saveFile(); renderClients(); closePanel();
      };
      $('#cancel-client').onclick = closePanel;
    };

    const renderProjects = () => {
      const tbody = $('#project-rows'); if (!tbody) return;
      tbody.innerHTML = '';
      if (!file.projects.length) $('#project-empty').classList.remove('hidden'); else $('#project-empty').classList.add('hidden');
      file.projects.forEach(pr => {
        // Handle backward compatibility: convert party_id to party_ids array
        const partyIds = pr.party_ids || (pr.party_id ? [pr.party_id] : []);
        const parties = partyIds.map(id => file.parties.find(p=>p.party_id===id)).filter(p=>p);
        const clientNames = parties.length > 0 ? parties.map(p=>p.name).join(', ') : '';
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHtml(pr.name)}</td><td>${escapeHtml(clientNames)}</td><td class="row"><button data-edit>Edit</button><button data-del>Delete</button></td>`;
        tr.querySelector('[data-edit]').onclick = () => editProject(pr);
        tr.querySelector('[data-del]').onclick = () => { file.projects = file.projects.filter(x=>x.project_id!==pr.project_id); saveFile(); renderProjects(); };
        tbody.appendChild(tr);
      });
    };

    const editProject = (pr={}) => {
      if (!file) return;
      // Handle backward compatibility: convert party_id to party_ids array
      const currentPartyIds = pr.party_ids || (pr.party_id ? [pr.party_id] : []);
      const partyCheckboxes = sortPartiesByName(file.parties).map(p=>{
        const checked = currentPartyIds.includes(p.party_id) ? 'checked' : '';
        return `<label style="display:flex; align-items:center; gap:8px; margin:8px 0; cursor:pointer;"><input type="checkbox" name="party_ids" value="${escapeHtml(p.party_id)}" ${checked} style="width:auto;">${escapeHtml(p.name)}</label>`;
      }).join('');
      openPanel('Project', `
        <form id="project-form" class="stack">
          <label>Name</label><input name="name" value="${escapeHtml(pr.name||'')}">
          <label>Clients</label>
          <div style="border:1px solid var(--border); border-radius:12px; padding:16px; background:var(--surface-soft); max-height:300px; overflow-y:auto;">
            ${partyCheckboxes || '<div class="muted">No clients available. Add clients first.</div>'}
          </div>
          <div class="row"><button class="primary" type="submit">Save</button><button type="button" id="cancel-project">Cancel</button></div>
        </form>
      `);
      $('#project-form').onsubmit = (e)=> {
        e.preventDefault();
        const data = new FormData(e.target);
        const selectedPartyIds = data.getAll('party_ids').filter(id => id);
        const saved = {
          project_id: pr.project_id || uuid(),
          name: data.get('name'),
          party_ids: selectedPartyIds.length > 0 ? selectedPartyIds : [],
          created_at: pr.created_at || nowIso(),
          updated_at: nowIso()
        };
        // Remove old party_id if it exists (backward compatibility)
        if (saved.party_id !== undefined) delete saved.party_id;
        if (!file.projects.find(x=>x.project_id===saved.project_id)) file.projects.push(saved);
        else file.projects = file.projects.map(x=>x.project_id===saved.project_id?saved:x);
        saveFile(); renderProjects(); closePanel();
      };
      $('#cancel-project').onclick = closePanel;
    };

    const renderServices = () => {
      const tbody = $('#service-rows'); tbody.innerHTML = '';
      if (!file.services.length) $('#service-empty').classList.remove('hidden'); else $('#service-empty').classList.add('hidden');
      file.services.forEach(s => {
        const tr = document.createElement('tr');
        const billing = s.billing_type === 'hourly' ? 'Hourly' : 'Flat';
        tr.innerHTML = `<td>${escapeHtml(s.name)}</td><td>${fmt(s.default_rate_cents,file.business.base_currency)}</td><td>${escapeHtml(billing)}</td><td class="row"><button data-edit>Edit</button><button data-del>Delete</button></td>`;
        tr.querySelector('[data-edit]').onclick = () => editService(s);
        tr.querySelector('[data-del]').onclick = () => {
          file.services = file.services.filter(x=>x.service_id!==s.service_id); saveFile(); renderServices();
        };
        tbody.appendChild(tr);
      });
    };

    const editService = (s={}) => {
      if (!file) return;
      openPanel('Service', `
        <form id="service-form" class="stack">
          <label>Name</label><input name="name" value="${escapeHtml(s.name||'')}">
          <label>Default rate</label><input name="rate" type="number" step="0.01" value="${centsToMoney(s.default_rate_cents||0)}">
          <label>Billing</label>
          <select name="billing_type">
            <option value="flat" ${s.billing_type!=='hourly'?'selected':''}>Flat rate</option>
            <option value="hourly" ${s.billing_type==='hourly'?'selected':''}>Time-based (hourly)</option>
          </select>
          <div class="muted" style="font-size:0.9rem;">Hourly adds an hh:mm field on invoices so you can enter time (e.g. 1:30) without creating another service.</div>
          <label>Description</label><textarea name="desc">${escapeHtml(s.default_description||'')}</textarea>
          <div class="row"><button class="primary" type="submit">Save</button><button type="button" id="cancel-service">Cancel</button></div>
        </form>
      `);
      $('#service-form').onsubmit = (e) => {
        e.preventDefault();
        const data = new FormData(e.target);
        const saved = {
          service_id: s.service_id || uuid(),
          name: data.get('name'),
          default_rate_cents: moneyToCents(data.get('rate')),
          default_description: data.get('desc'),
          billing_type: data.get('billing_type') || 'flat',
          created_at: s.created_at || nowIso(),
          updated_at: nowIso()
        };
        if (!file.services.find(x=>x.service_id===saved.service_id)) file.services.push(saved);
        else file.services = file.services.map(x=>x.service_id===saved.service_id?saved:x);
        saveFile(); renderServices(); closePanel();
      };
      $('#cancel-service').onclick = closePanel;
    };

    // ---------- Import / Export (Entity-level) ----------
    const unwrapRecords = (payload, keys=[]) => {
      if (Array.isArray(payload)) return payload;
      for (const key of keys) {
        if (Array.isArray(payload?.[key])) return payload[key];
      }
      return [];
    };

    const exportInvoicesData = (format='json') => {
      if (!file) return;
      const rows = file.invoices.map(inv => {
        const party = file.parties.find(p => p.party_id === inv.party_id);
        const lines = file.invoice_lines.filter(l => l.invoice_id === inv.invoice_id);
        return { ...inv, party_name: party?.name || '', lines };
      });
      const filenameBase = `${file.business.name.replace(/[^a-z0-9]/gi, '_') || 'invoices'}-${today()}`;
      if (format === 'csv') {
        const csv = toCSV(rows, [
          { header:'invoice_id', getter:r=>r.invoice_id },
          { header:'number', getter:r=>r.number },
          { header:'party_id', getter:r=>r.party_id },
          { header:'party_name', getter:r=>r.party_name || '' },
          { header:'issue_date', getter:r=>r.issue_date },
          { header:'status', getter:r=>r.status },
          { header:'subtotal_cents', getter:r=>r.subtotal_cents ?? '' },
          { header:'tax_percent', getter:r=>r.tax_percent ?? '' },
          { header:'tax_cents', getter:r=>r.tax_cents ?? '' },
          { header:'tip_cents', getter:r=>r.tip_cents ?? '' },
          { header:'total_cents', getter:r=>r.total_cents ?? '' },
          { header:'project_id', getter:r=>r.project_id || '' },
          { header:'lines_json', getter:r=>JSON.stringify(r.lines || []) }
        ]);
        download(csv, `${filenameBase}-invoices.csv`, 'text/csv');
      } else {
        download(JSON.stringify(rows, null, 2), `${filenameBase}-invoices.json`);
      }
      recordAudit({ type:'export', entity:'invoices', format, count: rows.length });
      showToast(`Exported ${rows.length} invoice${rows.length===1?'':'s'}`);
    };

    const exportTransactionsData = (format='json') => {
      if (!file) return;
      const rows = file.transactions.map(t => ({ ...t }));
      const filenameBase = `${file.business.name.replace(/[^a-z0-9]/gi, '_') || 'transactions'}-${today()}`;
      if (format === 'csv') {
        const csv = toCSV(rows, [
          { header:'transaction_id', getter:r=>r.transaction_id },
          { header:'date', getter:r=>r.date },
          { header:'type', getter:r=>r.type },
          { header:'category', getter:r=>r.category || '' },
          { header:'amount_cents', getter:r=>r.amount_cents ?? '' },
          { header:'project_id', getter:r=>r.project_id || '' },
          { header:'memo', getter:r=>r.memo || '' }
        ]);
        download(csv, `${filenameBase}-transactions.csv`, 'text/csv');
      } else {
        download(JSON.stringify(rows, null, 2), `${filenameBase}-transactions.json`);
      }
      recordAudit({ type:'export', entity:'transactions', format, count: rows.length });
      showToast(`Exported ${rows.length} transaction${rows.length===1?'':'s'}`);
    };

    const exportClientsData = (format='json') => {
      if (!file) return;
      const rows = file.parties.map(p => ({ ...p }));
      const filenameBase = `${file.business.name.replace(/[^a-z0-9]/gi, '_') || 'clients'}-${today()}`;
      if (format === 'csv') {
        const csv = toCSV(rows, [
          { header:'party_id', getter:r=>r.party_id },
          { header:'name', getter:r=>r.name },
          { header:'email', getter:r=>r.email || '' },
          { header:'phone', getter:r=>r.phone || '' },
          { header:'address', getter:r=>r.address || '' }
        ]);
        download(csv, `${filenameBase}-clients.csv`, 'text/csv');
      } else {
        download(JSON.stringify(rows, null, 2), `${filenameBase}-clients.json`);
      }
      recordAudit({ type:'export', entity:'clients', format, count: rows.length });
      showToast(`Exported ${rows.length} client${rows.length===1?'':'s'}`);
    };

    const exportServicesData = (format='json') => {
      if (!file) return;
      const rows = file.services.map(s => ({ ...s }));
      const filenameBase = `${file.business.name.replace(/[^a-z0-9]/gi, '_') || 'services'}-${today()}`;
      if (format === 'csv') {
        const csv = toCSV(rows, [
          { header:'service_id', getter:r=>r.service_id },
          { header:'name', getter:r=>r.name },
          { header:'default_rate_cents', getter:r=>r.default_rate_cents ?? '' },
          { header:'billing_type', getter:r=>r.billing_type || 'flat' },
          { header:'default_description', getter:r=>r.default_description || '' }
        ]);
        download(csv, `${filenameBase}-services.csv`, 'text/csv');
      } else {
        download(JSON.stringify(rows, null, 2), `${filenameBase}-services.json`);
      }
      recordAudit({ type:'export', entity:'services', format, count: rows.length });
      showToast(`Exported ${rows.length} service${rows.length===1?'':'s'}`);
    };

    const exportAuditLog = () => {
      if (!file) return;
      const data = file.change_log || [];
      const filename = `${file.business.name.replace(/[^a-z0-9]/gi, '_') || 'audit'}-log-${today()}.json`;
      download(JSON.stringify(data, null, 2), filename);
      showToast(`Exported audit log (${data.length} entries)`);
    };

    const parseLineItemsFromImport = (raw, invoiceId) => {
      const payload = Array.isArray(raw) ? raw : (() => { try { return JSON.parse(raw || '[]'); } catch { return []; } })();
      if (!Array.isArray(payload)) return [];
      return payload.map(l => {
        const qty = Number(l.quantity ?? l.qty ?? 0) || 0;
        const rate = l.rate_cents !== undefined ? Number(l.rate_cents) || 0 : moneyToCents(l.rate ?? l.price ?? 0);
        const total = l.line_total_cents !== undefined ? Number(l.line_total_cents) || 0 : moneyToCents(qty * (Number(l.rate ?? l.price ?? 0) || 0));
        return {
          invoice_line_id: l.invoice_line_id || uuid(),
          invoice_id: invoiceId,
          service_name: l.service_name || l.name || '',
          quantity: qty,
          rate_cents: rate,
          line_total_cents: total,
          billing_type: l.billing_type || 'flat',
          time_minutes: l.time_minutes !== undefined ? Number(l.time_minutes) || 0 : null,
          income_account_code: l.income_account_code || file?.settings?.default_income_account_code,
          project_id: l.project_id || null,
          created_at: l.created_at || nowIso(),
          updated_at: nowIso()
        };
      });
    };

    const importInvoicesData = (rawRecords, source='json') => {
      if (!file) return;
      const records = unwrapRecords(rawRecords, ['invoices', 'data', 'rows']);
      let imported = 0, skipped = 0;
      records.forEach(rec => {
        const invoiceId = rec.invoice_id || uuid();
        const existing = file.invoices.find(i => i.invoice_id === invoiceId || (rec.number && i.number == rec.number));
        if (existing) { skipped++; return; }
        const partyMatch = rec.party_id
          || file.parties.find(p => rec.party_email && p.email && p.email.toLowerCase() === rec.party_email.toLowerCase())?.party_id
          || file.parties.find(p => rec.party_name && p.name === rec.party_name)?.party_id
          || null;
        const lines = parseLineItemsFromImport(rec.lines || rec.lines_json, invoiceId);
        const subtotal = Number(rec.subtotal_cents) || lines.reduce((s,l)=>s+(l.line_total_cents||0),0);
        const taxPercent = Number(rec.tax_percent) || 0;
        const taxCents = Number(rec.tax_cents) || Math.round(subtotal * (taxPercent/100));
        const tipCents = rec.tip_cents !== undefined ? Number(rec.tip_cents) || 0 : moneyToCents(rec.tip || rec.tip_amount || 0);
        const total = Number(rec.total_cents) || subtotal + taxCents + tipCents;
        const saved = {
          invoice_id: invoiceId,
          number: rec.number || getNextInvoiceNumber(),
          party_id: partyMatch,
          project_id: rec.project_id || null,
          issue_date: rec.issue_date || today(),
          status: rec.status || 'draft',
          subtotal_cents: subtotal,
          tax_percent: taxPercent,
          tax_cents: taxCents,
          tip_cents: tipCents,
          total_cents: total,
          created_at: rec.created_at || nowIso(),
          updated_at: nowIso()
        };
        file.invoices.push(saved);
        if (lines.length) {
          file.invoice_lines = file.invoice_lines.filter(l => l.invoice_id !== invoiceId).concat(lines);
        }
        imported++;
      });
      recordAudit({ type:'import', entity:'invoices', format: source, imported, skipped }, { save:false });
      renumberInvoices();
      saveFile();
      renderInvoices();
      showToast(`Imported ${imported} invoice${imported===1?'':'s'}${skipped?`, skipped ${skipped} duplicate${skipped===1?'':'s'}`:''}`);
    };

    const importTransactionsData = (rawRecords, source='json') => {
      if (!file) return;
      const records = unwrapRecords(rawRecords, ['transactions', 'data', 'rows']);
      let imported = 0, skipped = 0;
      records.forEach(rec => {
        const txnId = rec.transaction_id || uuid();
        const amount = rec.amount_cents !== undefined ? Number(rec.amount_cents) || 0 : moneyToCents(rec.amount || rec.total || 0);
        const memo = rec.memo || '';
        const existing = file.transactions.find(t => t.transaction_id === txnId || (t.date === rec.date && t.amount_cents === amount && t.memo === memo));
        if (existing) { skipped++; return; }
        const saved = {
          transaction_id: txnId,
          date: rec.date || today(),
          type: rec.type || 'expense',
          category: rec.category || '',
          amount_cents: amount,
          project_id: rec.project_id || null,
          memo,
          created_at: rec.created_at || nowIso(),
          updated_at: nowIso()
        };
        file.transactions.push(saved);
        imported++;
      });
      recordAudit({ type:'import', entity:'transactions', format: source, imported, skipped }, { save:false });
      saveFile();
      renderTransactions();
      showToast(`Imported ${imported} transaction${imported===1?'':'s'}${skipped?`, skipped ${skipped} duplicate${skipped===1?'':'s'}`:''}`);
    };

    const importClientsData = (rawRecords, source='json') => {
      if (!file) return;
      const records = unwrapRecords(rawRecords, ['clients', 'parties', 'data', 'rows']);
      let imported = 0, skipped = 0;
      records.forEach(rec => {
        const partyId = rec.party_id || uuid();
        const emailLower = rec.email ? rec.email.toLowerCase() : '';
        const existing = file.parties.find(p =>
          p.party_id === partyId ||
          (emailLower && p.email && p.email.toLowerCase() === emailLower) ||
          (rec.name && p.name === rec.name)
        );
        if (existing) { skipped++; return; }
        const saved = {
          party_id: partyId,
          name: rec.name || 'Unnamed',
          email: rec.email || '',
          phone: rec.phone || '',
          address: rec.address || '',
          created_at: rec.created_at || nowIso(),
          updated_at: nowIso()
        };
        file.parties.push(saved);
        imported++;
      });
      recordAudit({ type:'import', entity:'clients', format: source, imported, skipped }, { save:false });
      saveFile();
      renderClients();
      showToast(`Imported ${imported} client${imported===1?'':'s'}${skipped?`, skipped ${skipped} duplicate${skipped===1?'':'s'}`:''}`);
    };

    const importServicesData = (rawRecords, source='json') => {
      if (!file) return;
      const records = unwrapRecords(rawRecords, ['services', 'data', 'rows']);
      let imported = 0, skipped = 0;
      records.forEach(rec => {
        const serviceId = rec.service_id || uuid();
        const nameLower = (rec.name || '').toLowerCase();
        const existing = file.services.find(s =>
          s.service_id === serviceId ||
          (nameLower && s.name && s.name.toLowerCase() === nameLower)
        );
        if (existing) { skipped++; return; }
        const saved = {
          service_id: serviceId,
          name: rec.name || 'Service',
          default_rate_cents: rec.default_rate_cents !== undefined ? Number(rec.default_rate_cents) || 0 : moneyToCents(rec.rate || 0),
          billing_type: rec.billing_type || 'flat',
          default_description: rec.default_description || rec.description || '',
          created_at: rec.created_at || nowIso(),
          updated_at: nowIso()
        };
        file.services.push(saved);
        imported++;
      });
      recordAudit({ type:'import', entity:'services', format: source, imported, skipped }, { save:false });
      saveFile();
      renderServices();
      showToast(`Imported ${imported} service${imported===1?'':'s'}${skipped?`, skipped ${skipped} duplicate${skipped===1?'':'s'}`:''}`);
    };

    const handleEntityImportFile = (fileObj, handler) => {
      if (!fileObj) return;
      const ext = (fileObj.name || '').toLowerCase().split('.').pop();
      const format = ext === 'csv' ? 'csv' : 'json';
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const text = reader.result;
          const parsed = format === 'csv' ? parseCSV(text) : JSON.parse(text);
          handler(parsed, format);
        } catch (e) {
          showModal(`
            <div class="stack">
              <h3>Import Error</h3>
              <p style="color:var(--danger)">Failed to import: ${e.message}</p>
              <div class="row" style="justify-content:flex-end">
                <button data-cancel class="primary">OK</button>
              </div>
            </div>
          `, () => {});
        }
      };
      reader.readAsText(fileObj);
    };

    // ---------- Reports ----------
    const postedLines = () => {
      // #region agent log
      fetch('http://127.0.0.1:7242/ingest/251e5d6a-3d5b-41b3-b796-d6cf2eef1b0c',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'Checkmark Accountant V5.html:postedLines',message:'postedLines:entry',data:{ledgerEntries:file.ledger_entries.length,ledgerLines:file.ledger_lines.length,entries:file.ledger_entries.map(e=>({id:e.ledger_entry_id,type:e.entry_type,linkedTxn:e.linked_transaction_id||null,linkedPay:e.linked_payment_id||null}))},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'B'})}).catch(()=>{});
      // #endregion
      const postedIds = file.ledger_entries.filter(e=>e.status==='posted').map(e=>e.ledger_entry_id);
      const lines = file.ledger_lines.filter(l=>postedIds.includes(l.ledger_entry_id));
      // #region agent log
      fetch('http://127.0.0.1:7242/ingest/251e5d6a-3d5b-41b3-b796-d6cf2eef1b0c',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'Checkmark Accountant V5.html:postedLines',message:'postedLines:after',data:{returned:lines.length,postedIdsCount:postedIds.length},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'B'})}).catch(()=>{});
      // #endregion
      return lines;
    };

    const runPL = () => {
      const { start, end } = getReportsDateRange();
      const allTime = isAllTimeRange(start, end);
      const lines = postedLines().filter(l=>{
        const entry = file.ledger_entries.find(e=>e.ledger_entry_id===l.ledger_entry_id);
        if (!entry) return false;
        if (!entry.entry_date) return allTime;
        return allTime || (entry.entry_date >= start && entry.entry_date <= end);
      });
      let income=0, expense=0;
      lines.forEach(l=>{
        const entry = file.ledger_entries.find(e=>e.ledger_entry_id===l.ledger_entry_id);
        const acct = file.accounts.find(a=>a.code===l.account_code);
        if (!acct) return;
        if (acct.type==='income' && !entry?.linked_invoice_id) {
          income += (l.credit_cents||0)-(l.debit_cents||0);
        }
        if (acct.type==='expense') expense += (l.debit_cents||0)-(l.credit_cents||0);
      });
      
      // Include invoice income for the date range
      const invoices = file.invoices.filter(inv => {
        if (inv.status === 'void') return false;
        if (!inv.issue_date) return allTime;
        return allTime || (inv.issue_date >= start && inv.issue_date <= end);
      });
      invoices.forEach(inv => {
        income += invoiceTotal(inv);
      });
      
      $('#pl-output').innerHTML = `
        <div class="row" style="justify-content:space-between; padding: 12px 0; border-bottom: 1px solid var(--border)"><span>Income</span><strong>${fmt(income,file.business.base_currency)}</strong></div>
        <div class="row" style="justify-content:space-between; padding: 12px 0; border-bottom: 1px solid var(--border)"><span>Expenses</span><strong>${fmt(expense,file.business.base_currency)}</strong></div>
        <div class="row" style="justify-content:space-between; padding: 12px 0; margin-top: 8px; font-weight: 600; font-size: 1.1rem"><span>Net</span><strong style="color: var(--accent)">${fmt(income-expense,file.business.base_currency)}</strong></div>
      `;
    };

    const summaryByAccount = (type) => {
      const map = {};
      postedLines().forEach(l=>{
        const acct = file.accounts.find(a=>a.code===l.account_code);
        if (!acct || acct.type!==type) return;
        const delta = (l.debit_cents||0)-(l.credit_cents||0);
        map[acct.name] = (map[acct.name]||0) + delta;
      });
      return map;
    };

    const renderSummary = (map, target) => {
      const entries = Object.entries(map);
      if (!entries.length) { target.innerHTML = '<div class="empty">No data</div>'; return; }
      target.innerHTML = entries.map(([k,v])=>`<div class="row" style="justify-content:space-between"><span>${k}</span><strong>${fmt(v,file.business.base_currency)}</strong></div>`).join('');
    };

    const clientRevenue = () => {
      const { start, end } = getReportsDateRange();
      const result = {};
      // Use invoices directly (by issue date) instead of just payments
      const allTime = isAllTimeRange(start, end);
      const invoices = file.invoices.filter(inv => {
        if (inv.status === 'void') return false;
        if (!inv.issue_date) return allTime;
        return allTime || (inv.issue_date >= start && inv.issue_date <= end);
      });
      invoices.forEach(inv => {
        const party = file.parties.find(p=>p.party_id===inv.party_id);
        const name = party?.name || 'Unknown';
        result[name] = (result[name]||0) + invoiceTotal(inv);
      });
      return result;
    };

    const projectProfit = () => {
      const map = {};
      postedLines().forEach(l=>{
        const entry = file.ledger_entries.find(e=>e.ledger_entry_id===l.ledger_entry_id);
        if (!entry?.project_id) return;
        const acct = file.accounts.find(a=>a.code===l.account_code);
        if (!acct) return;
        const proj = file.projects.find(p=>p.project_id===entry.project_id);
        const name = proj?.name || 'Unassigned';
        if (!map[name]) map[name]=0;
        if (acct.type==='income') map[name] += (l.credit_cents||0)-(l.debit_cents||0);
        if (acct.type==='expense') map[name] -= (l.debit_cents||0)-(l.credit_cents||0);
      });
      return map;
    };

    const grtGrossReceipts = (start, end) => {
      let total = 0;
      postedLines().forEach(l=>{
        const entry = file.ledger_entries.find(e=>e.ledger_entry_id===l.ledger_entry_id);
        if (!entry || entry.entry_date < start || entry.entry_date > end) return;
        const acct = file.accounts.find(a=>a.code===l.account_code);
        if (!acct || acct.type !== 'income') return;
        total += (l.credit_cents||0)-(l.debit_cents||0);
      });
      return total;
    };

    const grtInvoiceBase = (start, end) => {
      let total = 0;
      const allTime = isAllTimeRange(start, end);
      file.invoices
        .filter(inv => {
          if (!inv.issue_date) return allTime;
          return allTime || (inv.issue_date >= start && inv.issue_date <= end);
        })
        .forEach(inv => { total += invoiceTotal(inv); });
      return total;
    };

    const grtBaseForRange = (start, end) => {
      const basis = file?.settings?.grt_basis || 'payments';
      if (basis === 'invoices') return grtInvoiceBase(start, end);
      if (basis === 'both') return grtInvoiceBase(start, end) + grtGrossReceipts(start, end);
      return grtGrossReceipts(start, end);
    };

    const grtDueDate = (endDate) => {
      if (!endDate || endDate === '2999-12-31') return '';
      const [y, m] = endDate.split('-').map(Number);
      if (!y || !m) return '';
      const dueMonth = m === 12 ? 0 : m;
      const dueYear = m === 12 ? y + 1 : y;
      return new Date(dueYear, dueMonth, 25).toISOString().split('T')[0];
    };

    const taxSummary = () => {
      const { start, end } = getReportsDateRange();
      const map = {};
      const grtPercent = Math.max(0, Number(file?.settings?.grt_percent)||0);
      const grossReceipts = grtBaseForRange(start, end);
      postedLines().forEach(l=>{
        const entry = file.ledger_entries.find(e=>e.ledger_entry_id===l.ledger_entry_id);
        if (!entry || entry.entry_date < start || entry.entry_date > end) return;
        if (l.account_code === '2200') {
          const delta = (l.credit_cents||0)-(l.debit_cents||0);
          map['Taxes Payable'] = (map['Taxes Payable']||0) + delta;
        }
      });
      if (grtPercent > 0) {
        map['Gross Receipts'] = grossReceipts;
        map['Estimated GRT'] = Math.round(grossReceipts * (grtPercent / 100));
      }
      return map;
    };

    const renderTaxSummary = () => {
      const target = $('#report-tax');
      if (!target) return;
      renderSummary(taxSummary(), target);
      const rangeEl = $('#grt-range');
      if (rangeEl) {
        const { start, end } = getReportsDateRange();
        rangeEl.textContent = `Range: ${start} to ${end}`;
      }
      const meta = $('#grt-meta');
      if (!meta) return;
      const grtPercent = Math.max(0, Number(file?.settings?.grt_percent)||0);
      if (!grtPercent) {
        meta.textContent = 'Set GRT % in Settings to estimate tax.';
        return;
      }
      const { end } = getReportsDateRange();
      const due = grtDueDate(end);
      meta.textContent = due
        ? `Estimated due date: ${due} (next business day if weekend/holiday).`
        : 'Set a date range to see the estimated due date.';
    };

    const refreshReports = () => {
      populateGRTYearSelect();
      runPL();
      renderSummary(summaryByAccount('expense'), $('#report-expense'));
      renderSummary(clientRevenue(), $('#report-client'));
      renderSummary(projectProfit(), $('#report-project'));
      renderTaxSummary();
    };

    // ---------- Settings ----------
    const renderMigrationBlock = () => {
      const block = $('#migration-block');
      if (detectV4()) block.innerHTML = `<div class="stack"><div>V4 data detected.</div><button id="migrate-btn" class="primary">Migrate to V5</button></div>`;
      else block.innerHTML = '<div class="muted">No V4 data found.</div>';
      const btn = $('#migrate-btn'); if (btn) btn.onclick = runMigration;
    };

    const runIntegrity = () => {
      if (!file) return;
      const output = $('#integrity-output');
      if (!output) return;
      const unbalanced = [];
      const orphan = [];
      file.ledger_entries.forEach(e=>{
        const lines = file.ledger_lines.filter(l=>l.ledger_entry_id===e.ledger_entry_id);
        const deb = lines.reduce((s,l)=>s+(l.debit_cents||0),0);
        const cred = lines.reduce((s,l)=>s+(l.credit_cents||0),0);
        if (deb!==cred) unbalanced.push(e.ledger_entry_id);
        if (!lines.length) orphan.push(e.ledger_entry_id);
      });
      output.innerHTML = `
        <div>Unbalanced entries: ${unbalanced.length}</div>
        <div>Orphaned entries: ${orphan.length}</div>
        <div>Missing links: manual review</div>
      `;
    };

    const updateHeaderImagePreview = () => {
      if (!file) return;
      const preview = $('#header-image-preview');
      const removeBtn = $('#remove-header-image');
      const headerImage = file.settings?.headerImageDataUrl;
      const fitSelect = $('#header-image-fit');
      const opacitySlider = $('#header-image-opacity');
      const opacityValue = $('#header-opacity-value');
      
      if (preview) {
        if (headerImage) {
          const fit = file.settings?.headerImageFit || 'cover';
          const opacity = file.settings?.headerImageOpacity || 10;
          preview.innerHTML = `<img src="${headerImage}" alt="Header preview" style="max-width:100%; max-height:150px; border-radius:8px; border:1px solid var(--border); margin-top:10px; object-fit:${fit}">`;
          if (removeBtn) removeBtn.style.display = 'block';
          if (fitSelect) fitSelect.value = fit;
          if (opacitySlider) opacitySlider.value = opacity;
          if (opacityValue) opacityValue.textContent = opacity + '%';
        } else {
          preview.innerHTML = '';
          if (removeBtn) removeBtn.style.display = 'none';
          if (fitSelect) fitSelect.value = 'cover';
          if (opacitySlider) opacitySlider.value = 10;
          if (opacityValue) opacityValue.textContent = '10%';
        }
      }
    };

    const handleImport = (fileObj) => {
      if (!fileObj) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const data = JSON.parse(reader.result);
          
          // Handle "all businesses" export
          if (data.export_type === 'all_businesses' && Array.isArray(data.businesses)) {
            showModal(`
              <div class="stack">
                <h3>Import All Businesses</h3>
                <p>This file contains ${data.businesses.length} business(es).</p>
                <p><strong>Warning:</strong> This will import all businesses. Existing businesses with the same ID will be overwritten.</p>
                <div class="row" style="justify-content:flex-end; gap:8px">
                  <button data-cancel>Cancel</button>
                  <button data-confirm class="primary">Import All</button>
                </div>
              </div>
            `, () => {
              let imported = 0;
              let skipped = 0;
              data.businesses.forEach(b => {
                if (!b.data || !b.business_info) {
                  skipped++;
                  return;
                }
                const businessId = b.data.business?.business_id || b.business_info.id;
                if (!businessId) {
                  skipped++;
                  return;
                }
                // Add to business list if not exists
                if (!businessList.find(bl => bl.id === businessId)) {
                  businessList.push({
                    id: businessId,
                    name: b.business_info.name || b.data.business?.name || 'Imported Business'
                  });
                }
                // Save business data
                localStorage.setItem(STORAGE.v5Data(businessId), JSON.stringify(b.data));
                imported++;
              });
              saveList();
              loadActive();
              showToast(`Imported ${imported} business(es)${skipped > 0 ? `, skipped ${skipped}` : ''}`);
            });
            return;
          }
          
          // Handle single business import
          if (!data.schema_version) throw new Error('Invalid file format: missing schema_version');
          if (data.schema_version !== 5) {
            showModal(`
              <div class="stack">
                <h3>Unsupported Schema Version</h3>
                <p>This file uses schema version ${data.schema_version}, but this app requires version 5.</p>
                <p>Please use the migration tool if this is a V4 backup.</p>
                <div class="row" style="justify-content:flex-end">
                  <button data-cancel class="primary">OK</button>
                </div>
              </div>
            `, () => {});
            return;
          }
          if (!data.business || !data.business.business_id) {
            throw new Error('Invalid file format: missing business data');
          }
          // Confirm before overwriting
          showModal(`
            <div class="stack">
              <h3>Import Business Data</h3>
              <p><strong>Warning:</strong> This will replace all data for the current business "${file?.business?.name || 'Current Business'}".</p>
              <p>Business to import: <strong>${data.business.name || 'Unknown'}</strong></p>
              <p style="color:var(--danger)">This action cannot be undone. Make sure you have exported a backup first.</p>
              <div class="row" style="justify-content:flex-end; gap:8px">
                <button data-cancel>Cancel</button>
                <button data-confirm class="primary">Import Anyway</button>
              </div>
            </div>
          `, () => {
            // Update business ID to match imported data or create new business
            const importedId = data.business.business_id;
            const existingBusiness = businessList.find(b => b.id === importedId);
            
            if (existingBusiness && existingBusiness.id !== activeId) {
              // Business already exists with this ID, ask if they want to import into current or create new
              showModal(`
                <div class="stack">
                  <h3>Business Already Exists</h3>
                  <p>A business with the name "${data.business.name}" already exists.</p>
                  <p>Would you like to:</p>
                  <div class="row" style="justify-content:flex-end; gap:8px">
                    <button data-cancel>Cancel</button>
                    <button id="import-overwrite" class="primary">Overwrite Existing</button>
                    <button id="import-new">Import as New Business</button>
                  </div>
                </div>
              `, () => {});
              $('#import-overwrite').onclick = () => {
                activeId = importedId;
                saveActive();
                localStorage.setItem(STORAGE.v5Data(activeId), JSON.stringify(data));
                loadActive();
                showToast('Business data imported successfully');
                closeModal();
              };
              $('#import-new').onclick = () => {
                const newId = uuid();
                data.business.business_id = newId;
                data.business.name = data.business.name + ' (Imported)';
                businessList.push({ id: newId, name: data.business.name });
                saveList();
                localStorage.setItem(STORAGE.v5Data(newId), JSON.stringify(data));
                activeId = newId;
                saveActive();
                loadActive();
                showToast('Business imported as new business');
                closeModal();
              };
            } else {
              // Import into current business or create new
              if (importedId !== activeId) {
                // Importing different business - add to list if not exists
                if (!businessList.find(b => b.id === importedId)) {
                  businessList.push({ id: importedId, name: data.business.name });
                  saveList();
                }
                activeId = importedId;
                saveActive();
              }
              localStorage.setItem(STORAGE.v5Data(activeId), JSON.stringify(data));
              loadActive();
              showToast('Business data imported successfully');
            }
          });
        } catch (e) {
          showModal(`
            <div class="stack">
              <h3>Import Error</h3>
              <p style="color:var(--danger)">Failed to import file: ${e.message}</p>
              <p>Please ensure the file is a valid Checkmark Accountant V5 backup file.</p>
              <div class="row" style="justify-content:flex-end">
                <button data-cancel class="primary">OK</button>
              </div>
            </div>
          `, () => {});
        }
      };
      reader.onerror = () => {
        showModal(`
          <div class="stack">
            <h3>File Read Error</h3>
            <p style="color:var(--danger)">Failed to read the file. Please try again.</p>
            <div class="row" style="justify-content:flex-end">
              <button data-cancel class="primary">OK</button>
            </div>
          </div>
        `, () => {});
      };
      reader.readAsText(fileObj);
    };

    // ---------- Analytics ----------
    let analyticsCharts = {};
    const isDarkMode = () => document.documentElement.classList.contains('dark');
    let dashboardCharts = {};
    const getChartColors = () => {
      const isDark = isDarkMode();
      return {
        text: isDark ? '#f5f7fb' : '#1c1e26',
        grid: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)',
        income: '#1fb37a',
        expense: '#e25555',
        profit: '#3a7ff5',
        accent: isDark ? '#5aa3ff' : '#3a7ff5'
      };
    };

    const DASHBOARD_RANGE_KEY = 'ck5_dashboard_range';
    const isAllTimeRange = (start, end) => start === '1900-01-01' && end === '2999-12-31';
    const dateRangeForPreset = (preset, now = new Date()) => {
      let start, end;
      switch(preset) {
        case 'today':
          start = end = now.toISOString().split('T')[0];
          break;
        case 'week': {
          const weekStart = new Date(now);
          weekStart.setDate(now.getDate() - now.getDay());
          start = weekStart.toISOString().split('T')[0];
          end = now.toISOString().split('T')[0];
          break;
        }
        case 'month':
          start = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
          end = now.toISOString().split('T')[0];
          break;
        case 'quarter': {
          const quarter = Math.floor(now.getMonth() / 3);
          start = new Date(now.getFullYear(), quarter * 3, 1).toISOString().split('T')[0];
          end = now.toISOString().split('T')[0];
          break;
        }
        case 'year':
          start = new Date(now.getFullYear(), 0, 1).toISOString().split('T')[0];
          end = now.toISOString().split('T')[0];
          break;
        case 'all':
          start = '1900-01-01';
          end = '2999-12-31';
          break;
        default:
          return null;
      }
      return { start, end };
    };
    const getDateRange = () => {
      const start = $('#analytics-start').value || '1900-01-01';
      const end = $('#analytics-end').value || '2999-12-31';
      return { start, end };
    };
    const getDashboardRangeFilter = (range = getDashboardRange()) => {
      const { start, end } = range;
      return { start, end, allTime: isAllTimeRange(start, end) };
    };
    const getDashboardFilteredLines = (range) => {
      const { start, end, allTime } = getDashboardRangeFilter(range);
      const posted = postedLines();
      return posted.filter(l => {
        const entry = file.ledger_entries.find(e => e.ledger_entry_id === l.ledger_entry_id);
        if (!entry) return false;
        if (!entry.entry_date) return allTime;
        return allTime || (entry.entry_date >= start && entry.entry_date <= end);
      });
    };
    const getDashboardFilteredInvoices = (range) => {
      const { start, end, allTime } = getDashboardRangeFilter(range);
      return file.invoices.filter(inv => {
        if (inv.status === 'void') return false;
        if (!inv.issue_date) return allTime;
        return allTime || (inv.issue_date >= start && inv.issue_date <= end);
      });
    };

    const setDatePreset = (preset, section = 'analytics') => {
      const range = dateRangeForPreset(preset);
      if (!range) return;
      const startInput = section === 'reports' ? $('#reports-start') : $('#analytics-start');
      const endInput = section === 'reports' ? $('#reports-end') : $('#analytics-end');
      const { start, end } = range;

      if (startInput) startInput.value = start;
      if (endInput) endInput.value = end;
      $$(`.date-preset-btn[data-for="${section}"]`).forEach(btn => btn.classList.remove('active'));
      $(`.date-preset-btn[data-preset="${preset}"][data-for="${section}"]`)?.classList.add('active');
    };

    const loadDashboardRange = () => {
      try {
        return JSON.parse(localStorage.getItem(DASHBOARD_RANGE_KEY) || 'null');
      } catch {
        return null;
      }
    };
    const saveDashboardRange = (range, preset) => {
      localStorage.setItem(DASHBOARD_RANGE_KEY, JSON.stringify({ range, preset }));
    };
    const ensureDashboardRange = () => {
      const stored = loadDashboardRange();
      if (stored?.range?.start && stored?.range?.end) return stored;
      const range = dateRangeForPreset('month');
      const preset = 'month';
      saveDashboardRange(range, preset);
      return { range, preset };
    };
    const getDashboardRange = () => ensureDashboardRange().range;
    const getDashboardPreset = () => ensureDashboardRange().preset;
    const updateDashboardRangeLabel = (range) => {
      const label = $('#dashboard-range');
      if (label) label.textContent = `Range: ${range.start} to ${range.end}`;
    };
    const setDashboardPreset = (preset) => {
      const range = dateRangeForPreset(preset);
      if (!range) return;
      saveDashboardRange(range, preset);
      $$('.date-preset-btn[data-for="dashboard"]').forEach(btn => btn.classList.toggle('active', btn.dataset.preset === preset));
      updateDashboardRangeLabel(range);
    };

    const setReportsRange = (start, end) => {
      const startInput = $('#reports-start');
      const endInput = $('#reports-end');
      if (startInput) startInput.value = start;
      if (endInput) endInput.value = end;
      $$('.date-preset-btn[data-for="reports"]').forEach(btn => btn.classList.remove('active'));
    };

    const lastFullFilingPeriod = (frequency) => {
      const today = new Date();
      const year = today.getFullYear();
      const month = today.getMonth();
      let start;
      let end;
      if (frequency === 'quarterly') {
        const currentQuarter = Math.floor(month / 3);
        const prevQuarter = currentQuarter === 0 ? 3 : currentQuarter - 1;
        const prevYear = currentQuarter === 0 ? year - 1 : year;
        start = new Date(prevYear, prevQuarter * 3, 1);
        end = new Date(prevYear, prevQuarter * 3 + 3, 0);
      } else if (frequency === 'semiannual') {
        if (month < 6) {
          start = new Date(year - 1, 6, 1);
          end = new Date(year - 1, 12, 0);
        } else {
          start = new Date(year, 0, 1);
          end = new Date(year, 6, 0);
        }
      } else {
        start = new Date(year, month - 1, 1);
        end = new Date(year, month, 0);
      }
      return {
        start: start.toISOString().split('T')[0],
        end: end.toISOString().split('T')[0]
      };
    };

    const currentFilingPeriod = (frequency) => {
      const today = new Date();
      const year = today.getFullYear();
      const month = today.getMonth();
      let start;
      let end;
      if (frequency === 'quarterly') {
        const currentQuarter = Math.floor(month / 3);
        start = new Date(year, currentQuarter * 3, 1);
        end = new Date(year, currentQuarter * 3 + 3, 0);
      } else if (frequency === 'semiannual') {
        if (month < 6) {
          start = new Date(year, 0, 1);
          end = new Date(year, 6, 0);
        } else {
          start = new Date(year, 6, 1);
          end = new Date(year, 12, 0);
        }
      } else {
        start = new Date(year, month, 1);
        end = new Date(year, month + 1, 0);
      }
      return {
        start: start.toISOString().split('T')[0],
        end: end.toISOString().split('T')[0]
      };
    };

    const yearRange = (year) => {
      const start = new Date(year, 0, 1);
      const end = new Date(year, 11, 31);
      return {
        start: start.toISOString().split('T')[0],
        end: end.toISOString().split('T')[0]
      };
    };

    const getGRTYearOptions = () => {
      const years = new Set();
      const currentYear = new Date().getFullYear();
      years.add(currentYear);
      file.invoices.forEach(inv => {
        if (inv.issue_date) years.add(Number(inv.issue_date.slice(0, 4)));
      });
      file.ledger_entries.forEach(entry => {
        if (entry.entry_date) years.add(Number(entry.entry_date.slice(0, 4)));
      });
      return Array.from(years).filter(Boolean).sort((a,b)=>b-a);
    };

    const populateGRTYearSelect = () => {
      const select = $('#grt-year');
      if (!select) return;
      const options = getGRTYearOptions();
      const current = String(new Date().getFullYear());
      select.innerHTML = options.map(y => `<option value="${y}">${y}</option>`).join('');
      if (!select.value) select.value = current;
    };

    const getReportsDateRange = () => {
      const start = $('#reports-start')?.value || '1900-01-01';
      const end = $('#reports-end')?.value || '2999-12-31';
      return { start, end };
    };

    const isReportsActive = () => {
      const reportsSection = $$('section[data-section="reports"]')[0];
      return reportsSection && !reportsSection.classList.contains('hidden');
    };

    const getFilteredLines = () => {
      const { start, end } = getDateRange();
      const allTime = isAllTimeRange(start, end);
      const posted = postedLines();
      return posted.filter(l => {
        const entry = file.ledger_entries.find(e => e.ledger_entry_id === l.ledger_entry_id);
        if (!entry) return false;
        if (!entry.entry_date) return allTime;
        return allTime || (entry.entry_date >= start && entry.entry_date <= end);
      });
    };

    const getFilteredInvoices = () => {
      const { start, end } = getDateRange();
      const allTime = isAllTimeRange(start, end);
      return file.invoices.filter(inv => {
        if (!inv.issue_date) return allTime;
        return allTime || (inv.issue_date >= start && inv.issue_date <= end);
      });
    };

    const isAccrualBasis = () => (file?.settings?.accounting_basis || 'cash') === 'accrual';
    const getInvoiceIncome = () => {
      const invoices = getFilteredInvoices().filter(inv => inv.status !== 'void');
      const monthlyData = {};
      invoices.forEach(inv => {
        if (!inv.issue_date) return;
        const month = inv.issue_date.substring(0, 7);
        if (!monthlyData[month]) monthlyData[month] = 0;
        monthlyData[month] += invoiceTotal(inv);
      });
      return monthlyData;
    };

    const getInvoiceIncomeByCategory = () => {
      const invoices = getFilteredInvoices().filter(inv => inv.status !== 'void');
      const categoryMap = {};
      invoices.forEach(inv => {
        const lines = file.invoice_lines.filter(l => l.invoice_id === inv.invoice_id);
        lines.forEach(line => {
          const acct = file.accounts.find(a => a.code === line.income_account_code);
          const accountName = acct ? acct.name : 'Uncategorized Income';
          categoryMap[accountName] = (categoryMap[accountName] || 0) + (line.line_total_cents || 0);
        });
      });
      return categoryMap;
    };

    const destroyChart = (chartId) => {
      if (analyticsCharts[chartId]) {
        analyticsCharts[chartId].destroy();
        delete analyticsCharts[chartId];
      }
    };

    const renderIncomeExpenseChart = () => {
      try {
        destroyChart('incomeExpense');
        const lines = getFilteredLines();
        const monthlyData = {};
        
        // Add income/expense from ledger entries
        lines.forEach(l => {
          const entry = file.ledger_entries.find(e => e.ledger_entry_id === l.ledger_entry_id);
          if (!entry || !entry.entry_date) return;
          const month = entry.entry_date.substring(0, 7);
          if (!monthlyData[month]) monthlyData[month] = { income: 0, expense: 0 };
          
          const acct = file.accounts.find(a => a.code === l.account_code);
          if (!acct) return;
          
          if (acct.type === 'income' && !entry.linked_invoice_id) {
            monthlyData[month].income += (l.credit_cents || 0) - (l.debit_cents || 0);
          } else if (acct.type === 'expense') {
            monthlyData[month].expense += (l.debit_cents || 0) - (l.credit_cents || 0);
          }
        });

        // Add income from invoices
        const invoiceIncome = getInvoiceIncome();
        Object.keys(invoiceIncome).forEach(month => {
          if (!monthlyData[month]) monthlyData[month] = { income: 0, expense: 0 };
          monthlyData[month].income += invoiceIncome[month];
        });

        const months = Object.keys(monthlyData).sort();
        const chartEl = document.getElementById('income-expense-chart');
        if (!chartEl) return;
        
        // Restore canvas if it was replaced
        if (!chartEl.parentElement.querySelector('canvas')) {
          chartEl.parentElement.innerHTML = '<canvas id="income-expense-chart"></canvas>';
        }
        
        if (!months.length) {
          chartEl.parentElement.innerHTML = '<div style="text-align:center;padding:40px;color:var(--muted)">No data available for selected date range</div>';
          return;
        }
        const colors = getChartColors();
        const ctx = chartEl.getContext('2d');
        
        analyticsCharts['incomeExpense'] = new Chart(ctx, {
          type: 'line',
          data: {
            labels: months,
            datasets: [{
              label: 'Income',
              data: months.map(m => monthlyData[m].income / 100),
              borderColor: colors.income,
              backgroundColor: colors.income + '20',
              tension: 0.4,
              fill: true
            }, {
              label: 'Expenses',
              data: months.map(m => monthlyData[m].expense / 100),
              borderColor: colors.expense,
              backgroundColor: colors.expense + '20',
              tension: 0.4,
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              intersect: false,
              mode: 'index'
            },
            plugins: {
              legend: { 
                labels: { color: colors.text },
                position: 'top'
              },
              tooltip: {
                callbacks: {
                  label: (context) => `${context.dataset.label}: ${fmt(context.parsed.y * 100, file.business.base_currency)}`
                }
              }
            },
            scales: {
              x: { 
                ticks: { color: colors.text, maxRotation: 45, minRotation: 0 }, 
                grid: { color: colors.grid } 
              },
              y: { 
                ticks: { 
                  color: colors.text,
                  callback: (value) => fmt(value * 100, file.business.base_currency)
                }, 
                grid: { color: colors.grid } 
              }
            }
          }
        });
      } catch (error) {
        console.error('Error rendering income expense chart:', error);
        const chartEl = document.getElementById('income-expense-chart');
        if (chartEl && chartEl.parentElement) {
          chartEl.parentElement.innerHTML = '<div style="text-align:center;padding:40px;color:var(--danger)">Error loading chart</div>';
        }
      }
    };

    const renderProfitLossChart = () => {
      try {
        destroyChart('profitLoss');
        const lines = getFilteredLines();
        let income = 0, expense = 0;
        
        lines.forEach(l => {
          const entry = file.ledger_entries.find(e => e.ledger_entry_id === l.ledger_entry_id);
          const acct = file.accounts.find(a => a.code === l.account_code);
          if (!acct) return;
          if (acct.type === 'income' && !entry?.linked_invoice_id) {
            income += (l.credit_cents || 0) - (l.debit_cents || 0);
          }
          if (acct.type === 'expense') expense += (l.debit_cents || 0) - (l.credit_cents || 0);
        });

        // Add invoice income
        const invoiceIncome = getInvoiceIncome();
        Object.values(invoiceIncome).forEach(amt => income += amt);

        const profit = income - expense;
        const total = income + expense + Math.abs(Math.min(0, profit));
        const chartEl = document.getElementById('profit-loss-chart');
        if (!chartEl) return;
        
        // Restore canvas if needed
        if (!chartEl.parentElement.querySelector('canvas')) {
          chartEl.parentElement.innerHTML = '<canvas id="profit-loss-chart"></canvas>';
        }
        
        if (total === 0) {
          chartEl.parentElement.innerHTML = '<div style="text-align:center;padding:40px;color:var(--muted)">No data available for selected date range</div>';
          return;
        }
        
        const colors = getChartColors();
        const ctx = chartEl.getContext('2d');
        
        analyticsCharts['profitLoss'] = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: ['Income', 'Expenses', profit > 0 ? 'Profit' : 'Loss'],
            datasets: [{
              data: [income / 100, expense / 100, Math.abs(profit) / 100],
              backgroundColor: [colors.income, colors.expense, profit > 0 ? colors.profit : colors.expense],
              borderWidth: 0
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { 
                position: 'bottom', 
                labels: { 
                  color: colors.text,
                  padding: 12,
                  usePointStyle: true
                } 
              },
              tooltip: {
                callbacks: {
                  label: (context) => {
                    const label = context.label || '';
                    const value = fmt(context.parsed * 100, file.business.base_currency);
                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                    const percent = total > 0 ? ((context.parsed / total) * 100).toFixed(1) : 0;
                    return `${label}: ${value} (${percent}%)`;
                  }
                }
              }
            }
          }
        });
      } catch (error) {
        console.error('Error rendering profit loss chart:', error);
        const chartEl = document.getElementById('profit-loss-chart');
        if (chartEl && chartEl.parentElement) {
          chartEl.parentElement.innerHTML = '<div style="text-align:center;padding:40px;color:var(--danger)">Error loading chart</div>';
        }
      }
    };

    const renderExpenseCategoryChart = () => {
      try {
        destroyChart('expenseCategory');
        const lines = getFilteredLines();
        const categoryMap = {};
        
        lines.forEach(l => {
          const acct = file.accounts.find(a => a.code === l.account_code);
          if (!acct || acct.type !== 'expense') return;
          const amount = (l.debit_cents || 0) - (l.credit_cents || 0);
          if (amount > 0) {
            categoryMap[acct.name] = (categoryMap[acct.name] || 0) + amount;
          }
        });

        const entries = Object.entries(categoryMap).sort((a, b) => b[1] - a[1]).slice(0, 10);
        const chartEl = document.getElementById('expense-category-chart');
        if (!chartEl) return;
        
        // Restore canvas if needed
        if (!chartEl.parentElement.querySelector('canvas')) {
          chartEl.parentElement.innerHTML = '<canvas id="expense-category-chart"></canvas>';
        }
        
        if (!entries.length) {
          chartEl.parentElement.innerHTML = '<div style="text-align:center;padding:40px;color:var(--muted)">No expense data available</div>';
          return;
        }

        const colors = getChartColors();
        const ctx = chartEl.getContext('2d');
        const chartColors = [
          '#e25555', '#ff8b8b', '#ff6b6b', '#ff5252', '#ff4444',
          '#ff3333', '#ff2222', '#ff1111', '#ff0000', '#ee0000'
        ];
        
        analyticsCharts['expenseCategory'] = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: entries.map(([name]) => name.length > 25 ? name.substring(0, 25) + '...' : name),
            datasets: [{
              label: 'Expenses',
              data: entries.map(([, amount]) => amount / 100),
              backgroundColor: chartColors.slice(0, entries.length),
              borderColor: chartColors.slice(0, entries.length),
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: (context) => {
                    const total = entries.reduce((sum, [, amt]) => sum + amt, 0);
                    const percent = total > 0 ? ((context.parsed.x * 100 / total) * 100).toFixed(1) : 0;
                    return `${fmt(context.parsed.x * 100, file.business.base_currency)} (${percent}%)`;
                  }
                }
              }
            },
            scales: {
              x: { 
                ticks: { 
                  color: colors.text,
                  callback: (value) => fmt(value * 100, file.business.base_currency),
                  maxRotation: 0
                }, 
                grid: { color: colors.grid } 
              },
              y: { 
                ticks: { 
                  color: colors.text,
                  font: { size: 11 }
                }, 
                grid: { color: colors.grid } 
              }
            }
          }
        });
      } catch (error) {
        console.error('Error rendering expense category chart:', error);
        const chartEl = document.getElementById('expense-category-chart');
        if (chartEl && chartEl.parentElement) {
          chartEl.parentElement.innerHTML = '<div style="text-align:center;padding:40px;color:var(--danger)">Error loading chart</div>';
        }
      }
    };

    const renderIncomeCategoryChart = () => {
      try {
        destroyChart('incomeCategory');
        const lines = getFilteredLines();
        const categoryMap = {};
        
        // Add income from ledger entries
        lines.forEach(l => {
          const entry = file.ledger_entries.find(e => e.ledger_entry_id === l.ledger_entry_id);
          const acct = file.accounts.find(a => a.code === l.account_code);
          if (!acct || acct.type !== 'income') return;
          if (entry?.linked_invoice_id) return;
          const amount = (l.credit_cents || 0) - (l.debit_cents || 0);
          if (amount > 0) {
            categoryMap[acct.name] = (categoryMap[acct.name] || 0) + amount;
          }
        });

        // Add income from invoices
        const invoiceCategoryMap = getInvoiceIncomeByCategory();
        Object.keys(invoiceCategoryMap).forEach(cat => {
          categoryMap[cat] = (categoryMap[cat] || 0) + invoiceCategoryMap[cat];
        });

        const entries = Object.entries(categoryMap).sort((a, b) => b[1] - a[1]).slice(0, 10);
        const chartEl = document.getElementById('income-category-chart');
        if (!chartEl) return;
        
        // Restore canvas if needed
        if (!chartEl.parentElement.querySelector('canvas')) {
          chartEl.parentElement.innerHTML = '<canvas id="income-category-chart"></canvas>';
        }
        
        if (!entries.length) {
          chartEl.parentElement.innerHTML = '<div style="text-align:center;padding:40px;color:var(--muted)">No income data available</div>';
          return;
        }

        const colors = getChartColors();
        const ctx = chartEl.getContext('2d');
        const chartColors = [
          '#1fb37a', '#3dd09c', '#4dd0a1', '#66d9b3', '#7de2c5',
          '#8eebd1', '#9ff4dd', '#b0fde9', '#c1fff5', '#d2fff1'
        ];
        
        analyticsCharts['incomeCategory'] = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: entries.map(([name]) => name.length > 25 ? name.substring(0, 25) + '...' : name),
            datasets: [{
              label: 'Income',
              data: entries.map(([, amount]) => amount / 100),
              backgroundColor: chartColors.slice(0, entries.length),
              borderColor: chartColors.slice(0, entries.length),
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: (context) => {
                    const total = entries.reduce((sum, [, amt]) => sum + amt, 0);
                    const percent = total > 0 ? ((context.parsed.x * 100 / total) * 100).toFixed(1) : 0;
                    return `${fmt(context.parsed.x * 100, file.business.base_currency)} (${percent}%)`;
                  }
                }
              }
            },
            scales: {
              x: { 
                ticks: { 
                  color: colors.text,
                  callback: (value) => fmt(value * 100, file.business.base_currency),
                  maxRotation: 0
                }, 
                grid: { color: colors.grid } 
              },
              y: { 
                ticks: { 
                  color: colors.text,
                  font: { size: 11 }
                }, 
                grid: { color: colors.grid } 
              }
            }
          }
        });
      } catch (error) {
        console.error('Error rendering income category chart:', error);
        const chartEl = document.getElementById('income-category-chart');
        if (chartEl && chartEl.parentElement) {
          chartEl.parentElement.innerHTML = '<div style="text-align:center;padding:40px;color:var(--danger)">Error loading chart</div>';
        }
      }
    };

    const renderClientRevenueChart = () => {
      try {
        destroyChart('clientRevenue');
        const clientMap = {};
        
        // Add revenue from invoices (based on invoice date, not payment date)
        const invoices = getFilteredInvoices().filter(inv => inv.status !== 'void');
        invoices.forEach(inv => {
          const party = file.parties.find(p => p.party_id === inv.party_id);
          const name = party?.name || 'Unknown';
          const invTotal = invoiceTotal(inv);
          if (invTotal > 0) {
            clientMap[name] = (clientMap[name] || 0) + invTotal;
          }
        });

        const entries = Object.entries(clientMap).sort((a, b) => b[1] - a[1]).slice(0, 10);
        const chartEl = document.getElementById('client-revenue-chart');
        if (!chartEl) return;
        
        // Restore canvas if needed
        if (!chartEl.parentElement.querySelector('canvas')) {
          chartEl.parentElement.innerHTML = '<canvas id="client-revenue-chart"></canvas>';
        }
        
        if (!entries.length) {
          chartEl.parentElement.innerHTML = '<div style="text-align:center;padding:40px;color:var(--muted)">No client revenue data available</div>';
          return;
        }

        const colors = getChartColors();
        const ctx = chartEl.getContext('2d');
        const pieColors = [
          '#3a7ff5', '#5aa3ff', '#7ab5ff', '#9ac7ff', '#bad9ff',
          '#daebff', '#f0f7ff', '#ffd9ff', '#ffc7ff', '#ffb5ff'
        ];
        
        analyticsCharts['clientRevenue'] = new Chart(ctx, {
          type: 'pie',
          data: {
            labels: entries.map(([name]) => name.length > 25 ? name.substring(0, 25) + '...' : name),
            datasets: [{
              data: entries.map(([, amount]) => amount / 100),
              backgroundColor: pieColors.slice(0, entries.length),
              borderWidth: 2,
              borderColor: isDarkMode() ? '#111624' : '#ffffff'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { 
                position: 'bottom', 
                labels: { 
                  color: colors.text,
                  padding: 12,
                  usePointStyle: true,
                  font: { size: 11 }
                } 
              },
              tooltip: {
                callbacks: {
                  label: (context) => {
                    const label = context.label || '';
                    const value = fmt(context.parsed * 100, file.business.base_currency);
                    const total = entries.reduce((sum, [, amt]) => sum + amt, 0);
                    const percent = total > 0 ? ((context.parsed * 100 / total) * 100).toFixed(1) : 0;
                    return `${label}: ${value} (${percent}%)`;
                  }
                }
              }
            }
          }
        });
      } catch (error) {
        console.error('Error rendering client revenue chart:', error);
        const chartEl = document.getElementById('client-revenue-chart');
        if (chartEl && chartEl.parentElement) {
          chartEl.parentElement.innerHTML = '<div style="text-align:center;padding:40px;color:var(--danger)">Error loading chart</div>';
        }
      }
    };

    const renderMonthlySummaryChart = () => {
      try {
        destroyChart('monthlySummary');
        const lines = getFilteredLines();
        const monthlyData = {};
        
        lines.forEach(l => {
          const entry = file.ledger_entries.find(e => e.ledger_entry_id === l.ledger_entry_id);
          if (!entry || !entry.entry_date) return;
          const month = entry.entry_date.substring(0, 7);
          if (!monthlyData[month]) monthlyData[month] = { income: 0, expense: 0, profit: 0 };
          
          const acct = file.accounts.find(a => a.code === l.account_code);
          if (!acct) return;
          
          if (acct.type === 'income') {
            if (entry.linked_invoice_id) return;
            const amt = (l.credit_cents || 0) - (l.debit_cents || 0);
            monthlyData[month].income += amt;
          } else if (acct.type === 'expense') {
            const amt = (l.debit_cents || 0) - (l.credit_cents || 0);
            monthlyData[month].expense += amt;
          }
        });

        // Add invoice income
        const invoiceIncome = getInvoiceIncome();
        Object.keys(invoiceIncome).forEach(month => {
          if (!monthlyData[month]) monthlyData[month] = { income: 0, expense: 0, profit: 0 };
          monthlyData[month].income += invoiceIncome[month];
        });

        Object.keys(monthlyData).forEach(month => {
          monthlyData[month].profit = monthlyData[month].income - monthlyData[month].expense;
        });

        const months = Object.keys(monthlyData).sort();
        const chartEl = document.getElementById('monthly-summary-chart');
        if (!chartEl) return;
        
        // Restore canvas if needed
        if (!chartEl.parentElement.querySelector('canvas')) {
          chartEl.parentElement.innerHTML = '<canvas id="monthly-summary-chart"></canvas>';
        }
        
        if (!months.length) {
          chartEl.parentElement.innerHTML = '<div style="text-align:center;padding:40px;color:var(--muted)">No data available for selected date range</div>';
          return;
        }
        
        const colors = getChartColors();
        const ctx = chartEl.getContext('2d');
        
        analyticsCharts['monthlySummary'] = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: months,
            datasets: [{
              label: 'Income',
              data: months.map(m => monthlyData[m].income / 100),
              backgroundColor: colors.income + '80',
              borderColor: colors.income,
              borderWidth: 1
            }, {
              label: 'Expenses',
              data: months.map(m => monthlyData[m].expense / 100),
              backgroundColor: colors.expense + '80',
              borderColor: colors.expense,
              borderWidth: 1
            }, {
              label: 'Profit',
              data: months.map(m => monthlyData[m].profit / 100),
              backgroundColor: colors.profit + '80',
              borderColor: colors.profit,
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              intersect: false,
              mode: 'index'
            },
            plugins: {
              legend: { 
                labels: { 
                  color: colors.text,
                  usePointStyle: true
                },
                position: 'top'
              },
              tooltip: {
                callbacks: {
                  label: (context) => {
                    const label = context.dataset.label || '';
                    const value = fmt(context.parsed.y * 100, file.business.base_currency);
                    return `${label}: ${value}`;
                  }
                }
              }
            },
            scales: {
              x: { 
                ticks: { 
                  color: colors.text,
                  maxRotation: 45,
                  minRotation: 0
                }, 
                grid: { color: colors.grid } 
              },
              y: { 
                ticks: { 
                  color: colors.text,
                  callback: (value) => fmt(value * 100, file.business.base_currency)
                }, 
                grid: { color: colors.grid } 
              }
            }
          }
        });
      } catch (error) {
        console.error('Error rendering monthly summary chart:', error);
        const chartEl = document.getElementById('monthly-summary-chart');
        if (chartEl && chartEl.parentElement) {
          chartEl.parentElement.innerHTML = '<div style="text-align:center;padding:40px;color:var(--danger)">Error loading chart</div>';
        }
      }
    };

    const destroyDashboardChart = (chartId) => {
      if (dashboardCharts[chartId]) {
        dashboardCharts[chartId].destroy();
        delete dashboardCharts[chartId];
      }
    };

    const renderDashboardIncomeExpenseChart = (range) => {
      try {
        destroyDashboardChart('incomeExpense');
        const lines = getDashboardFilteredLines(range);
        const invoices = getDashboardFilteredInvoices(range);
        const monthlyData = {};

        lines.forEach(l => {
          const entry = file.ledger_entries.find(e => e.ledger_entry_id === l.ledger_entry_id);
          if (!entry || !entry.entry_date) return;
          const month = entry.entry_date.substring(0, 7);
          if (!monthlyData[month]) monthlyData[month] = { income: 0, expense: 0 };
          const acct = file.accounts.find(a => a.code === l.account_code);
          if (!acct) return;
          if (acct.type === 'income' && !entry.linked_invoice_id) {
            monthlyData[month].income += (l.credit_cents || 0) - (l.debit_cents || 0);
          } else if (acct.type === 'expense') {
            monthlyData[month].expense += (l.debit_cents || 0) - (l.credit_cents || 0);
          }
        });

        invoices.forEach(inv => {
          if (!inv.issue_date) return;
          const month = inv.issue_date.substring(0, 7);
          if (!monthlyData[month]) monthlyData[month] = { income: 0, expense: 0 };
          monthlyData[month].income += invoiceTotal(inv);
        });

        const months = Object.keys(monthlyData).sort();
        const container = document.getElementById('dashboard-income-expense-container');
        if (!container) return;
        if (!container.querySelector('canvas')) {
          container.innerHTML = '<canvas id="dashboard-income-expense-chart"></canvas>';
        }
        const chartEl = document.getElementById('dashboard-income-expense-chart');
        if (!chartEl) return;
        if (!months.length) {
          container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--muted)">No data available for selected date range</div>';
          return;
        }
        const colors = getChartColors();
        const ctx = chartEl.getContext('2d');
        dashboardCharts['incomeExpense'] = new Chart(ctx, {
          type: 'line',
          data: {
            labels: months,
            datasets: [{
              label: 'Income',
              data: months.map(m => monthlyData[m].income / 100),
              borderColor: colors.income,
              backgroundColor: colors.income + '20',
              tension: 0.35,
              fill: true
            }, {
              label: 'Expenses',
              data: months.map(m => monthlyData[m].expense / 100),
              borderColor: colors.expense,
              backgroundColor: colors.expense + '20',
              tension: 0.35,
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { intersect: false, mode: 'index' },
            plugins: {
              legend: { labels: { color: colors.text }, position: 'top' },
              tooltip: {
                callbacks: {
                  label: (context) => `${context.dataset.label}: ${fmt(context.parsed.y * 100, file.business.base_currency)}`
                }
              }
            },
            scales: {
              x: { ticks: { color: colors.text, maxRotation: 45, minRotation: 0 }, grid: { color: colors.grid } },
              y: { ticks: { color: colors.text, callback: (value) => fmt(value * 100, file.business.base_currency) }, grid: { color: colors.grid } }
            }
          }
        });
      } catch (error) {
        console.error('Error rendering dashboard income expense chart:', error);
        const container = document.getElementById('dashboard-income-expense-container');
        if (container) {
          container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--danger)">Error loading chart</div>';
        }
      }
    };

    const renderDashboardClientRevenueChart = (range) => {
      try {
        destroyDashboardChart('clientRevenue');
        const invoices = getDashboardFilteredInvoices(range);
        const clientMap = {};
        invoices.forEach(inv => {
          const party = file.parties.find(p => p.party_id === inv.party_id);
          const name = party?.name || 'Unknown';
          const invTotal = invoiceTotal(inv);
          if (invTotal > 0) {
            clientMap[name] = (clientMap[name] || 0) + invTotal;
          }
        });

        const entries = Object.entries(clientMap).sort((a, b) => b[1] - a[1]).slice(0, 8);
        const container = document.getElementById('dashboard-client-revenue-container');
        if (!container) return;
        if (!container.querySelector('canvas')) {
          container.innerHTML = '<canvas id="dashboard-client-revenue-chart"></canvas>';
        }
        const chartEl = document.getElementById('dashboard-client-revenue-chart');
        if (!chartEl) return;
        if (!entries.length) {
          container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--muted)">No client revenue data available</div>';
          return;
        }
        const colors = getChartColors();
        const ctx = chartEl.getContext('2d');
        const pieColors = [
          '#3a7ff5', '#5aa3ff', '#7ab5ff', '#9ac7ff', '#bad9ff',
          '#daebff', '#f0f7ff', '#ffd9ff'
        ];
        dashboardCharts['clientRevenue'] = new Chart(ctx, {
          type: 'pie',
          data: {
            labels: entries.map(([name]) => name.length > 25 ? name.substring(0, 25) + '...' : name),
            datasets: [{
              data: entries.map(([, amount]) => amount / 100),
              backgroundColor: pieColors.slice(0, entries.length),
              borderWidth: 2,
              borderColor: isDarkMode() ? '#111624' : '#ffffff'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'bottom', labels: { color: colors.text, padding: 12, usePointStyle: true, font: { size: 11 } } },
              tooltip: {
                callbacks: {
                  label: (context) => {
                    const label = context.label || '';
                    const value = fmt(context.parsed * 100, file.business.base_currency);
                    const total = entries.reduce((sum, [, amt]) => sum + amt, 0);
                    const percent = total > 0 ? ((context.parsed * 100 / total) * 100).toFixed(1) : 0;
                    return `${label}: ${value} (${percent}%)`;
                  }
                }
              }
            }
          }
        });
      } catch (error) {
        console.error('Error rendering dashboard client revenue chart:', error);
        const container = document.getElementById('dashboard-client-revenue-container');
        if (container) {
          container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--danger)">Error loading chart</div>';
        }
      }
    };

    const renderAnalytics = () => {
      if (!file) {
        console.warn('Cannot render analytics: no file loaded');
        return;
      }
      try {
        // Small delay to ensure DOM is ready
        setTimeout(() => {
          renderIncomeExpenseChart();
          renderProfitLossChart();
          renderExpenseCategoryChart();
          renderIncomeCategoryChart();
          renderClientRevenueChart();
          renderMonthlySummaryChart();
        }, 50);
      } catch (error) {
        console.error('Error rendering analytics:', error);
        showToast('Error loading analytics. Please try again.');
      }
    };

    // ---------- Print-friendly builders ----------
    const getLogoSrc = () => {
      if (!file) return '';
      return file.settings?.logoLightDataUrl || file.settings?.logoDarkDataUrl || '';
    };

    const createPrintContainer = (title, dateRangeLabel) => {
      const wrapper = document.createElement('div');
      wrapper.style.width = '100%';
      wrapper.style.maxWidth = '760px';
      wrapper.style.margin = '0 auto';
      wrapper.style.padding = '12px 0 8px 0';
      wrapper.style.background = '#ffffff';
      wrapper.style.color = '#111';
      wrapper.style.fontFamily = 'system-ui, -apple-system, sans-serif';
      wrapper.style.lineHeight = '1.4';
      wrapper.style.fontSize = '14px';

      const header = document.createElement('div');
      header.style.display = 'flex';
      header.style.alignItems = 'center';
      header.style.gap = '12px';
      header.style.marginBottom = '8px';

      const logo = getLogoSrc();
      if (logo) {
        const img = document.createElement('img');
        img.src = logo;
        img.style.height = '40px';
        img.style.objectFit = 'contain';
        img.style.flexShrink = '0';
        header.appendChild(img);
      }

      const heading = document.createElement('div');
      heading.innerHTML = `
        <h1 style="margin:0;font-size:20px;font-weight:700;color:#111">${title}</h1>
        <p style="margin:2px 0 0 0;color:#444;font-size:13px">${dateRangeLabel}</p>
      `;
      header.appendChild(heading);
      wrapper.appendChild(header);

      const hr = document.createElement('div');
      hr.style.borderBottom = '1px solid #e5e7eb';
      hr.style.margin = '8px 0 12px 0';
      wrapper.appendChild(hr);

      return wrapper;
    };

    const addSection = (wrapper, title, bodyEl) => {
      const section = document.createElement('section');
      section.style.marginBottom = '16px';
      const h = document.createElement('h2');
      h.textContent = title;
      h.style.margin = '0 0 6px 0';
      h.style.fontSize = '16px';
      h.style.fontWeight = '700';
      h.style.color = '#111';
      section.appendChild(h);
      section.appendChild(bodyEl);
      wrapper.appendChild(section);
    };

    const mapToTable = (map, currency, emptyText='No data', limit=10) => {
      const entries = Object.entries(map || {}).sort((a,b)=>b[1]-a[1]).slice(0, limit);
      if (!entries.length) {
        const p = document.createElement('p');
        p.textContent = emptyText;
        p.style.margin = '0';
        p.style.color = '#555';
        return p;
      }
      const table = document.createElement('table');
      table.style.width = '100%';
      table.style.borderCollapse = 'collapse';
      table.style.fontSize = '13px';
      entries.forEach(([k,v], idx)=>{
        const row = document.createElement('tr');
        row.style.borderBottom = idx === entries.length-1 ? 'none' : '1px solid #e5e7eb';
        const name = document.createElement('td');
        name.textContent = k;
        name.style.padding = '6px 4px';
        name.style.color = '#111';
        const val = document.createElement('td');
        val.textContent = fmt(v, currency);
        val.style.padding = '6px 4px';
        val.style.textAlign = 'right';
        val.style.color = '#111';
        val.style.fontWeight = '600';
        row.appendChild(name);
        row.appendChild(val);
        table.appendChild(row);
      });
      return table;
    };

    const simpleNote = (text) => {
      const p = document.createElement('p');
      p.textContent = text;
      p.style.margin = '0';
      p.style.color = '#555';
      return p;
    };

    const getCanvasImage = (canvas) => {
      if (!canvas) return null;
      const tmp = document.createElement('canvas');
      tmp.width = canvas.width;
      tmp.height = canvas.height;
      const ctx = tmp.getContext('2d');
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0,0,tmp.width,tmp.height);
      ctx.drawImage(canvas,0,0);
      return tmp.toDataURL('image/png');
    };

    const applyPrintChartTheme = (chart) => {
      if (!chart?.options) return null;
      const original = {
        legendColor: chart.options.plugins?.legend?.labels?.color,
        titleColor: chart.options.plugins?.title?.color,
        scales: {}
      };
      const textColor = '#111';
      if (chart.options.plugins?.legend?.labels) {
        chart.options.plugins.legend.labels.color = textColor;
      }
      if (chart.options.plugins?.title) {
        chart.options.plugins.title.color = textColor;
      }
      if (chart.options.scales) {
        Object.entries(chart.options.scales).forEach(([key, scale]) => {
          original.scales[key] = {
            ticksColor: scale.ticks?.color,
            titleColor: scale.title?.color,
            gridColor: scale.grid?.color
          };
          if (scale.ticks) scale.ticks.color = textColor;
          if (scale.title) scale.title.color = textColor;
          if (scale.grid) scale.grid.color = 'rgba(0,0,0,0.1)';
        });
      }
      chart.update('none');
      return () => {
        if (chart.options.plugins?.legend?.labels) {
          chart.options.plugins.legend.labels.color = original.legendColor;
        }
        if (chart.options.plugins?.title) {
          chart.options.plugins.title.color = original.titleColor;
        }
        if (chart.options.scales) {
          Object.entries(chart.options.scales).forEach(([key, scale]) => {
            const prev = original.scales[key] || {};
            if (scale.ticks) scale.ticks.color = prev.ticksColor;
            if (scale.title) scale.title.color = prev.titleColor;
            if (scale.grid) scale.grid.color = prev.gridColor;
          });
        }
        chart.update('none');
      };
    };

    const chartBlock = (canvasId) => {
      const container = document.createElement('div');
      container.style.border = '1px solid #e5e7eb';
      container.style.borderRadius = '8px';
      container.style.padding = '8px';
      container.style.background = '#ffffff';
      container.style.minHeight = '60px';
      const canvas = document.getElementById(canvasId);
      // Nudge chart text to black before capture
      let restoreTheme = null;
      if (window.Chart && Chart.getChart) {
        const ch = Chart.getChart(canvasId);
        restoreTheme = applyPrintChartTheme(ch);
      }
      const imgSrc = getCanvasImage(canvas);
      if (restoreTheme) restoreTheme();
      if (imgSrc) {
        const img = document.createElement('img');
        img.src = imgSrc;
        img.style.width = '260px';
        img.style.height = '260px';
        img.style.maxWidth = '100%';
        img.style.objectFit = 'contain';
        img.style.display = 'block';
        img.style.margin = '0 auto';
        container.appendChild(img);
        const legend = chartLegend(canvasId);
        if (legend) container.appendChild(legend);
      } else {
        container.appendChild(simpleNote('No data'));
      }
      return container;
    };

    const chartLegend = (canvasId) => {
      if (!window.Chart || !Chart.getChart) return null;
      const chart = Chart.getChart(canvasId);
      if (!chart || !chart.data?.datasets?.length) return null;
      const wrap = document.createElement('div');
      wrap.style.display = 'flex';
      wrap.style.flexWrap = 'wrap';
      wrap.style.gap = '8px 12px';
      wrap.style.marginTop = '8px';
      const currency = file?.business?.base_currency || 'USD';
      const addItem = (label, color, val) => {
        const item = document.createElement('div');
        item.style.display = 'flex';
        item.style.alignItems = 'center';
        item.style.gap = '6px';
        const swatch = document.createElement('span');
        swatch.style.width = '10px';
        swatch.style.height = '10px';
        swatch.style.borderRadius = '50%';
        swatch.style.background = color || '#1d4ed8';
        swatch.style.border = '1px solid #ccc';
        const text = document.createElement('span');
        text.textContent = `${label}${val !== undefined ? `: ${fmt((Number(val)||0)*100, currency)}` : ''}`;
        text.style.fontSize = '12px';
        text.style.color = '#111';
        item.appendChild(swatch);
        item.appendChild(text);
        wrap.appendChild(item);
      };

      chart.data.datasets.forEach(ds => {
        const colors = Array.isArray(ds.backgroundColor) ? ds.backgroundColor : [ds.backgroundColor || '#1d4ed8'];
        const dataArray = Array.isArray(ds.data) ? ds.data : [ds.data];
        const labels = Array.isArray(chart.data.labels) ? chart.data.labels : [];
        if (chart.config?.type === 'doughnut' || chart.config?.type === 'pie') {
          dataArray.forEach((val, idx) => {
            addItem(labels[idx] || ds.label || 'Series', colors[idx % colors.length], val);
          });
        } else {
          const total = dataArray.reduce((s,n)=>s+(Number(n)||0),0);
          addItem(ds.label || 'Series', colors[0], total);
        }
      });
      return wrap.childNodes.length ? wrap : null;
    };

    const postedLinesInRange = () => {
      const { start, end } = getReportsDateRange();
      return postedLines().filter(l=>{
        const entry = file.ledger_entries.find(e=>e.ledger_entry_id===l.ledger_entry_id);
        return entry && entry.entry_date >= start && entry.entry_date <= end;
      });
    };

    const plSummaryData = () => {
      const { start, end } = getReportsDateRange();
      const lines = postedLinesInRange();
      let income=0, expense=0;
      lines.forEach(l=>{
        const acct = file.accounts.find(a=>a.code===l.account_code);
        if (!acct) return;
        if (acct.type==='income') income += (l.credit_cents||0)-(l.debit_cents||0);
        if (acct.type==='expense') expense += (l.debit_cents||0)-(l.credit_cents||0);
      });
      const invoices = file.invoices.filter(inv => inv.issue_date >= start && inv.issue_date <= end);
      invoices.forEach(inv => { income += invoiceSubtotal(inv); });
      return { income, expense, net: income - expense };
    };

    const expenseSummaryMap = () => {
      const map = {};
      postedLinesInRange().forEach(l=>{
        const acct = file.accounts.find(a=>a.code===l.account_code);
        if (!acct || acct.type!=='expense') return;
        const delta = (l.debit_cents||0)-(l.credit_cents||0);
        map[acct.name] = (map[acct.name]||0) + delta;
      });
      return map;
    };

    const projectProfitMap = () => {
      const map = {};
      postedLinesInRange().forEach(l=>{
        const entry = file.ledger_entries.find(e=>e.ledger_entry_id===l.ledger_entry_id);
        if (!entry?.project_id) return;
        const acct = file.accounts.find(a=>a.code===l.account_code);
        if (!acct) return;
        const delta = (l.credit_cents||0)-(l.debit_cents||0);
        map[entry.project_id] = (map[entry.project_id]||0) + delta;
      });
      const named = {};
      Object.entries(map).forEach(([pid, val])=>{
        const project = file.projects.find(p=>p.project_id===pid);
        const name = project?.name || 'Unknown Project';
        named[name] = val;
      });
      return named;
    };

    const buildPrintAnalytics = () => {
      const { start, end } = getDateRange();
      const wrapper = createPrintContainer('Analytics Report', `Date Range: ${start} to ${end}`);
      const chartSections = [
        { title:'Income vs Expenses Trend', id:'income-expense-chart' },
        { title:'Profit & Loss', id:'profit-loss-chart' },
        { title:'Expense by Category', id:'expense-category-chart' },
        { title:'Income by Category', id:'income-category-chart' },
        { title:'Client Revenue', id:'client-revenue-chart' },
        { title:'Monthly Summary', id:'monthly-summary-chart' }
      ];
      chartSections.forEach(sec=>{
        addSection(wrapper, sec.title, chartBlock(sec.id));
      });
      return wrapper;
    };

    const buildPrintReports = () => {
      const { start, end } = getReportsDateRange();
      const wrapper = createPrintContainer('Financial Reports', `Date Range: ${start} to ${end}`);
      const pl = plSummaryData();
      const plTable = document.createElement('table');
      plTable.style.width = '100%';
      plTable.style.borderCollapse = 'collapse';
      [['Income', pl.income], ['Expenses', pl.expense], ['Net', pl.net]].forEach(([label,val], idx)=>{
        const row = document.createElement('tr');
        row.style.borderBottom = idx===2 ? 'none' : '1px solid #e5e7eb';
        const name = document.createElement('td');
        name.textContent = label;
        name.style.padding = '8px 4px';
        name.style.fontWeight = idx===2 ? '700' : '600';
        const num = document.createElement('td');
        num.textContent = fmt(val, file.business.base_currency);
        num.style.padding = '8px 4px';
        num.style.textAlign = 'right';
        num.style.fontWeight = idx===2 ? '700' : '600';
        num.style.color = idx===2 ? '#1d4ed8' : '#111';
        row.appendChild(name);
        row.appendChild(num);
        plTable.appendChild(row);
      });
      addSection(wrapper, 'Profit & Loss', plTable);

      addSection(wrapper, 'Expense by Category', mapToTable(expenseSummaryMap(), file.business.base_currency, 'No expenses found'));
      addSection(wrapper, 'Client Revenue', mapToTable(clientRevenue(), file.business.base_currency, 'No client revenue'));
      addSection(wrapper, 'Project Profitability', mapToTable(projectProfitMap(), file.business.base_currency, 'No project data'));
      addSection(wrapper, 'Tax Summary', mapToTable(taxSummary(), file.business.base_currency, 'No tax data'));

      return wrapper;
    };

    const addImageToPdf = (pdf, imgData, canvas, margin = 10) => {
      const pageWidth = 210;   // mm (A4)
      const pageHeight = 297;  // mm (A4)
      const maxWidth = pageWidth - margin * 2;
      const maxHeight = pageHeight - margin * 2;
      const aspect = canvas.height / canvas.width;
      let targetWidth = maxWidth;
      let targetHeight = targetWidth * aspect;
      if (targetHeight > maxHeight) {
        targetHeight = maxHeight;
        targetWidth = targetHeight / aspect;
      }
      const x = (pageWidth - targetWidth) / 2;
      const y = (pageHeight - targetHeight) / 2;
      pdf.addImage(imgData, 'PNG', x, y, targetWidth, targetHeight, undefined, 'FAST');
    };

    const exportAnalyticsPDF = async () => {
      if (!window.jspdf || !window.html2canvas) {
        alert('PDF export libraries not loaded. Please refresh the page.');
        return;
      }
      
      const { jsPDF } = window.jspdf;
      const printable = buildPrintAnalytics();
      if (!printable) {
        alert('No data to export');
        return;
      }
      
      // Show loading indicator
      showToast('Generating PDF...');
      
      printable.style.position = 'absolute';
      printable.style.left = '-9999px';
      printable.style.width = '210mm';
      printable.style.padding = '20px';
      document.body.appendChild(printable);
      
      try {
        const canvas = await html2canvas(printable, {
          scale: 2,
          useCORS: true,
          logging: false,
          backgroundColor: '#ffffff',
          width: printable.scrollWidth,
          height: printable.scrollHeight,
          windowWidth: printable.scrollWidth,
          windowHeight: printable.scrollHeight
        });
        document.body.removeChild(printable);
        
        const imgData = canvas.toDataURL('image/png', 0.95);
        const pdf = new jsPDF('p', 'mm', 'a4');
        
        // Add business name if available
        if (file && file.business && file.business.name) {
          pdf.setFontSize(16);
          pdf.text(file.business.name, 10, 15);
          pdf.setFontSize(10);
          pdf.text('Analytics Report', 10, 22);
          const { start, end } = getDateRange();
          pdf.text(`Date Range: ${start} to ${end}`, 10, 28);
          pdf.setDrawColor(200, 200, 200);
          pdf.line(10, 32, 200, 32);
        }
        
        addImageToPdf(pdf, imgData, canvas, file && file.business && file.business.name ? 35 : 10);
        
        const dateStr = new Date().toISOString().split('T')[0];
        pdf.save(`Analytics_Report_${dateStr}.pdf`);
        setTimeout(() => showToast('PDF exported successfully!'), 500);
      } catch (error) {
        console.error('PDF export error:', error);
        document.body.removeChild(printable);
        alert('Error generating PDF: ' + (error.message || 'Unknown error'));
      }
    };

    const printAnalytics = () => {
      const printable = buildPrintAnalytics();
      if (!printable) {
        alert('No data to print');
        return;
      }
      
      // Enhance printable for better printing
      printable.style.width = '210mm';
      printable.style.margin = '0 auto';
      printable.style.padding = '20mm';
      
      const printWindow = window.open('', '_blank');
      if (!printWindow) {
        alert('Please allow popups to print');
        return;
      }
      
      const { start, end } = getDateRange();
      const businessName = file && file.business && file.business.name ? file.business.name : 'Analytics Report';
      
      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>Analytics Report - ${businessName}</title>
          <meta charset="utf-8">
          <style>
            @page { 
              size: A4 portrait; 
              margin: 12mm; 
            }
            * {
              box-sizing: border-box;
            }
            body { 
              font-family: system-ui, -apple-system, "Segoe UI", sans-serif; 
              padding: 0; 
              margin: 0;
              background: #ffffff; 
              color: #111; 
              line-height: 1.6;
            }
            img { 
              max-width: 100%; 
              height: auto;
              display: block;
              margin: 0 auto;
            }
            table { 
              border-collapse: collapse; 
              width: 100%;
              margin: 10px 0;
            }
            table td, table th {
              padding: 8px;
              border-bottom: 1px solid #e5e7eb;
            }
            h1, h2 {
              margin: 16px 0 8px 0;
            }
            section {
              page-break-inside: avoid;
              margin-bottom: 20px;
            }
            @media print {
              body { 
                print-color-adjust: exact;
                -webkit-print-color-adjust: exact;
              }
              section {
                page-break-inside: avoid;
              }
            }
          </style>
        </head>
        <body>
          <div style="text-align: center; margin-bottom: 20px; border-bottom: 2px solid #e5e7eb; padding-bottom: 10px;">
            <h1 style="margin: 0; font-size: 24px;">${businessName}</h1>
            <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">Analytics Report</p>
            <p style="margin: 5px 0 0 0; color: #666; font-size: 12px;">Date Range: ${start} to ${end}</p>
            <p style="margin: 5px 0 0 0; color: #666; font-size: 11px;">Generated: ${new Date().toLocaleString()}</p>
          </div>
          ${printable.outerHTML}
        </body>
        </html>
      `);
      printWindow.document.close();
      
      // Wait for images to load before printing
      printWindow.onload = () => {
        setTimeout(() => {
          printWindow.print();
        }, 250);
      };
    };

    const exportReportsPDF = async () => {
      const { jsPDF } = window.jspdf;
      const printable = buildPrintReports();
      if (!printable) return;
      printable.style.position = 'absolute';
      printable.style.left = '-9999px';
      document.body.appendChild(printable);
      
      try {
        const canvas = await html2canvas(printable, {
          scale: 2,
          useCORS: true,
          logging: false,
          backgroundColor: '#ffffff'
        });
        document.body.removeChild(printable);
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jsPDF('p', 'mm', 'a4');
        addImageToPdf(pdf, imgData, canvas);
        pdf.save('Financial_Reports.pdf');
      } catch (error) {
        document.body.removeChild(printable);
        alert('Error generating PDF: ' + error.message);
      }
    };

    const printReports = () => {
      const printable = buildPrintReports();
      if (!printable) return;
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>Reports</title>
          <style>
            @page { size: A4 portrait; margin: 12mm; }
            body { font-family: system-ui, sans-serif; padding: 0; background: #ffffff; color: #111; }
            img { max-width: 100%; }
            table { border-collapse: collapse; }
          </style>
        </head>
        <body>${printable.outerHTML}</body>
        </html>
      `);
      printWindow.document.close();
      printWindow.onload = () => printWindow.print();
    };

    // ---------- Dashboard ----------
    const buildDashboardActivityRow = (activityItem) => {
      const row = document.createElement('div');
      row.className = 'row';
      row.style.justifyContent = 'space-between';
      row.style.paddingBottom = '12px';
      row.style.marginBottom = '8px';
      row.style.borderBottom = '1px solid var(--border)';
      const statusDot = activityItem.status ? `<span class="status-dot ${activityItem.status==='paid'?'status-posted':'status-void'}"></span>` : '';
      row.innerHTML = `<span style="color:var(--text);font-size:0.95rem;line-height:1.6">${statusDot}${activityItem.text}</span><span style="font-weight:600;color:var(--text);line-height:1.6">${fmt(activityItem.amount,file.business.base_currency)}</span>`;
      return row;
    };

    const renderDashboardActivityList = (activity) => {
      const dashboardSection = $$('section[data-section="dashboard"]')[0];
      if (!dashboardSection) return;
      const cards = dashboardSection.querySelectorAll('.card');
      if (cards.length < 2) return;
      const overviewCard = cards[0];
      const activityCard = cards[1];
      const act = activityCard.querySelector('#dashboard-activity');
      if (!act) return;

      activityCard.style.minHeight = `${overviewCard.getBoundingClientRect().height}px`;
      act.innerHTML = '';
      if (!activity.length) return;

      activity.forEach(item => act.appendChild(buildDashboardActivityRow(item)));
      const lastRow = act.lastElementChild;
      if (lastRow) lastRow.style.borderBottom = 'none';
    };

    const renderDashboard = () => {
      if (!file) return;
      const kpi = $('#dashboard-kpis'); kpi.innerHTML = '';
      const { start, end } = getDashboardRange();
      const allTime = isAllTimeRange(start, end);
      $$('.date-preset-btn[data-for="dashboard"]').forEach(btn => btn.classList.toggle('active', btn.dataset.preset === getDashboardPreset()));
      updateDashboardRangeLabel({ start, end });
      const posted = postedLines().filter(l => {
        const entry = file.ledger_entries.find(e=>e.ledger_entry_id===l.ledger_entry_id);
        if (!entry) return false;
        if (!entry.entry_date) return allTime;
        return allTime || (entry.entry_date >= start && entry.entry_date <= end);
      });
      const incomeFromLedger = posted
        .filter(l=>file.accounts.find(a=>a.code===l.account_code)?.type==='income')
        .filter(l=>{
          const entry = file.ledger_entries.find(e=>e.ledger_entry_id===l.ledger_entry_id);
          return !entry?.linked_invoice_id;
        })
        .reduce((s,l)=>s+(l.credit_cents||0)-(l.debit_cents||0),0);
      const expense = posted.filter(l=>file.accounts.find(a=>a.code===l.account_code)?.type==='expense')
        .reduce((s,l)=>s+(l.debit_cents||0)-(l.credit_cents||0),0);
      const invoiceIncome = file.invoices.filter(inv => {
        if (inv.status === 'void') return false;
        if (!inv.issue_date) return allTime;
        return allTime || (inv.issue_date >= start && inv.issue_date <= end);
      }).reduce((s, inv)=>s+invoiceTotal(inv),0);
      const income = incomeFromLedger + invoiceIncome;
      // #region agent log
      fetch('http://127.0.0.1:7242/ingest/251e5d6a-3d5b-41b3-b796-d6cf2eef1b0c',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'Checkmark Accountant V5.html:renderDashboard',message:'renderDashboard:totals',data:{income,expense,postedCount:posted.length,ledgerEntries:file.ledger_entries.length,ledgerLines:file.ledger_lines.length},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'B'})}).catch(()=>{});
      // #endregion
      const net = income - expense;
      const openInvoices = file.invoices.filter(i=>i.status!=='paid').length;
      const cards = [
        { label:'Income', value:fmt(income,file.business.base_currency) },
        { label:'Expenses', value:fmt(expense,file.business.base_currency) },
        { label:'Net', value:fmt(net,file.business.base_currency) },
        { label:'Open Invoices', value:openInvoices }
      ];
      cards.forEach(c=>{
        const div = document.createElement('div');
        div.className = 'card';
        div.style.padding = '24px';
        div.innerHTML = `<div style="font-size:0.8rem;color:var(--muted);margin-bottom:12px;font-weight:600;text-transform:uppercase;letter-spacing:0.6px;line-height:1.4">${c.label}</div><div style="font-size:1.85rem;font-weight:700;line-height:1.3;color:var(--text)">${c.value}</div>`;
        kpi.appendChild(div);
      });
      const activity = [];
      file.invoices.forEach(i=>{
        const party = file.parties.find(p=>p.party_id===i.party_id);
        const clientName = party ? ` - ${party.name}` : '';
        activity.push({ date:i.issue_date, text:`Invoice #${i.number}${clientName} ${i.status}`, amount:invoiceTotal(i), status:i.status });
      });
      file.transactions.forEach(t=>activity.push({ date:t.date, text:`Txn ${t.type}`, amount:t.amount_cents }));
      activity.sort((a,b)=>a.date>b.date?-1:1);
      renderDashboardActivityList(activity);
      renderDashboardClientRevenueChart({ start, end });
    };

    // ---------- Event wiring ----------
    const bindUI = () => {
      // #region agent log
      logDebug('bindUI:entry','bindUI called',{},'B');
      // #endregion
      try {
        const tabButtons = $$('nav.tabs button');
        // #region agent log
        logDebug('bindUI:tabs','Tab buttons found',{count:tabButtons.length},'B');
        // #endregion
        tabButtons.forEach(btn => btn.onclick = () => setTab(btn.dataset.tab));
        const addInvoice = $('#add-invoice'); if (addInvoice) addInvoice.onclick = () => editInvoice({});
        const quickAddInvoice = $('#quick-add-invoice'); if (quickAddInvoice) quickAddInvoice.onclick = () => editInvoice({});
        const addTransaction = $('#add-transaction'); if (addTransaction) addTransaction.onclick = () => editTxn({});
        const quickAddTransaction = $('#quick-add-transaction'); if (quickAddTransaction) quickAddTransaction.onclick = () => editTxn({});
        const exportInvoicesJsonBtn = $('#export-invoices-json'); if (exportInvoicesJsonBtn) exportInvoicesJsonBtn.onclick = () => exportInvoicesData('json');
        const exportInvoicesCsvBtn = $('#export-invoices-csv'); if (exportInvoicesCsvBtn) exportInvoicesCsvBtn.onclick = () => exportInvoicesData('csv');
        const importInvoicesBtn = $('#import-invoices-btn'); if (importInvoicesBtn) importInvoicesBtn.onclick = () => { const inp = $('#import-invoices-file'); if (inp) inp.click(); };
        const importInvoicesFile = $('#import-invoices-file'); if (importInvoicesFile) importInvoicesFile.onchange = (e)=>{ if (e.target.files?.[0]) { handleEntityImportFile(e.target.files[0], importInvoicesData); e.target.value=''; } };
        const invoiceSearch = $('#invoice-search'); if (invoiceSearch) invoiceSearch.oninput = () => renderInvoices();
        const exportTxnJsonBtn = $('#export-txn-json'); if (exportTxnJsonBtn) exportTxnJsonBtn.onclick = () => exportTransactionsData('json');
        const exportTxnCsvBtn = $('#export-txn-csv'); if (exportTxnCsvBtn) exportTxnCsvBtn.onclick = () => exportTransactionsData('csv');
        const importTxnBtn = $('#import-txn-btn'); if (importTxnBtn) importTxnBtn.onclick = () => { const inp = $('#import-txn-file'); if (inp) inp.click(); };
        const importTxnFile = $('#import-txn-file'); if (importTxnFile) importTxnFile.onchange = (e)=>{ if (e.target.files?.[0]) { handleEntityImportFile(e.target.files[0], importTransactionsData); e.target.value=''; } };
        const txnSearch = $('#txn-search'); if (txnSearch) txnSearch.oninput = () => renderTransactions();
        const exportClientsJsonBtn = $('#export-clients-json'); if (exportClientsJsonBtn) exportClientsJsonBtn.onclick = () => exportClientsData('json');
        const exportClientsCsvBtn = $('#export-clients-csv'); if (exportClientsCsvBtn) exportClientsCsvBtn.onclick = () => exportClientsData('csv');
        const importClientsBtn = $('#import-clients-btn'); if (importClientsBtn) importClientsBtn.onclick = () => { const inp = $('#import-clients-file'); if (inp) inp.click(); };
        const importClientsFile = $('#import-clients-file'); if (importClientsFile) importClientsFile.onchange = (e)=>{ if (e.target.files?.[0]) { handleEntityImportFile(e.target.files[0], importClientsData); e.target.value=''; } };
        const exportServicesJsonBtn = $('#export-services-json'); if (exportServicesJsonBtn) exportServicesJsonBtn.onclick = () => exportServicesData('json');
        const exportServicesCsvBtn = $('#export-services-csv'); if (exportServicesCsvBtn) exportServicesCsvBtn.onclick = () => exportServicesData('csv');
        const importServicesBtn = $('#import-services-btn'); if (importServicesBtn) importServicesBtn.onclick = () => { const inp = $('#import-services-file'); if (inp) inp.click(); };
        const importServicesFile = $('#import-services-file'); if (importServicesFile) importServicesFile.onchange = (e)=>{ if (e.target.files?.[0]) { handleEntityImportFile(e.target.files[0], importServicesData); e.target.value=''; } };
        const openCalculator = $('#open-calculator'); if (openCalculator) openCalculator.onclick = toggleCalculator;
        const openNote = $('#open-note'); if (openNote) openNote.onclick = toggleNote;
        const addClient = $('#add-client'); if (addClient) addClient.onclick = () => editClient({});
        const addProject = $('#add-project'); if (addProject) addProject.onclick = () => editProject({});
        const addService = $('#add-service'); if (addService) addService.onclick = () => editService({});
        const closePanelBtn = $('#close-panel'); if (closePanelBtn) closePanelBtn.onclick = closePanel;
        const runPl = $('#run-pl'); if (runPl) runPl.onclick = runPL;
        const runExpenseSummary = $('#run-expense-summary'); if (runExpenseSummary) runExpenseSummary.onclick = () => renderSummary(summaryByAccount('expense'), $('#report-expense'));
        const runClientSummary = $('#run-client-summary'); if (runClientSummary) runClientSummary.onclick = () => renderSummary(clientRevenue(), $('#report-client'));
        const runProjectSummary = $('#run-project-summary'); if (runProjectSummary) runProjectSummary.onclick = () => renderSummary(projectProfit(), $('#report-project'));
        const runTaxSummary = $('#run-tax-summary'); if (runTaxSummary) runTaxSummary.onclick = () => renderTaxSummary();
        const calcGRT = $('#calc-grt'); if (calcGRT) calcGRT.onclick = () => {
          const frequency = file?.settings?.grt_filing_frequency || 'monthly';
          let range = lastFullFilingPeriod(frequency);
          const lastBase = grtBaseForRange(range.start, range.end);
          if (!lastBase) {
            range = currentFilingPeriod(frequency);
          }
          setReportsRange(range.start, range.end);
          refreshReports();
        };
        const calcGRTYear = $('#calc-grt-year'); if (calcGRTYear) calcGRTYear.onclick = () => {
          const year = Number($('#grt-year')?.value) || new Date().getFullYear();
          const range = yearRange(year);
          setReportsRange(range.start, range.end);
          refreshReports();
        };
        // Reports date preset handlers
        $$('.date-preset-btn[data-for="reports"]').forEach(btn => {
          btn.onclick = () => {
            setDatePreset(btn.dataset.preset, 'reports');
            refreshReports();
          };
        });
        // Dashboard date preset handlers
        $$('.date-preset-btn[data-for="dashboard"]').forEach(btn => {
          btn.onclick = () => {
            setDashboardPreset(btn.dataset.preset);
            renderDashboard();
          };
        });
        const refreshReportsBtn = $('#refresh-reports'); if (refreshReportsBtn) refreshReportsBtn.onclick = refreshReports;
        const reportsStart = $('#reports-start'); if (reportsStart) reportsStart.onchange = () => { $$('.date-preset-btn[data-for="reports"]').forEach(b => b.classList.remove('active')); };
        const reportsEnd = $('#reports-end'); if (reportsEnd) reportsEnd.onchange = () => { $$('.date-preset-btn[data-for="reports"]').forEach(b => b.classList.remove('active')); };
        const exportReportsPDFBtn = $('#export-reports-pdf'); if (exportReportsPDFBtn) exportReportsPDFBtn.onclick = exportReportsPDF;
        const printReportsBtn = $('#print-reports'); if (printReportsBtn) printReportsBtn.onclick = printReports;
        // Analytics event handlers
        $$('.date-preset-btn[data-for="analytics"]').forEach(btn => {
          btn.onclick = () => {
            setDatePreset(btn.dataset.preset, 'analytics');
            showToast('Updating analytics...');
            setTimeout(() => renderAnalytics(), 100);
          };
        });
        const refreshAnalytics = $('#refresh-analytics'); 
        if (refreshAnalytics) {
          refreshAnalytics.onclick = () => {
            showToast('Refreshing analytics...');
            setTimeout(() => renderAnalytics(), 100);
          };
        }
        const exportAnalyticsPDFBtn = $('#export-analytics-pdf'); if (exportAnalyticsPDFBtn) exportAnalyticsPDFBtn.onclick = exportAnalyticsPDF;
        const printAnalyticsBtn = $('#print-analytics'); if (printAnalyticsBtn) printAnalyticsBtn.onclick = printAnalytics;
        const analyticsStart = $('#analytics-start'); 
        if (analyticsStart) {
          analyticsStart.onchange = () => { 
            $$('.date-preset-btn[data-for="analytics"]').forEach(b => b.classList.remove('active')); 
            // Validate date range
            const endInput = $('#analytics-end');
            if (endInput && analyticsStart.value && endInput.value && analyticsStart.value > endInput.value) {
              showToast('Start date cannot be after end date');
              return;
            }
            // Auto-refresh analytics when date changes
            if (file) {
              showToast('Updating analytics...');
              setTimeout(() => renderAnalytics(), 100);
            }
          };
        }
        const analyticsEnd = $('#analytics-end'); 
        if (analyticsEnd) {
          analyticsEnd.onchange = () => { 
            $$('.date-preset-btn[data-for="analytics"]').forEach(b => b.classList.remove('active')); 
            // Validate date range
            const startInput = $('#analytics-start');
            if (startInput && analyticsEnd.value && startInput.value && startInput.value > analyticsEnd.value) {
              showToast('End date cannot be before start date');
              return;
            }
            // Auto-refresh analytics when date changes
            if (file) {
              showToast('Updating analytics...');
              setTimeout(() => renderAnalytics(), 100);
            }
          };
        }
        const normalizeCurrencyCode = (value) => String(value || '').trim().toUpperCase();
        const isValidCurrency = (code) => {
          if (!code || code.length !== 3) return false;
          try {
            new Intl.NumberFormat('en-US', { style: 'currency', currency: code }).format(0);
            return true;
          } catch (e) {
            return false;
          }
        };
        const editBusinessInfo = $('#edit-business-info'); if (editBusinessInfo) editBusinessInfo.onclick = () => {
          if (!file?.business) return;
          showModal(`
            <div class="stack">
              <h3>Edit Business Info</h3>
              <label>Business Name</label>
              <input type="text" id="edit-business-name" placeholder="Business Name" value="${file.business.name || ''}">
              <label style="margin-top:16px">Default Currency (ISO)</label>
              <input type="text" id="edit-business-currency" placeholder="USD" maxlength="3" style="text-transform:uppercase" value="${file.business.base_currency || 'USD'}">
              <p style="font-size:0.9rem; color:var(--muted); margin-top:8px">Use a 3-letter ISO 4217 code (e.g., USD, EUR).</p>
              <div class="row" style="justify-content:flex-end; gap:8px; margin-top:16px">
                <button data-cancel>Cancel</button>
                <button data-confirm class="primary">Save</button>
              </div>
            </div>
          `, () => {
            const nameInput = $('#edit-business-name');
            const currencyInput = $('#edit-business-currency');
            const nextName = nameInput?.value?.trim() || '';
            const nextCode = normalizeCurrencyCode(currencyInput?.value);
            if (!nextName) {
              showToast('Business name cannot be empty');
              return;
            }
            if (!nextCode) {
              showToast('Currency code is required');
              return;
            }
            if (!isValidCurrency(nextCode)) {
              showToast('Invalid currency code');
              return;
            }
            file.business.name = nextName;
            file.business.base_currency = nextCode;
            file.business.updated_at = nowIso();
            const listEntry = businessList.find(b => b.id === activeId);
            if (listEntry) listEntry.name = nextName;
            saveList();
            saveFile();
            renderBusinessSelector();
            renderAll();
          });
        };
        const logoChip = $('#logo-chip'); if (logoChip) logoChip.onclick = () => {
          if (!file) return;
          const currentTheme = file.settings.theme || 'system';
          const nextTheme = currentTheme === 'dark' ? 'light' : 'dark';
          file.settings.theme = nextTheme;
          saveFile();
          applyTheme();
          const themeSelect = $('#theme-select');
          if (themeSelect) themeSelect.value = nextTheme;
          const dashboardSection = $$('section[data-section="dashboard"]')[0];
          if (dashboardSection && !dashboardSection.classList.contains('hidden')) renderDashboard();
          if ($$('section[data-section="analytics"]')[0] && !$$('section[data-section="analytics"]')[0].classList.contains('hidden')) renderAnalytics();
        };
        const themeSelect = $('#theme-select'); if (themeSelect) themeSelect.onchange = (e)=>{ if(file) { file.settings.theme = e.target.value; saveFile(); applyTheme(); const dashboardSection = $$('section[data-section="dashboard"]')[0]; if (dashboardSection && !dashboardSection.classList.contains('hidden')) renderDashboard(); if ($$('section[data-section="analytics"]')[0] && !$$('section[data-section="analytics"]')[0].classList.contains('hidden')) renderAnalytics(); } };
        const splashVideoToggle = $('#splash-video-toggle'); if (splashVideoToggle) splashVideoToggle.onclick = () => {
          if (!file) return;
          const next = !(file.settings.show_splash_video !== false);
          file.settings.show_splash_video = next;
          splashVideoToggle.textContent = next ? 'On' : 'Off';
          saveFile();
        };

        const logoVariant = $('#logo-variant'); if (logoVariant) logoVariant.onchange = (e)=>{ if(file) { file.settings.logoVariant = e.target.value; saveFile(); applyTheme(); } };
        const logoLight = $('#logo-light'); if (logoLight) logoLight.onchange = (e)=>readFileAsDataUrl(e.target.files[0], url=>{ if(file) { file.settings.logoLightDataUrl=url; saveFile(); applyTheme(); } });
        const logoDark = $('#logo-dark'); if (logoDark) logoDark.onchange = (e)=>readFileAsDataUrl(e.target.files[0], url=>{ if(file) { file.settings.logoDarkDataUrl=url; saveFile(); applyTheme(); } });
        const defaultTaxPercent = $('#default-tax-percent'); if (defaultTaxPercent) defaultTaxPercent.oninput = (e)=>{ if(file) { const val = Math.max(0, Number(e.target.value)||0); file.settings.default_tax_percent = val; saveFile(); } };
        const grtPercent = $('#grt-percent'); if (grtPercent) grtPercent.oninput = (e)=>{ if(file) { const val = Math.max(0, Number(e.target.value)||0); file.settings.grt_percent = val; saveFile(); if (isReportsActive()) refreshReports(); } };
        const grtBasis = $('#grt-basis'); if (grtBasis) grtBasis.onchange = (e)=>{ if(file) { file.settings.grt_basis = e.target.value; saveFile(); if (isReportsActive()) refreshReports(); } };
        const grtFilingFrequency = $('#grt-filing-frequency'); if (grtFilingFrequency) grtFilingFrequency.onchange = (e)=>{ if(file) { file.settings.grt_filing_frequency = e.target.value; saveFile(); if (isReportsActive()) refreshReports(); } };
        const headerImage = $('#header-image'); if (headerImage) headerImage.onchange = (e)=>readFileAsDataUrl(e.target.files[0], url=>{ 
          if(file) { 
            file.settings.headerImageDataUrl=url; 
            if (!file.settings.headerImageFit) file.settings.headerImageFit = 'cover';
            if (!file.settings.headerImageOpacity) file.settings.headerImageOpacity = 10;
            saveFile(); 
            applyTheme(); 
            updateHeaderImagePreview();
          } 
        });
        const headerImageFit = $('#header-image-fit'); if (headerImageFit) headerImageFit.onchange = (e) => {
          if(file) {
            file.settings.headerImageFit = e.target.value;
            saveFile();
            applyTheme();
          }
        };
        const headerImageOpacity = $('#header-image-opacity'); if (headerImageOpacity) {
          headerImageOpacity.oninput = (e) => {
            const value = parseInt(e.target.value);
            $('#header-opacity-value').textContent = value + '%';
            if(file) {
              file.settings.headerImageOpacity = value;
              saveFile();
              applyTheme();
            }
          };
        }
        const removeHeaderImage = $('#remove-header-image'); if (removeHeaderImage) removeHeaderImage.onclick = () => {
          if(file) {
            file.settings.headerImageDataUrl = null;
            saveFile();
            applyTheme();
            updateHeaderImagePreview();
          }
        };
        const exportJson = $('#export-json'); if (exportJson) exportJson.onclick = () => {
          if (!file) {
            showToast('No business data to export');
            return;
          }
          const exportData = {
            ...file,
            export_metadata: {
              exported_at: nowIso(),
              exported_by: 'Checkmark Accountant V5',
              version: '5.0'
            }
          };
          const filename = `${file.business.name.replace(/[^a-z0-9]/gi, '_')}-v5-${today()}.json`;
          download(JSON.stringify(exportData, null, 2), filename);
          showToast('Business data exported successfully');
        };
        const exportAuditLogBtn = $('#export-audit-log'); if (exportAuditLogBtn) exportAuditLogBtn.onclick = exportAuditLog;
        const exportAll = $('#export-all'); if (exportAll) exportAll.onclick = () => {
          if (!businessList.length) {
            showToast('No businesses to export');
            return;
          }
          const allData = {
            schema_version: 5,
            export_type: 'all_businesses',
            exported_at: nowIso(),
            exported_by: 'Checkmark Accountant V5',
            version: '5.0',
            businesses: businessList.map(b => ({
              business_info: b,
              data: loadFile(b.id)
            })).filter(b => b.data !== null)
          };
          const filename = `all-businesses-v5-${today()}.json`;
          download(JSON.stringify(allData, null, 2), filename);
          showToast(`Exported ${allData.businesses.length} business(es)`);
        };
        const importJsonBtn = $('#import-json-btn'); if (importJsonBtn) importJsonBtn.onclick = () => {
          if (!activeId && !businessList.length) {
            showModal(`
              <div class="stack">
                <h3>No Active Business</h3>
                <p>Please create or select a business before importing data.</p>
                <div class="row" style="justify-content:flex-end">
                  <button data-cancel class="primary">OK</button>
                </div>
              </div>
            `, () => {});
            return;
          }
          const importJson = $('#import-json'); if (importJson) importJson.click();
        };
        const importJson = $('#import-json'); if (importJson) importJson.onchange = (e) => {
          if (e.target.files && e.target.files[0]) {
            handleImport(e.target.files[0]);
            // Reset input so same file can be imported again if needed
            e.target.value = '';
          }
        };
        const resetAllData = $('#reset-all-data'); if (resetAllData) resetAllData.onclick = () => {
          showModal(`
            <div class="stack">
              <h3>Reset All Data</h3>
              <p><strong style="color:var(--danger)">WARNING: This will permanently delete ALL businesses and ALL data.</strong></p>
              <p>This includes:</p>
              <ul style="margin:10px 0; padding-left:20px">
                <li>All businesses</li>
                <li>All invoices</li>
                <li>All transactions</li>
                <li>All clients</li>
                <li>All services</li>
                <li>All settings</li>
                <li>Everything else</li>
              </ul>
              <p><strong>This action CANNOT be undone.</strong></p>
              <p>Make sure you have exported backups if you want to keep any data.</p>
              <div class="row" style="justify-content:flex-end; gap:8px">
                <button data-cancel>Cancel</button>
                <button data-confirm class="primary" style="background:var(--danger)">Reset All Data</button>
              </div>
            </div>
          `, () => {
            // Clear all localStorage items related to the app
            const keysToRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
              const key = localStorage.key(i);
              if (key && (key.startsWith('ck5_') || key.startsWith('checkmark_'))) {
                keysToRemove.push(key);
              }
            }
            keysToRemove.forEach(key => localStorage.removeItem(key));
            
            // Reset state
            businessList = [];
            activeId = null;
            file = null;
            
            // Reload
            loadList();
            loadActive();
            showToast('All data has been reset');
          });
        };
        const newBusiness = $('#new-business'); if (newBusiness) newBusiness.onclick = () => {
          showModal(`
            <div class="stack">
              <h3>Create New Business</h3>
              <label>Business Name</label>
              <input type="text" id="new-business-name-modal" placeholder="My Business" value="My Business" autofocus>
              <div class="row" style="justify-content:flex-end; gap:8px; margin-top:16px">
                <button data-cancel>Cancel</button>
                <button data-confirm class="primary">Create Business</button>
              </div>
            </div>
          `, () => {
            const nameInput = $('#new-business-name-modal');
            const name = nameInput?.value?.trim() || 'My Business';
            if (name) {
              createBusiness(name);
              closeModal();
            }
          });
          
          // Auto-focus and allow Enter key to submit
          setTimeout(() => {
            const nameInput = $('#new-business-name-modal');
            if (nameInput) {
              nameInput.focus();
              nameInput.select();
              nameInput.onkeydown = (e) => {
                if (e.key === 'Enter') {
                  const confirmBtn = $('#modal-body').querySelector('[data-confirm]');
                  if (confirmBtn) confirmBtn.click();
                }
              };
            }
          }, 100);
        };
        deleteBusinessBtn = $('#delete-business'); if (deleteBusinessBtn) deleteBusinessBtn.onclick = () => {
          if (!activeId) {
            showToast('No business selected');
            return;
          }
          deleteBusiness(activeId);
        };
        const businessSelector = $('#business-selector'); if (businessSelector) businessSelector.onchange = (e)=>{ activeId = e.target.value; saveActive(); loadActive(); };
        const openSettings = $('#open-settings'); if (openSettings) openSettings.onclick = ()=> setTab('settings');
        
        // Close side-panel when clicking outside of it (but not on calculator/notes or interactive elements)
        document.addEventListener('click', (e) => {
          const target = e.target;
          const sidePanel = $('#side-panel');
          const calculatorWindow = $('#calculator-window');
          const calculatorMinimized = $('#calculator-minimized');
          const noteWindow = $('#note-window');
          const noteMinimized = $('#note-minimized');
          
          // Always exclude calculator window and minimized calculator from closing logic
          if (calculatorWindow && !calculatorWindow.classList.contains('hidden') && calculatorWindow.contains(target)) {
            return;
          }
          if (calculatorMinimized && !calculatorMinimized.classList.contains('hidden') && calculatorMinimized.contains(target)) {
            return;
          }
          if (noteWindow && !noteWindow.classList.contains('hidden') && noteWindow.contains(target)) {
            return;
          }
          if (noteMinimized && !noteMinimized.classList.contains('hidden') && noteMinimized.contains(target)) {
            return;
          }
          
          // Don't close if clicking on interactive elements (buttons, links, inputs, etc.)
          // These elements might open windows, so let their handlers run without interference
          const isInteractive = target.tagName === 'BUTTON' || 
                                target.tagName === 'A' || 
                                target.tagName === 'INPUT' ||
                                target.tagName === 'SELECT' ||
                                target.tagName === 'TEXTAREA' ||
                                target.closest('button') || 
                                target.closest('a') ||
                                target.closest('input') ||
                                target.closest('select') ||
                                target.closest('textarea') ||
                                target.closest('[onclick]') ||
                                target.closest('.modal') ||
                                target.closest('#modal-overlay');
          
          if (isInteractive) {
            return; // Let interactive elements handle their own clicks
          }
          
          if (sidePanel && sidePanel.classList.contains('open')) {
            // Check if click is outside the side-panel
            if (!sidePanel.contains(target)) {
              // Close the panel
              closePanel();
            }
          }
        });
        
        // Close modal when clicking on overlay background (not on modal itself)
        const modalOverlay = $('#modal-overlay');
        if (modalOverlay) {
          modalOverlay.addEventListener('click', (e) => {
            // Only close if clicking directly on the overlay, not on the modal
            if (e.target === modalOverlay) {
              closeModal();
            }
          });
        }
        
        // #region agent log
        logDebug('bindUI:complete','bindUI completed successfully',{},'B');
        // #endregion
      } catch(e) {
        // #region agent log
        logDebug('bindUI:error','Error in bindUI',{error:e.message,stack:e.stack},'B');
        // #endregion
        console.error('bindUI error:', e);
        throw e;
      }
    };

    const readFileAsDataUrl = (file, cb) => {
      if (!file) return;
      const r = new FileReader();
      r.onload = ()=>cb(r.result);
      r.readAsDataURL(file);
    };

    const download = (data, filename, mime='application/json') => {
      const blob = new Blob([data], { type: mime });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; a.click();
      URL.revokeObjectURL(url);
    };

    // Remove ledger entries/lines whose linked transaction or payment no longer exists
    const cleanOrphanLedgerEntries = () => {
      const txIds = new Set(file.transactions.map(t=>t.transaction_id));
      const payIds = new Set(file.payments.map(p=>p.payment_id));
      const beforeEntries = file.ledger_entries.length;
      const beforeLines = file.ledger_lines.length;
      const keepEntry = (e) => {
        if (e.linked_transaction_id && !txIds.has(e.linked_transaction_id)) return false;
        if (e.linked_payment_id && !payIds.has(e.linked_payment_id)) return false;
        return true;
      };
      const keptIds = [];
      file.ledger_entries = file.ledger_entries.filter(e=>{
        const keep = keepEntry(e);
        if (keep) keptIds.push(e.ledger_entry_id);
        return keep;
      });
      file.ledger_lines = file.ledger_lines.filter(l=>keptIds.includes(l.ledger_entry_id));
      // #region agent log
      fetch('http://127.0.0.1:7242/ingest/251e5d6a-3d5b-41b3-b796-d6cf2eef1b0c',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'Checkmark Accountant V5.html:cleanOrphanLedgerEntries',message:'cleanOrphanLedgerEntries:result',data:{beforeEntries,afterEntries:file.ledger_entries.length,beforeLines,afterLines:file.ledger_lines.length},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'B'})}).catch(()=>{});
      // #endregion
      if (beforeEntries !== file.ledger_entries.length || beforeLines !== file.ledger_lines.length) saveFile();
    };

    const renderBusinessInfo = () => {
      const info = $('#business-info');
      if (!info) return;
      if (!file || !file.business) {
        info.innerHTML = '<div style="color:var(--muted)">No business selected. Create a new business to get started.</div>';
        if (deleteBusinessBtn) deleteBusinessBtn.style.display = 'none';
        return;
      }
      const business = file.business;
      info.innerHTML = `
        <div><strong>Name:</strong> ${business.name || ''}</div>
        <div><strong>Currency:</strong> ${business.base_currency || 'USD'}</div>
        <div><strong>Created:</strong> ${business.created_at ? new Date(business.created_at).toLocaleDateString() : ''}</div>
        <div><strong>Updated:</strong> ${business.updated_at ? new Date(business.updated_at).toLocaleDateString() : ''}</div>
      `;
      if (deleteBusinessBtn) {
        deleteBusinessBtn.style.display = activeId && businessList.length > 0 ? 'block' : 'none';
      }
    };

    // ---------- Notes ----------
    let noteState = {
      open: false,
      minimized: false,
      x: 140,
      y: 120,
      width: 420,
      height: 460,
      currentId: null
    };
    let noteDirty = false;
    let noteAutoSaveTimer = null;

    const loadNoteState = () => {
      const saved = localStorage.getItem('ck5_note_state');
      if (saved) {
        try {
          noteState = { ...noteState, ...JSON.parse(saved) };
        } catch (e) {}
      }
    };

    const saveNoteState = () => {
      localStorage.setItem('ck5_note_state', JSON.stringify(noteState));
    };

    const getNotes = () => file?.notes || [];

    const getNoteById = (id) => getNotes().find(n => n.id === id);

    const noteNeedsName = (note) => !note || !note.title || note.title === 'Untitled note';

    const updateNoteActions = () => {
      const hasNote = !!noteState.currentId;
      const saveBtn = $('#note-save');
      const deleteBtn = $('#note-delete');
      const copyBtn = $('#note-copy');
      const note = getNoteById(noteState.currentId);
      const needsName = noteNeedsName(note);
      if (saveBtn) saveBtn.disabled = !noteDirty && !needsName;
      if (deleteBtn) deleteBtn.disabled = !hasNote;
      if (copyBtn) copyBtn.disabled = !hasNote;
    };

    const setNoteDirty = (dirty) => {
      noteDirty = dirty;
      const saveBtn = $('#note-save');
      const note = getNoteById(noteState.currentId);
      const needsName = noteNeedsName(note);
      if (saveBtn) saveBtn.disabled = !dirty && !needsName;
      updateNoteActions();
    };

    const normalizeNoteTitle = (val) => (val || '').trim() || 'Untitled note';

    const loadNoteIntoEditor = (note) => {
      const contentInput = $('#note-content');
      if (contentInput) {
        const raw = note?.content || '';
        const isHtml = /<\/?[a-z][\s\S]*>/i.test(raw);
        contentInput.innerHTML = isHtml ? raw : raw.replace(/\n/g, '<br>');
      }
      setNoteDirty(false);
    };

    const renderNoteMenu = ({ preserveEditor = false } = {}) => {
      const menu = $('#note-menu');
      if (!menu) return;
      const notes = getNotes()
        .slice()
        .sort((a, b) => ((b.updated_at || b.created_at || '') > (a.updated_at || a.created_at || '')) ? 1 : -1);
      menu.innerHTML = '';
      if (!notes.length) {
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = 'No notes yet';
        menu.appendChild(opt);
        menu.disabled = true;
        noteState.currentId = null;
        loadNoteIntoEditor({ title: '', content: '' });
        updateNoteActions();
        return;
      }
      menu.disabled = false;
      notes.forEach(note => {
        const opt = document.createElement('option');
        opt.value = note.id;
        opt.textContent = note.title || 'Untitled note';
        menu.appendChild(opt);
      });
      const hasCurrent = noteState.currentId && notes.find(n => n.id === noteState.currentId);
      if (!hasCurrent) {
        noteState.currentId = notes[0].id;
      }
      menu.value = noteState.currentId;
      const selected = getNoteById(noteState.currentId);
      if (selected && (!preserveEditor || !hasCurrent)) loadNoteIntoEditor(selected);
      updateNoteActions();
    };

    const createNote = ({ silent = false } = {}) => {
      if (!file) return null;
      if (!file.notes) file.notes = [];
      const now = nowIso();
      const note = {
        id: uuid(),
        title: 'Untitled note',
        content: '',
        created_at: now,
        updated_at: now
      };
      file.notes.unshift(note);
      noteState.currentId = note.id;
      saveFile();
      renderNoteMenu();
      if (!silent) showToast('Note created');
      return note;
    };

    const createNoteFromEditor = ({ title, silent = false } = {}) => {
      if (!file) return null;
      if (!file.notes) file.notes = [];
      const contentInput = $('#note-content');
      const now = nowIso();
      const note = {
        id: uuid(),
        title: normalizeNoteTitle(title || ''),
        content: contentInput?.innerHTML || '',
        created_at: now,
        updated_at: now
      };
      file.notes.unshift(note);
      noteState.currentId = note.id;
      saveFile();
      renderNoteMenu({ preserveEditor: true });
      if (!silent) showToast('Note created');
      return note;
    };

    const saveCurrentNote = ({ silent = false, titleOverride } = {}) => {
      if (!file) return;
      const contentInput = $('#note-content');
      if (!contentInput) return;
      const title = normalizeNoteTitle(titleOverride);
      const content = contentInput.innerHTML || '';
      let note = noteState.currentId ? getNoteById(noteState.currentId) : null;
      if (!note) {
        note = createNoteFromEditor({ title, silent: true });
      }
      if (!note) return;
      if (titleOverride) note.title = title;
      note.content = content;
      note.updated_at = nowIso();
      saveFile();
      setNoteDirty(false);
      renderNoteMenu({ preserveEditor: true });
      if (!silent) showToast('Note saved');
    };

    const scheduleNoteAutosave = () => {
      if (!file) return;
      if (!noteState.currentId) {
        createNoteFromEditor({ title: 'Untitled note', silent: true });
      }
      setNoteDirty(true);
      clearTimeout(noteAutoSaveTimer);
      noteAutoSaveTimer = setTimeout(() => saveCurrentNote({ silent: true }), 700);
    };

    const noteContentToText = (html) => {
      const container = document.createElement('div');
      container.innerHTML = html || '';
      return container.innerText || '';
    };

    const promptNoteTitle = (defaultTitle, onConfirm) => {
      showModal(`
        <div class="stack">
          <h3>Name this note</h3>
          <input type="text" id="note-title-input" placeholder="Note name" value="${defaultTitle || ''}">
          <div class="row" style="justify-content:flex-end; gap:8px; margin-top:12px">
            <button data-cancel>Cancel</button>
            <button data-confirm class="primary">Save Note</button>
          </div>
        </div>
      `, () => {
        const input = $('#note-title-input');
        const title = normalizeNoteTitle(input?.value || '');
        onConfirm(title);
      });
      setTimeout(() => {
        const input = $('#note-title-input');
        if (input) {
          input.focus();
          input.select();
          input.onkeydown = (e) => {
            if (e.key === 'Enter') {
              const confirmBtn = $('#modal-body').querySelector('[data-confirm]');
              if (confirmBtn) confirmBtn.click();
            }
          };
        }
      }, 50);
    };

    const handleNoteSaveClick = () => {
      const note = getNoteById(noteState.currentId);
      if (noteNeedsName(note)) {
        promptNoteTitle('', (title) => saveCurrentNote({ titleOverride: title }));
        return;
      }
      saveCurrentNote();
    };

    const deleteCurrentNote = () => {
      const note = getNoteById(noteState.currentId);
      if (!note) return;
      showModal(`
        <div class="stack">
          <h3>Delete Note</h3>
          <p>This will permanently delete "${note.title || 'Untitled note'}".</p>
          <div class="row" style="justify-content:flex-end; gap:8px">
            <button data-cancel>Cancel</button>
            <button data-confirm class="primary" style="background:var(--danger)">Delete Note</button>
          </div>
        </div>
      `, () => {
        file.notes = file.notes.filter(n => n.id !== note.id);
        noteState.currentId = file.notes[0]?.id || null;
        saveFile();
        renderNoteMenu();
        showToast('Note deleted');
      });
    };

    const copyCurrentNote = async () => {
      const note = getNoteById(noteState.currentId);
      if (!note) return;
      const body = noteContentToText(note.content || '');
      const text = `${note.title ? note.title + '\n\n' : ''}${body}`.trim();
      if (!text) {
        showToast('Nothing to copy');
        return;
      }
      try {
        await navigator.clipboard.writeText(text);
        showToast('Copied note');
      } catch (e) {
        const temp = document.createElement('textarea');
        temp.value = text;
        temp.setAttribute('readonly', '');
        temp.style.position = 'absolute';
        temp.style.left = '-9999px';
        document.body.appendChild(temp);
        temp.select();
        document.execCommand('copy');
        document.body.removeChild(temp);
        showToast('Copied note');
      }
    };


    const renderNotes = () => {
      if (!file) return;
      if (!file.notes) file.notes = [];
      renderNoteMenu();
    };

    // ---------- Render all ----------
    const renderAll = () => {
      // #region agent log
      logDebug('renderAll:entry','renderAll called',{fileExists:!!file},'F');
      // #endregion
      if (!file) {
        // #region agent log
        logDebug('renderAll:early-return','No file object, returning early',{},'F');
        // #endregion
        return;
      }
      renderInvoices();
      renderInvoiceDraft();
      renderTransactions();
      renderTxnDraft();
      renderClients();
      renderProjects();
      renderServices();
      renderDashboard();
      renderNotes();
      const themeSelect = $('#theme-select');
      const splashVideoToggle = $('#splash-video-toggle');
      const logoVariant = $('#logo-variant');
      const defaultTaxPercent = $('#default-tax-percent');
      const grtPercent = $('#grt-percent');
      const grtBasis = $('#grt-basis');
      const grtFilingFrequency = $('#grt-filing-frequency');
      if (themeSelect) themeSelect.value = file.settings.theme;
      if (splashVideoToggle) splashVideoToggle.textContent = file.settings.show_splash_video !== false ? 'On' : 'Off';
      if (logoVariant) logoVariant.value = file.settings.logoVariant;
      if (defaultTaxPercent) defaultTaxPercent.value = file.settings.default_tax_percent ?? 0;
      if (grtPercent) grtPercent.value = file.settings.grt_percent ?? 0;
      if (grtBasis) grtBasis.value = file.settings.grt_basis || 'invoices';
      if (grtFilingFrequency) grtFilingFrequency.value = file.settings.grt_filing_frequency || 'monthly';
      updateHeaderImagePreview();
      renderBusinessInfo();
      renderMigrationBlock();
      runIntegrity();
      populateGRTYearSelect();
      // #region agent log
      logDebug('renderAll:complete','renderAll completed',{},'F');
      // #endregion
    };

    // ---------- Calculator ----------
    let calculatorState = {
      open: false,
      minimized: false,
      x: 100,
      y: 100,
      width: 320,
      height: 400
    };

    const loadCalculatorState = () => {
      const saved = localStorage.getItem('ck5_calculator_state');
      if (saved) {
        try {
          calculatorState = { ...calculatorState, ...JSON.parse(saved) };
        } catch (e) {}
      }
    };

    const saveCalculatorState = () => {
      localStorage.setItem('ck5_calculator_state', JSON.stringify(calculatorState));
    };

    let calculator = {
      display: '0',
      secondary: '',
      previousValue: null,
      operation: null,
      waitingForOperand: false
    };

    const updateCalculatorDisplay = () => {
      const primary = $('#calculator-primary');
      const secondary = $('#calculator-secondary');
      if (primary) primary.textContent = calculator.display;
      if (secondary) secondary.textContent = calculator.secondary;
    };

    const copyCalculatorValue = async () => {
      const text = String(calculator.display ?? '').trim();
      if (!text) return;
      try {
        await navigator.clipboard.writeText(text);
        showToast('Copied number');
      } catch (e) {
        const temp = document.createElement('textarea');
        temp.value = text;
        temp.setAttribute('readonly', '');
        temp.style.position = 'absolute';
        temp.style.left = '-9999px';
        document.body.appendChild(temp);
        temp.select();
        document.execCommand('copy');
        document.body.removeChild(temp);
        showToast('Copied number');
      }
    };

    const inputNumber = (num) => {
      if (calculator.waitingForOperand) {
        calculator.display = String(num);
        calculator.waitingForOperand = false;
      } else {
        calculator.display = calculator.display === '0' ? String(num) : calculator.display + num;
      }
      updateCalculatorDisplay();
    };

    const inputDecimal = () => {
      if (calculator.waitingForOperand) {
        calculator.display = '0.';
        calculator.waitingForOperand = false;
      } else if (calculator.display.indexOf('.') === -1) {
        calculator.display += '.';
      }
      updateCalculatorDisplay();
    };

    const performOperation = (nextOperation) => {
      const inputValue = parseFloat(calculator.display);

      if (calculator.previousValue === null) {
        calculator.previousValue = inputValue;
      } else if (calculator.operation) {
        const currentValue = calculator.previousValue || 0;
        const newValue = calculate(currentValue, inputValue, calculator.operation);

        calculator.display = String(newValue);
        calculator.previousValue = newValue;
        updateCalculatorDisplay();
      }

      calculator.waitingForOperand = true;
      calculator.operation = nextOperation;
      calculator.secondary = calculator.previousValue + ' ' + getOperationSymbol(nextOperation);
      updateCalculatorDisplay();
    };

    const calculate = (firstValue, secondValue, operation) => {
      if (operation === 'add') return firstValue + secondValue;
      if (operation === 'subtract') return firstValue - secondValue;
      if (operation === 'multiply') return firstValue * secondValue;
      if (operation === 'divide') {
        if (secondValue === 0) {
          return 'Error';
        }
        return firstValue / secondValue;
      }
      return secondValue;
    };

    const getOperationSymbol = (op) => {
      if (op === 'add') return '+';
      if (op === 'subtract') return '';
      if (op === 'multiply') return '';
      if (op === 'divide') return '';
      return '';
    };

    const handleEquals = () => {
      const inputValue = parseFloat(calculator.display);

      if (calculator.previousValue !== null && calculator.operation) {
        const newValue = calculate(calculator.previousValue, inputValue, calculator.operation);
        calculator.display = String(newValue);
        calculator.previousValue = null;
        calculator.operation = null;
        calculator.waitingForOperand = true;
        calculator.secondary = '';
        updateCalculatorDisplay();
      }
    };

    const clearAll = () => {
      calculator.display = '0';
      calculator.secondary = '';
      calculator.previousValue = null;
      calculator.operation = null;
      calculator.waitingForOperand = false;
      updateCalculatorDisplay();
    };

    const clearEntry = () => {
      calculator.display = '0';
      calculator.waitingForOperand = false;
      updateCalculatorDisplay();
    };

    const handlePercent = () => {
      const value = parseFloat(calculator.display);
      calculator.display = String(value / 100);
      calculator.waitingForOperand = true;
      updateCalculatorDisplay();
    };

    const initCalculator = () => {
      updateCalculatorDisplay();
      const copyBtn = $('#calculator-copy');
      if (copyBtn) {
        copyBtn.onclick = (e) => {
          e.stopPropagation();
          copyCalculatorValue();
        };
      }
      const buttons = $$('.calc-btn');
      buttons.forEach(btn => {
        btn.onclick = (e) => {
          e.stopPropagation();
          const value = btn.dataset.value;
          const action = btn.dataset.action;

          if (value !== undefined) {
            inputNumber(value);
          } else if (action === 'decimal') {
            inputDecimal();
          } else if (action === 'add' || action === 'subtract' || action === 'multiply' || action === 'divide') {
            performOperation(action);
          } else if (action === 'equals') {
            handleEquals();
          } else if (action === 'clear') {
            clearAll();
          } else if (action === 'clearEntry') {
            clearEntry();
          } else if (action === 'percent') {
            handlePercent();
          }
        };
      });
    };

    let isDragging = false;
    let dragOffset = { x: 0, y: 0 };
    let isResizing = false;
    let resizeStart = { x: 0, y: 0, width: 0, height: 0 };

    const startDrag = (e) => {
      if (e.target.closest('.calculator-controls')) return;
      if (e.target.closest('.calculator-buttons')) return;
      if (e.target.closest('.calculator-display')) return;
      isDragging = true;
      const rect = $('#calculator-window').getBoundingClientRect();
      dragOffset.x = e.clientX - rect.left;
      dragOffset.y = e.clientY - rect.top;
      e.preventDefault();
    };

    const onDrag = (e) => {
      if (!isDragging) return;
      const x = e.clientX - dragOffset.x;
      const y = e.clientY - dragOffset.y;
      const maxX = window.innerWidth - calculatorState.width;
      const maxY = window.innerHeight - calculatorState.height;
      calculatorState.x = Math.max(0, Math.min(x, maxX));
      calculatorState.y = Math.max(0, Math.min(y, maxY));
      updateCalculatorPosition();
    };

    const endDrag = () => {
      if (isDragging) {
        isDragging = false;
        saveCalculatorState();
      }
    };

    const startResize = (e) => {
      isResizing = true;
      const rect = $('#calculator-window').getBoundingClientRect();
      resizeStart.x = e.clientX;
      resizeStart.y = e.clientY;
      resizeStart.width = rect.width;
      resizeStart.height = rect.height;
      e.preventDefault();
      e.stopPropagation();
    };

    const onResize = (e) => {
      if (!isResizing) return;
      const deltaX = e.clientX - resizeStart.x;
      const deltaY = e.clientY - resizeStart.y;
      // Minimum size: just header + display (approximately 200px width, 180px height)
      const minWidth = 200;
      const minHeight = 180;
      calculatorState.width = Math.max(minWidth, resizeStart.width + deltaX);
      calculatorState.height = Math.max(minHeight, resizeStart.height + deltaY);
      updateCalculatorSize();
    };

    const endResize = () => {
      if (isResizing) {
        isResizing = false;
        saveCalculatorState();
      }
    };

    const updateCalculatorPosition = () => {
      const window = $('#calculator-window');
      if (window) {
        window.style.left = calculatorState.x + 'px';
        window.style.top = calculatorState.y + 'px';
      }
    };

    const updateCalculatorSize = () => {
      const window = $('#calculator-window');
      if (window) {
        window.style.width = calculatorState.width + 'px';
        window.style.height = calculatorState.height + 'px';
      }
    };

    const openCalculator = () => {
      calculatorState.open = true;
      calculatorState.minimized = false;
      $('#calculator-window').classList.remove('hidden');
      $('#calculator-minimized').classList.add('hidden');
      updateCalculatorPosition();
      updateCalculatorSize();
      saveCalculatorState();
    };

    const closeCalculator = () => {
      calculatorState.open = false;
      calculatorState.minimized = false;
      $('#calculator-window').classList.add('hidden');
      $('#calculator-minimized').classList.add('hidden');
      saveCalculatorState();
    };

    const minimizeCalculator = () => {
      calculatorState.minimized = true;
      calculatorState.open = true; // Keep open=true so toggle knows it's minimized but not closed
      $('#calculator-window').classList.add('hidden');
      const calcMinimized = $('#calculator-minimized');
      if (calcMinimized) {
        calcMinimized.classList.remove('hidden');
        // Re-attach handlers when element becomes visible to ensure they work
        calcMinimized.onclick = function(e) {
          e.stopPropagation();
          restoreCalculator();
        };
        const restoreBtn = calcMinimized.querySelector('#calculator-restore');
        if (restoreBtn) {
          restoreBtn.onclick = function(e) {
            e.stopPropagation();
            restoreCalculator();
          };
        }
      }
      saveCalculatorState();
    };

    const restoreCalculator = () => {
      calculatorState.minimized = false;
      calculatorState.open = true;
      const calcWindow = $('#calculator-window');
      const calcMinimized = $('#calculator-minimized');
      if (calcWindow) calcWindow.classList.remove('hidden');
      if (calcMinimized) calcMinimized.classList.add('hidden');
      updateCalculatorPosition();
      updateCalculatorSize();
      saveCalculatorState();
    };

    const toggleCalculator = () => {
      if (calculatorState.minimized) {
        restoreCalculator();
      } else if (calculatorState.open) {
        closeCalculator();
      } else {
        openCalculator();
      }
    };

    const initCalculatorWindow = () => {
      loadCalculatorState();
      initCalculator();
      updateCalculatorPosition();
      updateCalculatorSize();

      const header = $('#calculator-header');
      const resizeHandle = $('#calculator-resize');
      const minimizeBtn = $('#calculator-minimize');
      const closeBtn = $('#calculator-close');
      const restoreBtn = $('#calculator-restore');

      if (header) {
        header.addEventListener('mousedown', startDrag);
      }
      if (resizeHandle) {
        resizeHandle.addEventListener('mousedown', startResize);
      }
      if (minimizeBtn) {
        minimizeBtn.onclick = (e) => {
          e.stopPropagation();
          minimizeCalculator();
        };
      }
      if (closeBtn) {
        closeBtn.onclick = (e) => {
          e.stopPropagation();
          closeCalculator();
        };
      }
      // Make the entire minimized box clickable to restore calculator
      // Use event delegation on document with capture phase to ensure it runs first
      document.addEventListener('click', function(e) {
        const target = e.target;
        const calcMinimizedEl = $('#calculator-minimized');
        const isCalcRestoreBtn = target.id === 'calculator-restore';
        const isCalcMinimized = target.id === 'calculator-minimized';
        const isInsideCalcMinimized = calcMinimizedEl && calcMinimizedEl.contains(target);
        const isCalcRelated = isCalcRestoreBtn || isCalcMinimized || isInsideCalcMinimized;
        
        if (isCalcRelated && calcMinimizedEl && !calcMinimizedEl.classList.contains('hidden')) {
          e.stopPropagation();
          e.stopImmediatePropagation();
          restoreCalculator();
          return;
        }
      }, true); // Use capture phase to run before other handlers
      
      // Also add direct handlers as backup
      const calculatorMinimized = $('#calculator-minimized');
      if (calculatorMinimized) {
        calculatorMinimized.style.cursor = 'pointer';
        calculatorMinimized.onclick = function(e) {
          e.stopPropagation();
          restoreCalculator();
        };
        calculatorMinimized.addEventListener('click', function(e) {
          e.stopPropagation();
          restoreCalculator();
        });
      }
      
      if (restoreBtn) {
        restoreBtn.onclick = function(e) {
          e.stopPropagation();
          restoreCalculator();
        };
        restoreBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          restoreCalculator();
        });
      }

      document.addEventListener('mousemove', (e) => {
        onDrag(e);
        onResize(e);
      });
      document.addEventListener('mouseup', () => {
        endDrag();
        endResize();
      });

      if (calculatorState.open && !calculatorState.minimized) {
        openCalculator();
      } else if (calculatorState.minimized) {
        minimizeCalculator();
      }
    };

    // ---------- Notes Window ----------
    let isNoteDragging = false;
    let noteDragOffset = { x: 0, y: 0 };
    let isNoteResizing = false;
    let noteResizeStart = { x: 0, y: 0, width: 0, height: 0 };

    const startNoteDrag = (e) => {
      if (e.target.closest('.note-controls')) return;
      isNoteDragging = true;
      const rect = $('#note-window').getBoundingClientRect();
      noteDragOffset.x = e.clientX - rect.left;
      noteDragOffset.y = e.clientY - rect.top;
      e.preventDefault();
    };

    const onNoteDrag = (e) => {
      if (!isNoteDragging) return;
      const x = e.clientX - noteDragOffset.x;
      const y = e.clientY - noteDragOffset.y;
      const maxX = window.innerWidth - noteState.width;
      const maxY = window.innerHeight - noteState.height;
      noteState.x = Math.max(0, Math.min(x, maxX));
      noteState.y = Math.max(0, Math.min(y, maxY));
      updateNotePosition();
    };

    const endNoteDrag = () => {
      if (isNoteDragging) {
        isNoteDragging = false;
        saveNoteState();
      }
    };

    const startNoteResize = (e) => {
      isNoteResizing = true;
      const rect = $('#note-window').getBoundingClientRect();
      noteResizeStart.x = e.clientX;
      noteResizeStart.y = e.clientY;
      noteResizeStart.width = rect.width;
      noteResizeStart.height = rect.height;
      e.preventDefault();
      e.stopPropagation();
    };

    const onNoteResize = (e) => {
      if (!isNoteResizing) return;
      const deltaX = e.clientX - noteResizeStart.x;
      const deltaY = e.clientY - noteResizeStart.y;
      const minWidth = 280;
      const minHeight = 120;
      noteState.width = Math.max(minWidth, noteResizeStart.width + deltaX);
      noteState.height = Math.max(minHeight, noteResizeStart.height + deltaY);
      updateNoteSize();
    };

    const endNoteResize = () => {
      if (isNoteResizing) {
        isNoteResizing = false;
        saveNoteState();
      }
    };

    const updateNotePosition = () => {
      const window = $('#note-window');
      if (window) {
        window.style.left = noteState.x + 'px';
        window.style.top = noteState.y + 'px';
      }
    };

    const updateNoteSize = () => {
      const window = $('#note-window');
      if (window) {
        window.style.width = noteState.width + 'px';
        window.style.height = noteState.height + 'px';
      }
    };

    const openNote = () => {
      noteState.open = true;
      noteState.minimized = false;
      $('#note-window').classList.remove('hidden');
      $('#note-minimized').classList.add('hidden');
      updateNotePosition();
      updateNoteSize();
      renderNoteMenu();
      saveNoteState();
    };

    const closeNote = () => {
      noteState.open = false;
      noteState.minimized = false;
      $('#note-window').classList.add('hidden');
      $('#note-minimized').classList.add('hidden');
      saveNoteState();
    };

    const minimizeNote = () => {
      noteState.minimized = true;
      noteState.open = true;
      $('#note-window').classList.add('hidden');
      const minimized = $('#note-minimized');
      if (minimized) {
        minimized.classList.remove('hidden');
        minimized.onclick = function(e) {
          e.stopPropagation();
          restoreNote();
        };
        const restoreBtn = minimized.querySelector('#note-restore');
        if (restoreBtn) {
          restoreBtn.onclick = function(e) {
            e.stopPropagation();
            restoreNote();
          };
        }
      }
      saveNoteState();
    };

    const restoreNote = () => {
      noteState.minimized = false;
      noteState.open = true;
      const noteWindow = $('#note-window');
      const minimized = $('#note-minimized');
      if (noteWindow) noteWindow.classList.remove('hidden');
      if (minimized) minimized.classList.add('hidden');
      updateNotePosition();
      updateNoteSize();
      renderNoteMenu();
      saveNoteState();
    };

    const toggleNote = () => {
      if (noteState.minimized) {
        restoreNote();
      } else if (noteState.open) {
        closeNote();
      } else {
        openNote();
      }
    };

    const initNoteWindow = () => {
      loadNoteState();
      updateNotePosition();
      updateNoteSize();
      renderNoteMenu();

      const header = $('#note-header');
      const resizeHandle = $('#note-resize');
      const minimizeBtn = $('#note-minimize');
      const closeBtn = $('#note-close');
      const restoreBtn = $('#note-restore');
      const menu = $('#note-menu');
      const newBtn = $('#note-new');
      const saveBtn = $('#note-save');
      const deleteBtn = $('#note-delete');
      const copyBtn = $('#note-copy');
      const contentInput = $('#note-content');

      if (header) {
        header.addEventListener('mousedown', startNoteDrag);
      }
      if (resizeHandle) {
        resizeHandle.addEventListener('mousedown', startNoteResize);
      }
      if (minimizeBtn) {
        minimizeBtn.onclick = (e) => {
          e.stopPropagation();
          minimizeNote();
        };
      }
      if (closeBtn) {
        closeBtn.onclick = (e) => {
          e.stopPropagation();
          closeNote();
        };
      }
      if (restoreBtn) {
        restoreBtn.onclick = function(e) {
          e.stopPropagation();
          restoreNote();
        };
      }
      if (menu) {
        menu.onchange = (e) => {
          if (noteDirty) saveCurrentNote({ silent: true });
          noteState.currentId = e.target.value || null;
          const selected = getNoteById(noteState.currentId);
          if (selected) loadNoteIntoEditor(selected);
          updateNoteActions();
        };
      }
      if (newBtn) newBtn.onclick = () => {
        if (noteDirty) saveCurrentNote({ silent: true });
        createNote();
      };
      if (saveBtn) saveBtn.onclick = () => handleNoteSaveClick();
      if (deleteBtn) deleteBtn.onclick = () => deleteCurrentNote();
      if (copyBtn) copyBtn.onclick = () => copyCurrentNote();
      if (contentInput) contentInput.oninput = scheduleNoteAutosave;

      document.addEventListener('mousemove', (e) => {
        onNoteDrag(e);
        onNoteResize(e);
      });
      document.addEventListener('mouseup', () => {
        endNoteDrag();
        endNoteResize();
      });

      const noteMinimized = $('#note-minimized');
      if (noteMinimized) {
        noteMinimized.style.cursor = 'pointer';
        noteMinimized.onclick = function(e) {
          e.stopPropagation();
          restoreNote();
        };
        noteMinimized.addEventListener('click', function(e) {
          e.stopPropagation();
          restoreNote();
        });
      }

      if (noteState.open && !noteState.minimized) {
        openNote();
      } else if (noteState.minimized) {
        minimizeNote();
      }
    };

    // ---------- Init ----------
    const initApp = () => {
      // #region agent log
      logDebug('initApp:entry','initApp called - app initialization started',{},'A');
      // #endregion
      try {
        syncStickyOffsets();
        window.addEventListener('resize', syncStickyOffsets);
        bindUI();
        // #region agent log
        logDebug('initApp:after-bindUI','bindUI completed',{},'A');
        // #endregion
        initCalculatorWindow();
        initNoteWindow();
        loadList();
        // #region agent log
        logDebug('initApp:after-loadList','loadList completed',{businessListLength:businessList.length,activeId},'A');
        // #endregion
        if (!businessList.length && detectV4()) {
          renderMigrationBlock();
          setTab('settings');
        } else {
          loadActive(); // This will prompt to create a business if none exists
        }
        if (file?.settings?.show_splash_video !== false) {
          showSplashVideo();
        }
        // #region agent log
        logDebug('initApp:complete','initApp completed successfully',{},'A');
        // #endregion
      } catch(e) {
        // #region agent log
        logDebug('initApp:error','Error in initApp',{error:e.message,stack:e.stack},'A');
        // #endregion
        console.error('Init error:', e);
        throw e;
      }
    };

    // #region agent log
    logDebug('script:load','Script loaded, waiting for DOMContentLoaded',{readyState:document.readyState},'A');
    // #endregion
    window.addEventListener('error', (e) => {
      // #region agent log
      logDebug('window:error','Unhandled JavaScript error',{message:e.message,filename:e.filename,lineno:e.lineno,colno:e.colno,error:e.error?.stack},'A');
      // #endregion
    });
    window.addEventListener('unhandledrejection', (e) => {
      // #region agent log
      logDebug('window:unhandledrejection','Unhandled promise rejection',{reason:e.reason},'A');
      // #endregion
    });
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        // #region agent log
        logDebug('DOMContentLoaded:fired','DOMContentLoaded event fired',{},'A');
        // #endregion
        initApp();
      });
    } else {
      // #region agent log
      logDebug('DOMContentLoaded:already-ready','DOM already ready, calling initApp immediately',{},'A');
      // #endregion
      initApp();
    }
  </script>
</body>
</html>
